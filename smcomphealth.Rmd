---
title: "Does comprehensive education reduce health inequalities?"
site: bookdown::bookdown_site
output: bookdown::word_document2
bibliography: [ref.bib]
csl: social-science-and-medicine.csl
link-citations: yes
version: 1
---

```{r setup, include=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE, include=FALSE, cache=FALSE)

library("tidyverse")
library("haven")
library("broom")
library("knitr")
library("flextable")
library("WeightIt")
library("osfr")
library("mice")
library("bookdown")

options(scipen=999)

```

*Authors:*

Frank Popham (corresponding author) f.popham\@ed.ac.uk

Cristina Iannelli: c.lannelli\@ed.ac.uk

Moray House School of Education and Sport,\
The University of Edinburgh,\
Holyrood Campus, Edinburgh, UK, EH8 8AQ

*Funding:* Economic and Social Research Council (ESRC Grant Reference ES/P009301/1). The funder had no role in the study, the writing of the article, or the decision to submit it for publication.

*CRediT author statement:*

**FP** Conceptualization, Methodology, Validation, Formal Analysis, Writing.

**CI** Conceptualization, Methodology, Writing, Supervision, Funding acquisition.

*Conflicts of interest:* None

*Code and data availability:* 

Code to replicate the analysis and the paper is available at <https://github.com/frankpopham/comprehensive>. The data itself is available to researchers from the UK data archive; we are not permitted to directly share the data but details of datasets used are in the code.

*Keywords:* Health inequality, Education policy, Streaming, Comprehensive schooling

\newpage

### Abstract  {#Abstract .unnumbered}

(300 words max, 259)

Countries vary in the way in which they organize their secondary school system and allocate students within it. Some countries have strong differentiations between schools and curricula while others have adopted comprehensive systems in which students, irrespective of their ability and previous school performance, are taught in the same type of school.  Equalizing educational opportunities is an argument for a comprehensive school system. Given that education is an important social determinant of health, it is hypothesised that a more equitable comprehensive system could reduce health inequalities in adulthood. To test this hypothesis, we exploited the change from a largely selective to a largely comprehensive system that occurred in the UK from the mid-1960s onwards and compare pupils in the same birth cohorts (one born in 1958 and one in 1970) who attended either system. We studied physical and mental health, health behaviours and life satisfaction in middle age as outcomes. Inverse probability weighting was used to control confounding by socio-economic and education background, and ability test score taken prior to secondary school entry. Multiple imputation and inverse probability weighting were used to adjust for missing data and attrition, respectively. We studied relative and absolute health inequalities using the concentration index with social class and achieved education as our measures of social-economic stratification. We did not find consistent evidence that health inequalities were smaller under the comprehensive compared to the selective system and results were not substantially different in sensitivity analysis. Our study adds to the sparse but growing literature that assesses the impact of social policy on health inequalities.

\newpage


```{r packages}
# automatically create a bib database for R packages
write_bib(c(
  .packages(), "bookdown", "knitr", "rmarkdown", "tidyverse", "broom", "mice", "flextable"
), "packages.bib")
```


```{r functions, eval=TRUE}

# These are functions for this paper ####


frankcrosstab  <- function(rowvar, colvar, df, ...) {
  {{df}} %>%
  group_by({{rowvar}}, {{colvar}}) %>%
  summarise(n=n()) %>%
  pivot_wider(names_from={{colvar}}, values_from=n) %>%
  rowwise() %>%
  mutate(Rowsum = sum(c_across(where(is.numeric)), na.rm = TRUE))
  }


frankrecodeeducation2 <- function(df, oldvar, edflag, newname) {
{{df}}  %>%
  mutate(newvar = fct_expand({{oldvar}}, "None")) %>%
  mutate(newvar  = replace(newvar, is.na(newvar) & {{edflag}} == "Education information collected" , "None")) %>%
  mutate("{{newname}}" := newvar) %>%
  select(-newvar) %>%
   mutate("{{newname}}" := fct_drop({{newname}}))  
}

frankrecodeeducation <- function(df, oldvar, edflag, newname) {
{{df}}  %>%
  mutate(newvar = {{oldvar}}) %>%
  mutate(newvar  = replace(newvar, is.na(newvar) & {{edflag}} == "Education information collected" , "No qualifications")) %>%
  mutate("{{newname}}" := newvar) %>%
  select(-newvar) %>%
    mutate("{{newname}}" := fct_drop({{newname}}))
}

frankhighestqualtoage  <- function(longdf, oldvar, newvar, age, id) {
  {{longdf}}  %>%
  filter(age<={{age}}) %>%
  group_by({{id}}) %>%
  filter(max(count)==count) %>%
  ungroup() %>%
  select({{id}},  "{{newvar}}" := {{oldvar}})
}



##https://www.joyce-robbins.com/blog/2016/06/02/datavis-with-rdrawing-a-cleveland-dot-plot-with-ggplot2/

theme_dotplot <- theme_bw(14) +
    theme(axis.text.y = element_text(size = rel(.75)),
    	axis.ticks.y = element_blank(),
        axis.title.x = element_text(size = rel(.75)),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(size = 0.5),
        panel.grid.minor.x = element_blank(),
    	  legend.title = element_text(size = rel(.6)),
    	  legend.text = element_text(size = rel(.6)),
    	  legend.position="top")



tabfig1 <- function(system58, system70) {
  filelist <- list.files(pattern="^impdf1958_")
  temp_table1_1958 <- map_dfr(filelist, ~readRDS(.x) %>%
       tableone(., {{system58}}, year=1958), .id="file") 

table1_1958 <- polish_table(temp_table1_1958, "1958")

fig1_1958 <- figureone(temp_table1_1958)


var1_1958 <- map_dfr(filelist, ~readRDS(.x) %>%
       varone(., {{system58}}, cog11), .id="file") %>%
  filter(grp=="afdiff" | grp== "b4diff") %>%
  select(-n, -var) %>%
  group_by(grp) %>%
  summarise(across(-file, mean))

fig1_1958 <- fig1_1958 %>% 
  mutate(afdiff=case_when(variable=="Cognitive ability" ~ var1_1958$pc[1]*100,
                          TRUE ~ afdiff),
         b4diff=case_when(variable=="Cognitive ability" ~ var1_1958$pc[2]*100,
                          TRUE ~ b4diff))


filelist <- list.files(pattern="^impdf1970_")
temp_table1_1970 <- map_dfr(filelist, ~readRDS(.x) %>%
                              tableone(., {{system70}} , year=1970), .id="file") 

table1_1970 <- polish_table(temp_table1_1970, "1970")

fig1_1970 <- figureone(temp_table1_1970)


var1_1970 <- map_dfr(filelist, ~readRDS(.x) %>%
                       varone(., {{system70}}, cog10), .id="file") %>%
  filter(grp=="afdiff" | grp== "b4diff") %>%
  select(-n, -var) %>%
  group_by(grp) %>%
  summarise(across(-file, mean))

fig1_1970 <- fig1_1970 %>% 
  mutate(afdiff=case_when(variable=="Cognitive ability" ~ var1_1970$pc[1]*100,
                          TRUE ~ afdiff),
         b4diff=case_when(variable=="Cognitive ability" ~ var1_1970$pc[2]*100,
                          TRUE ~ b4diff))

return(list("table1_1958"=table1_1958, "table1_1970"=table1_1970, 
            "figure1_1958"=fig1_1958, "figure1_1970"=fig1_1970))
}   


getoutcomesED <- function(misswt2=TRUE) {
  
  filelist <- list.files(pattern="^impdf1958_")
  outlist <- genoutlist("impdf1958_50.RDS")

# by education as stratification ####

#add class as outcome 
 
walk(filelist, ~readRDS(.x) %>%
      codeoutcomesED(.) %>%
      saveRDS(., .x))
  
outlist <- outlistED(outlist)

filelist2<- rep(filelist, each=14)
outlist2 <- rep(outlist, times=68)

#create outcome dataset sets 

if(misswt2==TRUE) {walk2(filelist2, outlist2, ~readRDS(.x) %>%
       outcomesdataset(., rev_high38num, all_of(.y), system16, 
                                ipw, misswt=TRUE, year=1958) %>%
       saveRDS(., file=paste0(.y, "_", .x)))
}
if(misswt2==FALSE) {walk2(filelist2, outlist2, ~readRDS(.x) %>%
       outcomesdataset(., rev_high38num, all_of(.y), system16, 
                                ipw, misswt=FALSE, year=1958) %>%
       saveRDS(., file=paste0(.y, "_", .x)))
}

#get all the outcomes

outcomes1958high38 <- outlist %>% 
  map(~outcomes(.x))

#tidy 
  
file.remove(list.files(pattern = "^attain"))
file.remove(list.files(pattern = "^short"))

#edleftage

if(misswt2==TRUE) { walk2(filelist2, outlist2, ~readRDS(.x) %>%
       outcomesdataset(., rev_leftedage, all_of(.y), system16, 
                                ipw, misswt=TRUE, year=1958) %>%
       saveRDS(., file=paste0(.y, "_", .x)))
}
if(misswt2==FALSE) { walk2(filelist2, outlist2, ~readRDS(.x) %>%
       outcomesdataset(., rev_leftedage, all_of(.y), system16, 
                                ipw, misswt=FALSE, year=1958) %>%
       saveRDS(., file=paste0(.y, "_", .x)))
}

outcomes1958leftedage <- outlist %>% 
  map(~outcomes(.x))

file.remove(list.files(pattern = "^attain"))
file.remove(list.files(pattern = "^short"))

# to df

outcomes1958high38 <- outcometodf(outcomes1958high38)
outcomes1958leftedage <- outcometodf(outcomes1958leftedage)

gooutcomes1958high38 <- prepout(outcomes1958high38)
gooutcomes1958leftedage <- prepout(outcomes1958leftedage)

filelist <- list.files(pattern="^impdf1970_")
outlist <- genoutlist("impdf1970_50.RDS")

# by education as stratification ####

#add class as outcome 

walk(filelist, ~readRDS(.x) %>%
       codeoutcomesED(.) %>%
       saveRDS(., .x))

outlist <- outlistED(outlist)

filelist2<- rep(filelist, each=14)
outlist2 <- rep(outlist, times=72)

#create outcome dataset sets 

if(misswt2==TRUE) {walk2(filelist2, outlist2, ~readRDS(.x) %>%
                           outcomesdataset(., rev_high38num, all_of(.y), system16, 
                                           ipw, misswt=TRUE, year=1970) %>%
                           saveRDS(., file=paste0(.y, "_", .x)))
}
if(misswt2==FALSE) {walk2(filelist2, outlist2, ~readRDS(.x) %>%
                            outcomesdataset(., rev_high38num, all_of(.y), system16, 
                                            ipw, misswt=FALSE, year=1970) %>%
                            saveRDS(., file=paste0(.y, "_", .x)))
}

#get all the outcomes

outcomes1970high38 <- outlist %>% 
  map(~outcomes(.x))

#tidy 

file.remove(list.files(pattern = "^attain"))
file.remove(list.files(pattern = "^short"))

#edleftage

if(misswt2==TRUE) { walk2(filelist2, outlist2, ~readRDS(.x) %>%
                            outcomesdataset(., rev_leftedage, all_of(.y), system16, 
                                            ipw, misswt=TRUE, year=1970) %>%
                            saveRDS(., file=paste0(.y, "_", .x)))
}
if(misswt2==FALSE) { walk2(filelist2, outlist2, ~readRDS(.x) %>%
                             outcomesdataset(., rev_leftedage, all_of(.y), system16, 
                                             ipw, misswt=FALSE, year=1970) %>%
                             saveRDS(., file=paste0(.y, "_", .x)))
}

outcomes1970leftedage <- outlist %>% 
  map(~outcomes(.x))

file.remove(list.files(pattern = "^attain"))
file.remove(list.files(pattern = "^short"))

# to df

outcomes1970high38 <- outcometodf(outcomes1970high38)
outcomes1970leftedage <- outcometodf(outcomes1970leftedage)

gooutcomes1970high38 <- prepout(outcomes1970high38)
gooutcomes1970leftedage <- prepout(outcomes1970leftedage)

return(list("high38_58"=outcomes1958high38, "leftedage_58" = outcomes1958leftedage, 
            "high38_70" = outcomes1970high38, "leftedage_70" = outcomes1970leftedage,
            "go_high38_58"=gooutcomes1958high38, "go_leftedage_58" = gooutcomes1958leftedage,
          "go_high38_70" = gooutcomes1970high38, "go_leftedage_70" = gooutcomes1970leftedage))
}


getoutcomes <- function(misswt2=TRUE, system58, system70) {


filelist <- list.files(pattern="^impdf1958_")


outlist <- genoutlist("impdf1958_50.RDS")

#combine file and out list 68 imps for 1958 and 72 for 1970

filelist2<- rep(filelist, each=16)
outlist2 <- rep(outlist, times=68)

#create outcome dataset sets 

if(misswt2==TRUE) {walk2(filelist2, outlist2, ~readRDS(.x) %>%
       outcomesdataset(., class11, all_of(.y), {{system58}}, 
                                ipw, misswt=TRUE, year=1958) %>%
       saveRDS(., file=paste0(.y, "_", .x)))
}
if(misswt2==FALSE) {walk2(filelist2, outlist2, ~readRDS(.x) %>%
       outcomesdataset(., class11, all_of(.y), {{system58}}, 
                                ipw, misswt=FALSE, year=1958) %>%
       saveRDS(., file=paste0(.y, "_", .x)))
}

#get all the outcomes

outcomes1958class11 <- outlist %>% 
  map(~outcomes(.x))

#tidy 
  
file.remove(list.files(pattern = "^attain"))
file.remove(list.files(pattern = "^short"))

#class42

if(misswt2==TRUE) {walk2(filelist2, outlist2, ~readRDS(.x) %>%
       outcomesdataset(., class42, all_of(.y), {{system58}}, 
                                ipw, misswt=TRUE, year=1958) %>%
       saveRDS(., file=paste0(.y, "_", .x)))
}
if(misswt2==FALSE) {walk2(filelist2, outlist2, ~readRDS(.x) %>%
       outcomesdataset(., class42, all_of(.y), {{system58}}, 
                                ipw, misswt=FALSE, year=1958) %>%
       saveRDS(., file=paste0(.y, "_", .x)))
}

outcomes1958class42 <- outlist %>% 
  map(~outcomes(.x))

file.remove(list.files(pattern = "^attain"))
file.remove(list.files(pattern = "^short"))

#outcomes to data frame 
outcomes1958class11 <-outcometodf(outcomes1958class11)
outcomes1958class42 <-outcometodf(outcomes1958class42)

gooutcomes1958class11 <- prepout(outcomes1958class11)
gooutcomes1958class42 <- prepout(outcomes1958class42)

filelist <- list.files(pattern="^impdf1970_")


outlist <- genoutlist("impdf1970_50.RDS")

#combine file and out list 68 imps for 1970 and 72 for 1970

filelist2<- rep(filelist, each=16)
outlist2 <- rep(outlist, times=72)

#create outcome dataset sets 

if(misswt2==TRUE) {walk2(filelist2, outlist2, ~readRDS(.x) %>%
                           outcomesdataset(., class10, all_of(.y), {{system70}}, 
                                           ipw, misswt=TRUE, year=1970) %>%
                           saveRDS(., file=paste0(.y, "_", .x)))
}
if(misswt2==FALSE) {walk2(filelist2, outlist2, ~readRDS(.x) %>%
                            outcomesdataset(., class10, all_of(.y), {{system70}}, 
                                            ipw, misswt=FALSE, year=1970) %>%
                            saveRDS(., file=paste0(.y, "_", .x)))
}

#get all the outcomes

outcomes1970class10 <- outlist %>% 
  map(~outcomes(.x))

#tidy 

file.remove(list.files(pattern = "^attain"))
file.remove(list.files(pattern = "^short"))

#class42

if(misswt2==TRUE) {walk2(filelist2, outlist2, ~readRDS(.x) %>%
                           outcomesdataset(., class42, all_of(.y), {{system70}}, 
                                           ipw, misswt=TRUE, year=1970) %>%
                           saveRDS(., file=paste0(.y, "_", .x)))
}
if(misswt2==FALSE) {walk2(filelist2, outlist2, ~readRDS(.x) %>%
                            outcomesdataset(., class42, all_of(.y), {{system70}}, 
                                            ipw, misswt=FALSE, year=1970) %>%
                            saveRDS(., file=paste0(.y, "_", .x)))
}

outcomes1970class42 <- outlist %>% 
  map(~outcomes(.x))

file.remove(list.files(pattern = "^attain"))
file.remove(list.files(pattern = "^short"))

#outcomes to data frame 
outcomes1970class10 <-outcometodf(outcomes1970class10)
outcomes1970class42 <-outcometodf(outcomes1970class42)

gooutcomes1970class10 <- prepout(outcomes1970class10)
gooutcomes1970class42 <- prepout(outcomes1970class42)

return(list("class11_1958" = outcomes1958class11, "class42_1958" = outcomes1958class42, "go_class11_1958" = gooutcomes1958class11, "go_class42_1958" = gooutcomes1958class42, "class10_1970" = outcomes1970class10, "class42_1970" = outcomes1970class42, 
  "go_class10_1970" =gooutcomes1970class10, "go_class42_1970"=gooutcomes1970class42))
}




prepfiles <- function(model, system58, system70, impexp=TRUE) {

#1958
#read in imputed


impdf1958 <- readRDS("impdf1958.rds") 

#bring back original outcomes

if(impexp==TRUE) {longimpdf1958 <- bringbackorg(impdf1958, year="1958")
bmi11df1958 <- readRDS("df1958b4imp.rds") %>%
  select(bmi11)
bmi11df1958 <-  rep(bmi11df1958$bmi11, times=68)
longimpdf1958 <- longimpdf1958 %>%
  mutate(bmi11=bmi11df1958)

}
if(impexp==FALSE) {longimpdf1958 <- bringbackorg2(impdf1958, year="1958", 
                                                  system58 = {{system58}},
                                                  system70 = {{system70}})
}




#drop others from system 

longimpdf1958 <- dropsysother(longimpdf1958, {{ system58 }}) 




#split files by imputation and save (provide string for start of file name)


splitsave(longimpdf1958, "impdf1958_")

#tidy

remove(impdf1958, longimpdf1958)

#supermodel each file and save with returned ipw

filelist <- list.files(pattern="^impdf1958_")

if(model=="supermodel") {walk(filelist, ~readRDS(.x) %>%
      supermodel(., {{system58}}, year="1958") %>%
      saveRDS(., .x))
}

if(model=="ebalmodel") {walk(filelist, ~readRDS(.x) %>%
      ebalmodel(., {{system58}}, year="1958") %>%
      saveRDS(., .x))
} 

if(model=="gbmmodel") {walk(filelist, ~readRDS(.x) %>%
      gbmmodel(., {{system58}}, year="1958") %>%
      saveRDS(., .x))
} 




#code up the outcomes 

walk(filelist, ~readRDS(.x) %>%
      codeoutcomes(., year="1958") %>%
      saveRDS(., .x))

##1970  
  
impdf1970 <- readRDS("impdf1970.rds")

#bring back original outcomes

if(impexp==TRUE) {longimpdf1970 <- bringbackorg(impdf1970, year="1970")
bmi10df1970 <- readRDS("df1970b4imp.rds") %>%
  select(bmi10)
bmi10df1970 <-  rep(bmi10df1970$bmi10, times=72)
longimpdf1970 <- longimpdf1970 %>%
  mutate(bmi10=bmi10df1970)
}
if(impexp==FALSE) {longimpdf1970 <- bringbackorg2(impdf1970, year="1970", 
                                                  system58 = {{system58}},
                                                  system70 = {{system70}})
}




#drop others from system 

longimpdf1970 <- dropsysother(longimpdf1970, {{ system70 }}) 

#split files by imputation and save (provide string for start of file name)


splitsave(longimpdf1970, "impdf1970_")

#tidy

remove(impdf1970, longimpdf1970)

#supermodel each file and save with returned ipw

filelist <- list.files(pattern="^impdf1970_")

if(model=="supermodel") {walk(filelist, ~readRDS(.x) %>%
                                supermodel(., {{system70}}, year="1970") %>%
                                saveRDS(., .x))
}

if(model=="ebalmodel") {walk(filelist, ~readRDS(.x) %>%
                               ebalmodel(., {{system70}}, year="1970") %>%
                               saveRDS(., .x))

}

if(model=="gbmmodel") {walk(filelist, ~readRDS(.x) %>%
                               gbmmodel(., {{system70}}, year="1970") %>%
                               saveRDS(., .x))

}

#code up the outcomes 

walk(filelist, ~readRDS(.x) %>%
      codeoutcomes(., year="1970") %>%
      saveRDS(., .x))

}

prepfiles11 <- function(model, system58=system11, system70, impexp=TRUE) {

#1958
#read in imputed


impdf1958 <- readRDS("s11impdf1958.rds") 

#bring back original outcomes

if(impexp==TRUE) {longimpdf1958 <- bringbackorg(impdf1958, year="1958")
bmi11df1958 <- readRDS("df1958b4imp.rds") %>%
  select(bmi11)
bmi11df1958 <-  rep(bmi11df1958$bmi11, times=68)
longimpdf1958 <- longimpdf1958 %>%
  mutate(bmi11=bmi11df1958)

}
if(impexp==FALSE) {longimpdf1958 <- bringbackorg2(impdf1958, year="1958", 
                                                  system58 = {{system58}},
                                                  system70 = {{system70}})
}




#drop others from system 

longimpdf1958 <- dropsysother(longimpdf1958, {{ system58 }}) 




#split files by imputation and save (provide string for start of file name)


splitsave(longimpdf1958, "impdf1958_")

#tidy

remove(impdf1958, longimpdf1958)

#supermodel each file and save with returned ipw

filelist <- list.files(pattern="^impdf1958_")

if(model=="supermodel") {walk(filelist, ~readRDS(.x) %>%
      supermodel(., {{system58}}, year="1958") %>%
      saveRDS(., .x))
}

if(model=="ebalmodel") {walk(filelist, ~readRDS(.x) %>%
      ebalmodel(., {{system58}}, year="1958") %>%
      saveRDS(., .x))
}  
if(model=="gbmmodel") {walk(filelist, ~readRDS(.x) %>%
      gbmmodel(., {{system58}}, year="1958") %>%
      saveRDS(., .x))
} 
#code up the outcomes 

walk(filelist, ~readRDS(.x) %>%
      codeoutcomes(., year="1958") %>%
      saveRDS(., .x))

##1970  
  
impdf1970 <- readRDS("impdf1970.rds")

#bring back original outcomes

if(impexp==TRUE) {longimpdf1970 <- bringbackorg(impdf1970, year="1970")
bmi10df1970 <- readRDS("df1970b4imp.rds") %>%
  select(bmi10)
bmi10df1970 <-  rep(bmi10df1970$bmi10, times=72)
longimpdf1970 <- longimpdf1970 %>%
  mutate(bmi10=bmi10df1970)
}
if(impexp==FALSE) {longimpdf1970 <- bringbackorg2(impdf1970, year="1970", 
                                                  system58 = {{system58}},
                                                  system70 = {{system70}})
}




#drop others from system 

longimpdf1970 <- dropsysother(longimpdf1970, {{ system70 }}) 

#split files by imputation and save (provide string for start of file name)


splitsave(longimpdf1970, "impdf1970_")

#tidy

remove(impdf1970, longimpdf1970)

#supermodel each file and save with returned ipw

filelist <- list.files(pattern="^impdf1970_")

if(model=="supermodel") {walk(filelist, ~readRDS(.x) %>%
                                supermodel(., {{system70}}, year="1970") %>%
                                saveRDS(., .x))
}

if(model=="ebalmodel") {walk(filelist, ~readRDS(.x) %>%
                               ebalmodel(., {{system70}}, year="1970") %>%
                               saveRDS(., .x))

}
if(model=="gbmmodel") {walk(filelist, ~readRDS(.x) %>%
                               gbmmodel(., {{system70}}, year="1970") %>%
                               saveRDS(., .x))
}
#code up the outcomes 

walk(filelist, ~readRDS(.x) %>%
      codeoutcomes(., year="1970") %>%
      saveRDS(., .x))

}





# functions

genoutlist <- function(df) {
dfi <- readRDS(df)
outlist<- tibble(colnames(select(dfi, (c(starts_with("attain"),
                                               starts_with("short")
                                               ))))) %>%
pull(.)
names(outlist)  <- outlist
return(outlist)
}


splitsave <- function(df, str) {
  df %>%
  group_by(.imp) %>%
  group_walk(~saveRDS(.x, file=paste0(str, .y$.imp, ".RDS")))
}  

bringbackorg <- function(df, year) {
if(year=="1958") { 
longimpdf <- complete(df, action="long") %>%
  select(-c(cog7a, cog7b, cog7c, cog7d, region0, region1, rgsc0, rgsc7, 
            ghealth42, lifesatfuture42, lifesatnow42, wemwbs50,bmi42,
            class42, smoke42, bmi42, high38, leftedage)) 

temp <- complete(df, action="long", include=TRUE) %>%
  filter(.imp==0) %>%
  select(c(ghealth42, lifesatfuture42, lifesatnow42, wemwbs50,bmi42, 
           class42, smoke42, bmi42, high38, leftedage, .id))

longimpdf<-left_join(longimpdf, temp, by=".id") 

}
if(year=="1970") {
  longimpdf <- complete(df, action="long") %>%
  select(-c(cog5a, cog5b, cog5c, cog5d, region1, region2, rgsc0, rgsc5, 
            ghealth42, lifesatfuture42, lifesatnow42, wemwbs42, bmi42,
            class42, smoke42, bmi42, high38, leftedage)) 

temp <- complete(df, action="long", include=TRUE) %>%
  filter(.imp==0) %>%
  select(c(ghealth42, lifesatfuture42, lifesatnow42, wemwbs42, bmi42, 
           class42, smoke42, bmi42, high38, leftedage, .id)) 

longimpdf <- left_join(longimpdf, temp, by=".id")  
}
return(longimpdf)
  }  

bringbackorg2 <- function(df, year, system58, system70) {
if(year=="1958") { 
longimpdf <- complete(df, action="long") %>%
  select(-c(cog7a, cog7b, cog7c, cog7d, region0, region1, rgsc0, rgsc7, 
            ghealth42, lifesatfuture42, lifesatnow42, wemwbs50,bmi42,
            class42, smoke42, bmi42, high38, leftedage, {{system58}})) 

temp <- complete(df, action="long", include=TRUE) %>%
  filter(.imp==0) %>%
  select(c(ghealth42, lifesatfuture42, lifesatnow42, wemwbs50,bmi42, 
           class42, smoke42, bmi42, high38, leftedage, {{system58}}, .id))

longimpdf<-left_join(longimpdf, temp, by=".id") 

}
if(year=="1970") {
  longimpdf <- complete(df, action="long") %>%
  select(-c(cog5a, cog5b, cog5c, cog5d, region1, region2, rgsc0, rgsc5, 
            ghealth42, lifesatfuture42, lifesatnow42, wemwbs42, bmi42,
            class42, smoke42, bmi42, high38, leftedage, {{system70}})) 

temp <- complete(df, action="long", include=TRUE) %>%
  filter(.imp==0) %>%
  select(c(ghealth42, lifesatfuture42, lifesatnow42, wemwbs42, bmi42, 
           class42, smoke42, bmi42, high38, leftedage, {{system70}}, .id)) 

longimpdf <- left_join(longimpdf, temp, by=".id")  
}
return(longimpdf)
  }  











dropsysother <- function(df, system) {
  system <- enquo(system)
  df %>%
    filter(!!system !="Other") %>%
    mutate(!!system:=fct_drop(!!system))
}

# functions for ipw weights  

supermodel <- function(df, system, year) {
 if(year=="1958") { wit <- df %>%
        mutate(.system = {{system}}) %>%
        weightit(.system ~ leaschool7 + cog11 + I(cog11^2) + region2 + sex +
                           hilefted + class11 +parint7  + ethnic42 +
                            hopeleaveage11 + hopepostschool11,
         estimand = "ATE", method = "super", 
         data=.,
         stabilize = "FALSE",
         SL.library = c("SL.glm", "SL.glmnet", "SL.gam"),
         SL.method = "method.balance",
                stop.method = "es.mean")
df <- df %>%
  mutate(ipw=wit$weights) 
}
if(year=="1970") { wit <- df %>%
        mutate(.system = {{system}}) %>%
        weightit(.system ~ leaschool10 + cog10 + I(cog10^2) + region3 + sex +
                           hilefted + class10 +parint10  + ethnic5 +
                            hopeleaveage10 + hopepostschool10,
         estimand = "ATE", method = "super", 
         data=.,
         stabilize = "FALSE",
         SL.library = c("SL.glm", "SL.glmnet", "SL.gam"),
         SL.method = "method.balance",
                stop.method = "es.mean")
df <- df %>%
  mutate(ipw=wit$weights)   
}
return(df) 
}
  
ebalmodel <- function(df, system, year) {
 if(year=="1958") { wit <- df %>%
        mutate(.system = {{system}}) %>%
        weightit(.system ~ leaschool7 + cog11 + I(cog11^2) + region2 + sex +
                           hilefted + class11 +parint7  + ethnic42 +
                            hopeleaveage11 + hopepostschool11,
         estimand = "ATE", method = "ebal", 
         data=.)
df <- df %>%
  mutate(ipw=wit$weights) 
}
if(year=="1970") { wit <- df %>%
        mutate(.system = {{system}}) %>%
        weightit(.system ~ leaschool10 + cog10 + I(cog10^2) + region3 + sex +
                           hilefted + class10 +parint10  + ethnic5 +
                            hopeleaveage10 + hopepostschool10,
         estimand = "ATE", method = "ebal", 
         data=.)
df <- df %>%
  mutate(ipw=wit$weights)   
}
return(df) 
}


codeoutcomes <- function(df, year) {
if(year=="1958") { df <- df %>%
  mutate(ghealth42num = as.numeric(ghealth42)-1, 
         high38num = as.numeric(high38)-1) %>%
  mutate(across(c(ghealth42num, high38num, lifesatfuture42, lifesatnow42,
             wemwbs50, bmi42, smoke42, leftedage), 
             ~(max(.x, na.rm = TRUE)+min(.x, na.rm=TRUE)) - .x, .names="rev_{col}")) %>%
  mutate(short_ghealth42 = ghealth42num,
         attain_ghealth42 = rev_ghealth42num,
         short_bmi42=bmi42,
         attain_bmi42=rev_bmi42,
         short_smoke42=smoke42,
         attain_smoke42=rev_smoke42,
         short_wemwbs50=rev_wemwbs50,
         attain_wemwbs50=wemwbs50,
         short_lifesatnow42=rev_lifesatnow42,
         attain_lifesatnow42=lifesatnow42,
         short_lifesatfuture42=rev_lifesatfuture42,
         attain_lifesatfuture42=lifesatfuture42,
         short_high38=rev_high38num,
         attain_high38=high38num,
         short_leftedage=rev_leftedage,
         attain_leftedage=leftedage)
}
if(year=="1970") {df <- df %>%
  mutate(ghealth42num = as.numeric(ghealth42)-1, 
         high38num = as.numeric(high38)-1) %>%
  mutate(across(c(ghealth42num, high38num, lifesatfuture42, lifesatnow42,
             wemwbs42, bmi42, smoke42, leftedage), 
             ~(max(.x, na.rm = TRUE)+min(.x, na.rm=TRUE)) - .x, .names="rev_{col}")) %>%
  mutate(short_ghealth42 = ghealth42num,
         attain_ghealth42 = rev_ghealth42num,
         short_bmi42=bmi42,
         attain_bmi42=rev_bmi42,
         short_smoke42=smoke42,
         attain_smoke42=rev_smoke42,
         short_wemwbs42=rev_wemwbs42,
         attain_wemwbs42=wemwbs42,
         short_lifesatnow42=rev_lifesatnow42,
         attain_lifesatnow42=lifesatnow42,
         short_lifesatfuture42=rev_lifesatfuture42,
         attain_lifesatfuture42=lifesatfuture42,
         short_high38=rev_high38num,
         attain_high38=high38num,
         short_leftedage=rev_leftedage,
         attain_leftedage=leftedage)
}
  return(df)
}
  
codeoutcomesED <- function(df, year) {
df %>%
  mutate(class42num = as.numeric(class42)-1) %>%
  mutate(revclass42num= max(class42num, na.rm = TRUE)+
           min(class42num, na.rm=TRUE) - class42num) %>%
  mutate(short_class42 = class42num,
         attain_class42 = revclass42num)
}

  
outcomesdataset <- function(df, class, out, system, wt, misswt=TRUE, year=NULL) {
      m <- {{df}} %>%
  select(.id, class={{class}}, out={{out}}, 
  system={{system}}, wt={{wt}}) %>%
  filter(system!="Other") %>%
  mutate(notmiss=as.numeric(complete.cases(.)))
  if(misswt==TRUE & year=="1970") {n <- left_join(m, select({{df}},
                                        .id, leaschool10, 
                                        cog10, region3, sex,
                           hilefted, class10, parint10, ethnic5,
                            hopeleaveage10, hopepostschool10), by=c(".id"))
  s<-weightit(notmiss ~ system + leaschool10 + cog10 + I(cog10^2) + region3 + sex +
                           hilefted + class10 +parint10  + ethnic5 +
                            hopeleaveage10 + hopepostschool10,
         estimand = "ATE", method = "ps", 
         data=n)
  m <- m %>%
    mutate(wt2=s$weights,
         wt3=wt*wt2)
  }
  if(misswt==TRUE & year=="1958") {n <- left_join(m, select({{df}},
                                        .id, leaschool7, 
                                        cog11, region2, sex,
                           hilefted, class11, parint7, ethnic42,
                            hopeleaveage11, hopepostschool11), by=c(".id"))
  s<-weightit(notmiss ~ system + leaschool7 + cog11 + I(cog11^2) + region2 + sex +
                           hilefted + class11 +parint7  + ethnic42 +
                            hopeleaveage11 + hopepostschool11,
         estimand = "ATE", method = "ps", 
         data=n)
  m <- m %>%
    mutate(wt2=s$weights,
         wt3=wt*wt2) 
  }
  if(misswt==FALSE) {m <- m %>%
         mutate(wt2=1, wt3=wt*wt2)
  } 
m <- select(m, -c(wt, wt2, notmiss))      
return(m)      
}      

modelout <- function(m){    
m %>%
  filter(complete.cases(.)) %>%
  split(.$.imp) %>%
  map(~glm(out ~ system - 1, weights=wt3, data=.x)) %>%
  as.mira(.) %>%
  pool(.) %>%
  tidy(., conf.int=TRUE)
}

modeloutdiff <- function(m){    
m %>%
  filter(complete.cases(.)) %>%
  split(.$.imp) %>%
  map(~glm(out ~ system, weights=wt3, data=.x)) %>%
  as.mira(.) %>%
  pool(.) %>%
  tidy(., conf.int=TRUE)
}

modelconcen <- function(m){ 
mconcen <- m %>%
  filter(complete.cases(.)) %>%
  group_by(.imp, system) %>%
  arrange(desc(class), .by_group = TRUE) %>%
	mutate(sumw=sum(wt3)) %>%
	mutate(cumw=cumsum(wt3)) %>%
	mutate(cumw_1=lag(cumw)) %>%
	mutate(cumw_1=coalesce(cumw_1, 0)) %>%
  group_by(class, .add = TRUE) %>%
	mutate(cumwr=max(cumw)) %>%
	mutate(cumwr_1=min(cumw_1)) %>%
	group_by(.imp, system) %>%
	mutate(frnk=(cumwr_1+0.5*(cumwr-cumwr_1))/sumw) %>%
	mutate(temp=(wt3 /sumw)*((frnk-0.5)^2)) %>%
	mutate(sigma2=sum(temp)) %>%
  mutate(min_out=min(out), max_out=max(out)) %>%
	mutate(varlist_star=(out-min_out)
	       / (max_out - min_out)) %>%
	mutate(temp=wt3*varlist_star) %>%
	mutate(meanlhs=sum(temp)) %>%
	mutate(meanlhs=meanlhs/sumw) %>% 
  mutate(atemp=wt3*out) %>%
	mutate(ameanlhs=sum(atemp)) %>%
	mutate(ameanlhs=ameanlhs/sumw) %>% 
  mutate(scale=1) %>%
	mutate(lhs=2*sigma2*(varlist_star/meanlhs)*scale) %>%
	mutate(intercept=scale) %>%
	mutate(rhs=frnk*scale) %>%
  mutate(lhs_abs = lhs*(4*meanlhs)) 
  

modeloutconcenR <- mconcen %>%
  split(.$.imp) %>%
  map(~glm(lhs ~ rhs*system, weights=wt3, data=.x)) %>%
  as.mira(.) %>%
  pool(.) %>%
  tidy(., conf.int=TRUE)
  
modeloutconcenA <-  mconcen %>% 
  split(.$.imp) %>%
  map(~glm(lhs_abs ~ rhs*system, weights=wt3, data=.x)) %>%
  as.mira(.) %>%
  pool(.) %>%
  tidy(., conf.int=TRUE)

return(list(A=modeloutconcenA, R=modeloutconcenR))
} 

outcomes <- function(outcome) {
  m <- list.files() %>%
  .[str_detect(., outcome)] %>%
  map_dfr(., ~readRDS(.), .id=".imp") 
  mo <- modelout(m)
  mo2 <- modeloutdiff(m)
  mcon <- modelconcen(m)
return(list(out=mo, outdiff=mo2, concenR=mcon$R, concenA=mcon$A))  
}

prepout <- function(df) { 
 df %>%
  separate(outcome, c("Type", "out"), sep="_")  %>%
  separate(out, c("Outcome", "test"), sep="[.]") %>%
  rename(Absolute=test) %>%
  filter(Absolute!="concenA" | Type!="short" ) %>% 
  mutate(Type2 = case_when(Absolute=="concenA" ~ "Absolute",
                           Absolute=="concenR" & Type=="short" ~ 
                             "Relative Shortfall",
                           Absolute=="concenR" & Type=="attain" ~ 
                             "Relative Attainment"))  %>%
  mutate(Outcome=case_when(Outcome == "lifesatfuture42" ~ "Life satisfaction - future",
                           Outcome == "bmi42" | Outcome == "bmi10"  |
                           Outcome == "bmi11" ~ "BMI",
                           Outcome == "smoke42" ~ "Current Smoker",
                           Outcome == "ghealth42" ~ "General Health",
                           Outcome == "high38" ~ "Highest qualification",
                           Outcome == "lifesatnow42" ~ "Life satisfaction",
                           Outcome == "wemwbs42" | Outcome== "wemwbs50"
                           ~ "Mental wellbeing",
                           Outcome == "leftedage" ~ "Age left education",
                           Outcome=="class42" ~ "Social class")) %>%
    mutate(System=case_when(term=="rhs" ~ "Comp",
                        term=="rhs:systemSelective" ~ "Select V Comp")) %>%
    mutate(system2=case_when(term== "systemComprehensive" & Absolute =="out"  ~ "Comprehensive",
                        term=="systemSelective" & Absolute =="out" ~ "Selective"))
  }  
  


outcometodf <- function(resdf) {
  unlist(resdf, recursive = FALSE) %>%
 map_dfr(., ~.x, .id="outcome")
}

plotoutconcen <- function(df1958, df1970) {
  ARdf <- bind_rows("1958" = df1958,
                    "1970" = df1970, 
                    .id="group") %>%
  mutate(Outcome=factor(Outcome)) %>%
  mutate(Outcome=ordered(Outcome, levels=c("BMI",  "Current Smoker", "General Health",
                                           "Mental wellbeing", "Life satisfaction",
                                           "Life satisfaction - future",
                                           "Age left education",
                                           "Highest qualification")))  
  ggplot(ARdf, aes(x=estimate, y=Outcome , xmin = conf.low,
                  xmax = conf.high, colour=group)) +
  geom_pointrange(position=position_dodge(width = 1), fatten=1.5) +
  xlab("Inequality in Comprehensive system and difference in Selective system") +
  ylab("") +
  theme_bw() +
  geom_vline(xintercept = 0, colour="grey") +
  facet_grid(rows=vars(Type2), cols=vars(System), scales="free_x")  +
  theme(strip.text.y = element_text(angle = 0),
        legend.position="top",
        legend.title=element_blank())
}

plotoutconcenED <- function(df1958, df1970) {
  ARdf <- bind_rows("1958" = df1958,
                    "1970" = df1970, 
                    .id="group") %>%
  mutate(Outcome=factor(Outcome)) %>%
  mutate(Outcome=ordered(Outcome, levels=c("BMI",  "Current Smoker", "General Health",
                                           "Mental wellbeing", "Life satisfaction",
                                           "Life satisfaction - future",
                                           "Social class")))  
  ggplot(ARdf, aes(x=estimate, y=Outcome , xmin = conf.low,
                  xmax = conf.high, colour=group)) +
  geom_pointrange(position=position_dodge(width = 1), fatten=1.5) +
  xlab("Inequality in Comprehensive system and difference in Selective system") +
  ylab("") +
  theme_bw() +
  geom_vline(xintercept = 0, colour="grey") +
  facet_grid(rows=vars(Type2), cols=vars(System), scales="free_x")  +
  theme(strip.text.y = element_text(angle = 0),
        legend.position="top",
        legend.title=element_blank())
}







plotoutavg <- function(df1958origin, df1970origin) { 
  OUTAVG <- bind_rows("1958"=df1958origin, "1970"= df1970origin, .id="group") %>%
    filter(Type=="attain" & Outcome=="General Health" |
             Type=="short" & Outcome=="BMI" |
         Type=="short" & Outcome=="Current Smoker" |
         Type=="attain" & Outcome=="Age left education" |
         Type=="attain" & Outcome=="Mental wellbeing" |  
           Type=="attain" & Outcome=="Highest qualification" | 
           Type=="attain" & Outcome=="Life satisfaction" | 
           Type=="attain" & Outcome=="Life satisfaction - future") %>%
    mutate(across(c(estimate, conf.low, conf.high), ~case_when
                (Outcome=="Current Smoker" ~  .x*100,
                Outcome=="General Health" & group=="1970" ~ ((.x) / 4),
                Outcome=="General Health" & group=="1958" ~ ((.x) / 3),
                Outcome=="Highest qualification"  ~ ((.x) / 3), 
                TRUE ~ .x)))
  ggplot(OUTAVG, aes(x=estimate, y=group , xmin = conf.low,
                  xmax = conf.high, colour=system2)) +
  geom_pointrange(position=position_dodge(width = 1), fatten=1.5) +
  xlab("") +
  ylab("") +
  theme_bw() +
  facet_wrap(vars(Outcome), ncol=2, scales="free_x")  +
  theme(strip.text.y = element_text(angle = 0),
        legend.position="top",
        legend.title=element_blank()) +
  labs(caption = "Life satisfaction is 0 to 10 scale (higher=more), 
       General health scaled to 0 to 1 (higher=better, 1958 and 1970 not comparable),
       Highest qualification scaled to 0 to 1 (higher=higher),
       Mental wellbeing is 10 to 70 scale (lower=worse)")  
}

outlistED <- function(outlist) {
outlist <- outlist
outlist$attain_high38 <- NULL
outlist$short_high38 <- NULL
outlist$short_leftedage <- NULL
outlist$attain_leftedage <- NULL
outlist$short_class42 <- "short_class42"
outlist$attain_class42 <- "attain_class42"
return(outlist)
} 

vartable <- function(df, wt=1) {
df %>%
  mutate(wt={{wt}}) %>%
  select(c1, wt) %>%
  summarise(n = sum(as.numeric(!is.na(c1))*wt),
  pc= weighted.mean(c1, wt, na.rm=TRUE),
  var=sum(wt) / (sum(wt)^2 - sum(wt^2)) * 
                                sum(wt*(c1-pc)^2))
}





sumtable <- function(df, wt=1) {
s1 <-  select(df, !where(is.numeric)) %>%
  names(.)
s2 <-  df %>%
  mutate(wt={{wt}}) %>%
  select(c(all_of(s1), wt))
df1 <-  map_dfr(s1, ~count(s2, .data[[.x]], wt=wt) %>%
                  pivot_longer(-n, names_to="variable") %>%
                  mutate(across(c(variable, value), as.character))) %>%
                  group_by(variable) %>%
                  mutate(nsum=ifelse(is.na(value), NA, n)) %>%
                  mutate(pc=ifelse(is.na(value), NA, (n/sum(nsum, na.rm=TRUE))*100)) %>%
                  ungroup(.)
df2 <-df %>%
  mutate(wt={{wt}}) %>%
  select(c(where(is.numeric), wt))
df21 <- df2 %>%
  summarise(across(-wt, ~sum(as.numeric(!is.na(.x))*wt), .names = "n_{.col}"))
df22 <- df2 %>%
   summarise(across(-wt, ~weighted.mean(.x, wt, na.rm=TRUE), .names = "pc_{.col}"))
df2 <- bind_cols(df21, df22) %>%
      pivot_longer(everything(), 
                   names_to=c(".value", "variable"),
                   names_sep="_") %>%
      mutate(value = "(mean)") %>%
      mutate(across(c(variable, value), as.character))
  bind_rows(df1, df2) %>%
    select(variable, value, n, pc) 
}  

tableone <- function(df, system58, year) { 
if(year==1958) {df <- df %>%
  select({{system58}}, leaschool7, cog11, region2, sex,
                           hilefted, class11, parint7, ethnic42,
                            hopeleaveage11, hopepostschool11, ipw) %>%
  mutate(leaschool7 = factor(leaschool7)) %>%
  rename(system={{system58}})
dfa <- filter(df, system=="Selective")
tdfa <- sumtable(dfa, wt=ipw) 
dfb <- filter(df, system=="Comprehensive")
tdfb <- sumtable(dfb, wt=ipw)  
tdfc <- sumtable(dfa, wt=1) 
tdfd <- sumtable(dfb, wt=1) 
tdfe <- sumtable(df, wt=1)
tdff <- full_join(tdfa, tdfb, by=c("variable", "value")) %>%
 mutate(n=n.x-n.y, pc=pc.x-pc.y) %>%
  mutate(n=if_else(is.na(n), 0-n.y, n)) %>%
  mutate(pc=if_else(is.na(pc), 0-pc.y, pc)) %>%       
  select(variable, value, n, pc) 
  
tdfg <- full_join(tdfc, tdfd, by=c("variable", "value")) %>%
   mutate(n=n.x-n.y, pc=pc.x-pc.y) %>%
  mutate(n=if_else(is.na(n), 0-n.y, n)) %>%
  mutate(pc=if_else(is.na(pc), 0-pc.y, pc)) %>%
  select(variable, value, n, pc)
}

if(year==1970) {df <- df %>%
  select(system16, leaschool10, cog10, region3, sex,
                           hilefted, class10, parint10, ethnic5,
                            hopeleaveage10, hopepostschool10, ipw) %>%
  mutate(leaschool10 = factor(leaschool10)) %>%
  rename(system=system16)
dfa <- filter(df, system=="Selective")
tdfa <- sumtable(dfa, wt=ipw) 
dfb <- filter(df, system=="Comprehensive")
tdfb <- sumtable(dfb, wt=ipw)  
tdfc <- sumtable(dfa, wt=1) 
tdfd <- sumtable(dfb, wt=1) 
tdfe <- sumtable(df, wt=1)
tdff <- full_join(tdfa, tdfb, by=c("variable", "value")) %>%
 mutate(n=n.x-n.y, pc=pc.x-pc.y) %>%
  mutate(n=if_else(is.na(n), 0-n.y, n)) %>%
  mutate(pc=if_else(is.na(pc), 0-pc.y, pc)) %>%       
  select(variable, value, n, pc) 
  
tdfg <- full_join(tdfc, tdfd, by=c("variable", "value")) %>%
   mutate(n=n.x-n.y, pc=pc.x-pc.y) %>%
  mutate(n=if_else(is.na(n), 0-n.y, n)) %>%
  mutate(pc=if_else(is.na(pc), 0-pc.y, pc)) %>%
  select(variable, value, n, pc)
}
bind_rows("afsel"=tdfa, "afcom"=tdfb, "b4sel"=tdfc, 
          "b4comp"=tdfd, "all"=tdfe, "afdiff"=tdff, "b4diff"=tdfg, .id="grp") %>%
  filter(variable!="ipw")
}

 
polish_table <- function(df, year) { 
  df2 <- df %>% 
       group_by(grp, variable, value) %>%
       summarise(across(-file, mean)) %>%
       pivot_wider(names_from=grp, values_from = c("n", "pc")) %>%
       ungroup()
  df3 <- filter(df2, variable=="system") %>%
    select(c(variable, starts_with("n"), -ends_with("diff"))) %>%
    summarise(across(-variable, ~sum(.x, na.rm=TRUE))) %>%
    mutate(variable=paste0(year),
           value="N") %>%
    select(variable, value, All=n_all, Compb4=n_b4comp,
           Selectb4=n_b4sel, Compaf=n_afcom, Selectaf=n_afsel)
  df4 <- df2 %>%
    filter(variable!="system") %>%
    select(variable, value, All=pc_all, Compb4=pc_b4comp,
           Selectb4=pc_b4sel, Compaf=pc_afcom, Selectaf=pc_afsel)
bind_rows(df3, df4)  %>%
mutate(variable=(case_when(variable=="leaschool7" ~ "State primary school",
                             variable=="cog11" ~ "Cognitive ability", 
                             variable=="region2" ~ "Region of residence",
                             variable=="sex" ~ "Sex",
                             variable=="hilefted" ~ "Age parent left education",
                             variable=="class11" ~ "Father's NSSEC",
                          variable=="parint7" ~ "Parents interest in school rated by school",
                          variable=="hopeleaveage11" ~ "When parents hope will leave school",
                variable=="hopepostschool11" ~ "Parents hope stays in education post school",
                variable=="ethnic42" ~ "Ethnicity",
                variable=="leaschool10" ~ "State primary school", 
                             variable=="cog10" ~ "Cognitive ability", 
                             variable=="region3" ~ "Region of residence",
                             variable=="sex" ~ "Sex",
                             variable=="hilefted" ~ "Age parent left education",
                             variable=="class10" ~ "Father's NSSEC",
                          variable=="parint10" ~ "Parents interest in school rated by school",
                          variable=="hopeleaveage10" ~ "When parents hope will leave school",
                variable=="hopepostschool10" ~ "Parents hope stays in education post school",
                variable=="ethnic5" ~ "Ethnicity",
                variable=="cog10" ~ "Cognitive ability",
                variable=="cog11" ~ "Cognitive ability",
                TRUE ~ variable
                ))) %>%
  mutate(variable=ordered(variable, levels=c("Sex",
                                             "Ethnicity",
                                             "Cognitive ability",
                                             "Region of residence",
                                             "Age parent left education",
                                             "When parents hope will leave school",
                                             "Parents hope stays in education post school",
                                             "Parents interest in school rated by school",
                                             "State primary school",
                                             "Father's NSSEC"
                                             ))) %>%
  arrange(!is.na(variable), variable) %>%
  mutate(value=case_when(value=="0" ~ "No",
                         value=="1" ~ "Yes",
                         TRUE ~ value)) %>%
  mutate(across(where(is.numeric),~if_else(value!="N", 
                                            round(.x, 1), round(.x,0))))
}



varone <- function(df, system, cog) { 
 df <- df %>%
  select(sys={{system}}, c1={{cog}}, ipw) 
dfa <- filter(df, sys=="Selective")
tdfa <- vartable(dfa, wt=ipw) 
dfb <- filter(df, sys=="Comprehensive")
tdfb <- vartable(dfb, wt=ipw)  
tdfc <- vartable(dfa, wt=1) 
tdfd <- vartable(dfb, wt=1) 
tdfe <- vartable(df, wt=1)
tdff <- bind_cols(tdfb, tdfa) %>%
  mutate(n=n...4-n...1, pc=(pc...5-pc...2) / (sqrt((var...6+var...3)/2))) %>%
  select(n, pc)
tdfg <- bind_cols(tdfd, tdfc) %>%
  mutate(n=n...4-n...1, pc=(pc...5-pc...2) / (sqrt((var...6+var...3)/2))) %>%
  select(n, pc)
bind_rows("afsel"=tdfa, "afcom"=tdfb, "b4sel"=tdfc, 
          "b4comp"=tdfd, "all"=tdfe, "afdiff"=tdff, "b4diff"=tdfg, .id="grp")
}

figureone <- function(df) {
  df %>%
  group_by(grp, variable, value) %>%
  summarise(across(-file, mean)) %>%
  filter(grp=="b4diff" | grp=="afdiff") %>%
  filter(variable!="system") %>%
  select(-n) %>%
  pivot_wider(names_from=grp, values_from = c("pc")) %>%
       ungroup() %>%
  mutate(variable=(case_when(variable=="leaschool7" ~ "State primary school",
                             variable=="cog11" ~ "Cognitive ability", 
                             variable=="region2" ~ "Region of residence",
                             variable=="sex" ~ "Sex",
                             variable=="hilefted" ~ "Age parent left education",
                             variable=="class11" ~ "Father's NSSEC",
                          variable=="parint7" ~ "Parents interest in school rated by school",
                          variable=="hopeleaveage11" ~ "When parents hope will leave school",
                variable=="hopepostschool11" ~ "Parents hope stays in education post school",
                variable=="ethnic42" ~ "Ethnicity",
                variable=="leaschool10" ~ "State primary school", 
                             variable=="cog10" ~ "Cognitive ability", 
                             variable=="region3" ~ "Region of residence",
                             variable=="sex" ~ "Sex",
                             variable=="hilefted" ~ "Age parent left education",
                             variable=="class10" ~ "Father's NSSEC",
                          variable=="parint10" ~ "Parents interest in school rated by school",
                          variable=="hopeleaveage10" ~ "When parents hope will leave school",
                variable=="hopepostschool10" ~ "Parents hope stays in education post school",
                variable=="ethnic5" ~ "Ethnicity",
                variable=="cog10" ~ "Cognitive ability",
                variable=="cog11" ~ "Cognitive ability",
                TRUE ~ variable
                ))) %>%
   mutate(variable=ordered(variable, levels=c("Sex",
                                             "Ethnicity",
                                             "Cognitive ability",
                                             "Region of residence",
                                             "Age parent left education",
                                             "When parents hope will leave school",
                                             "Parents hope stays in education post school",
                                             "Parents interest in school rated by school",
                                             "State primary school",
                                             "Father's NSSEC"
                                             ))) %>%
  arrange(!is.na(variable), variable) %>%   
  mutate(value=case_when(value=="0" ~ "No",
                         value=="1" ~ "Yes",
                         TRUE ~ value)) %>%
   mutate(value=case_when(value=="19plus" ~ "19 plus",
                         TRUE ~ value)) 
}

theme_dotplot <- theme_bw(14) +
    theme(axis.text.y = element_text(size = rel(.75)),
    	axis.ticks.y = element_blank(),
        axis.title.x = element_text(size = rel(.75)),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(size = 0.5),
        panel.grid.minor.x = element_blank(),
    	  legend.title = element_text(size = rel(.6)),
    	  legend.text = element_text(size = rel(.6)),
    	  legend.position="top")


fig1a <- function(system58) {
temp_filelist <- list.files(pattern="^impdf1958_") 
df <- map_dfr(temp_filelist, ~readRDS(.x))
df <- select(df, system={{system58}}, cog=cog11,  ipw)
temp_filelist <- list.files(pattern="^impdf1970_")
df1 <- map_dfr(temp_filelist, ~readRDS(.x))
df1 <-select(df1, system=system16, cog=cog10,  ipw)
df2 <- bind_rows("1958" =df, "1970" = df1, .id="cohort") %>%       
  bind_rows("Before" = ., "After" = ., .id="group") %>%
  mutate(group=factor(group)) %>%
  mutate(group=ordered(group, levels = c("Before", "After"))) %>%
  mutate(ipw=if_else(group=="Before", 1, ipw))
ggplot(df2, aes(cog, color=system, fill=system, weight=ipw))  +
  geom_density() +
  facet_grid(rows=vars(cohort), cols=vars(group)) +
  theme_minimal() +
  xlab("Cognitive ability") +
  ylab("Density") +
  theme(axis.text.y = element_text(size = rel(.5)),
        legend.title = element_blank())
}

codeoutcomesBMI <- function(df, year) {
    if(year==1958) {df1 <- df %>%
      mutate(revbmi11 = max(bmi11, na.rm = TRUE)+
               min(bmi11, na.rm=TRUE) - bmi11) %>%
      mutate(short_bmi11 = bmi11,
             attain_bmi11 = revbmi11)
    }
    if(year==1970) {df1 <- df %>%
        mutate(revbmi10 = max(bmi10, na.rm = TRUE)+
                 min(bmi10, na.rm=TRUE) - bmi10) %>%
        mutate(short_bmi10 = bmi10,
               attain_bmi10 = revbmi10)
    }
  return(df1)
  }


getoutcomesBMI <- function(misswt2=TRUE) {
  
  filelist <- list.files(pattern="^impdf1958_")
  
  walk(filelist, ~readRDS(.x) %>%
         codeoutcomesBMI(., year=1958) %>%
         saveRDS(., .x))
  
  outlist <- list("attain_bmi11", "short_bmi11") 
  names(outlist) <- outlist
  
  filelist2<- rep(filelist, each=2)
  outlist2 <- rep(outlist, times=68)
  
  if(misswt2==TRUE) {walk2(filelist2, outlist2, ~readRDS(.x) %>%
                             outcomesdataset(., class11, all_of(.y), system16, 
                                             ipw, misswt=TRUE, year=1958) %>%
                             saveRDS(., file=paste0(.y, "_", .x)))
  }
  if(misswt2==FALSE) {walk2(filelist2, outlist2, ~readRDS(.x) %>%
                              outcomesdataset(., class11, all_of(.y), system16, 
                                              ipw, misswt=FALSE, year=1958) %>%
                              saveRDS(., file=paste0(.y, "_", .x)))
  }
  
  #get all the outcomes
  
  outcomes1958class11 <- outlist %>% 
    map(~outcomes(.x))
  
  #tidy 
  
  file.remove(list.files(pattern = "^attain"))
  file.remove(list.files(pattern = "^short"))
  
  #class42
  
  if(misswt2==TRUE) {walk2(filelist2, outlist2, ~readRDS(.x) %>%
                             outcomesdataset(., class42, all_of(.y), system16, 
                                             ipw, misswt=TRUE, year=1958) %>%
                             saveRDS(., file=paste0(.y, "_", .x)))
  }
  if(misswt2==FALSE) {walk2(filelist2, outlist2, ~readRDS(.x) %>%
                              outcomesdataset(., class42, all_of(.y), system16, 
                                              ipw, misswt=FALSE, year=1958) %>%
                              saveRDS(., file=paste0(.y, "_", .x)))
  }
  
  outcomes1958class42 <- outlist %>% 
    map(~outcomes(.x))
  
  file.remove(list.files(pattern = "^attain"))
  file.remove(list.files(pattern = "^short"))
  
  #outcomes to data frame 
  outcomes1958class11 <-outcometodf(outcomes1958class11)
  outcomes1958class42 <-outcometodf(outcomes1958class42)
  
  gooutcomes1958class11 <- prepout(outcomes1958class11)
  gooutcomes1958class42 <- prepout(outcomes1958class42)  
  
 filelist <- list.files(pattern="^impdf1970_")
  
  walk(filelist, ~readRDS(.x) %>%
         codeoutcomesBMI(., year=1970) %>%
         saveRDS(., .x))
  
  outlist <- list("attain_bmi10", "short_bmi10")
  names(outlist) <- outlist
  
  filelist2<- rep(filelist, each=2)
  outlist2 <- rep(outlist, times=72)
  
  if(misswt2==TRUE) {walk2(filelist2, outlist2, ~readRDS(.x) %>%
                             outcomesdataset(., class10, all_of(.y), system16, 
                                             ipw, misswt=TRUE, year=1970) %>%
                             saveRDS(., file=paste0(.y, "_", .x)))
  }
  if(misswt2==FALSE) {walk2(filelist2, outlist2, ~readRDS(.x) %>%
                              outcomesdataset(., class10, all_of(.y), system16, 
                                              ipw, misswt=FALSE, year=1970) %>%
                              saveRDS(., file=paste0(.y, "_", .x)))
  }
  
  #get all the outcomes
  
  outcomes1970class10 <- outlist %>% 
    map(~outcomes(.x))
  
  #tidy 
  
  file.remove(list.files(pattern = "^attain"))
  file.remove(list.files(pattern = "^short"))
  
  #class42
  
  if(misswt2==TRUE) {walk2(filelist2, outlist2, ~readRDS(.x) %>%
                             outcomesdataset(., class42, all_of(.y), system16, 
                                             ipw, misswt=TRUE, year=1970) %>%
                             saveRDS(., file=paste0(.y, "_", .x)))
  }
  if(misswt2==FALSE) {walk2(filelist2, outlist2, ~readRDS(.x) %>%
                              outcomesdataset(., class42, all_of(.y), system16, 
                                              ipw, misswt=FALSE, year=1970) %>%
                              saveRDS(., file=paste0(.y, "_", .x)))
  }
  
  outcomes1970class42 <- outlist %>% 
    map(~outcomes(.x))
  
  file.remove(list.files(pattern = "^attain"))
  file.remove(list.files(pattern = "^short"))
  
  #outcomes to data frame 
  outcomes1970class10 <-outcometodf(outcomes1970class10)
  outcomes1970class42 <-outcometodf(outcomes1970class42)
  
  gooutcomes1970class10 <- prepout(outcomes1970class10)
  gooutcomes1970class42 <- prepout(outcomes1970class42)

 return(list("class11_1958" = outcomes1958class11, "class42_1958" = outcomes1958class42, "go_class11_1958" = gooutcomes1958class11, "go_class42_1958" = gooutcomes1958class42, "class10_1970" = outcomes1970class10, "class42_1970" = outcomes1970class42, 
  "go_class10_1970" =gooutcomes1970class10, "go_class42_1970"=gooutcomes1970class42))
} 
  
getoutcomesCOG <- function(misswt2=TRUE) {


filelist <- list.files(pattern="^impdf1958_")


outlist <- genoutlist("impdf1958_50.RDS")

#combine file and out list 68 imps for 1958 and 72 for 1970

filelist2<- rep(filelist, each=20)
outlist2 <- rep(outlist, times=68)


if(misswt2==TRUE) {walk2(filelist2, outlist2, ~readRDS(.x) %>%
       outcomesdataset(., cog11, all_of(.y), system16, 
                                ipw, misswt=TRUE, year=1958) %>%
       saveRDS(., file=paste0(.y, "_", .x)))
}
if(misswt2==FALSE) {walk2(filelist2, outlist2, ~readRDS(.x) %>%
       outcomesdataset(., cog11, all_of(.y), system16, 
                                ipw, misswt=FALSE, year=1958) %>%
       saveRDS(., file=paste0(.y, "_", .x)))
}

#get all the outcomes

outcomes1958cog11 <- outlist %>% 
  map(~cogoutcomes(.x))

#tidy 
  
file.remove(list.files(pattern = "^attain"))
file.remove(list.files(pattern = "^short"))

filelist <- list.files(pattern="^impdf1970_")


outlist <- genoutlist("impdf1970_50.RDS")

#combine file and out list 68 imps for 1958 and 72 for 1970

filelist2<- rep(filelist, each=20)
outlist2 <- rep(outlist, times=72)


if(misswt2==TRUE) {walk2(filelist2, outlist2, ~readRDS(.x) %>%
       outcomesdataset(., cog10, all_of(.y), system16, 
                                ipw, misswt=TRUE, year=1970) %>%
       saveRDS(., file=paste0(.y, "_", .x)))
}
if(misswt2==FALSE) {walk2(filelist2, outlist2, ~readRDS(.x) %>%
       outcomesdataset(., cog10, all_of(.y), system16, 
                                ipw, misswt=FALSE, year=1970) %>%
       saveRDS(., file=paste0(.y, "_", .x)))
}

#get all the outcomes

outcomes1970cog10 <- outlist %>% 
  map(~cogoutcomes(.x))

file.remove(list.files(pattern = "^attain"))
file.remove(list.files(pattern = "^short"))

outcomes1958cog11  <-outcometodf(outcomes1958cog11)
outcomes1970cog10 <-outcometodf(outcomes1970cog10)

return(list("cog11_1958" = outcomes1958cog11, "cog10_1970" = outcomes1970cog10))
}



cogoutcomes <-  function(outcome) {
  m <- list.files() %>%
  .[str_detect(., outcome)] %>%
  map_dfr(., ~readRDS(.), .id=".imp") 
  mo <- cogout(m)
return(list(out=mo))  
}



cogout <- function(m){    
breaks <- c(40, 70, 75, 80, 85, 90, 95, 100, 105, 110, 115, 120, 125, 155) 
  m %>%
  filter(complete.cases(.)) %>%
  mutate(bcog= cut(class, breaks=breaks)) %>%  
  mutate(sys_bcog=interaction(system, bcog, sep="_")) %>% 
  split(.$.imp) %>%
  map(~glm(out ~ sys_bcog - 1, weights=wt3, data=.x)) %>%
  as.mira(.) %>%
  pool(.) %>%
  tidy(., conf.int=TRUE)
}

prepfiles2 <- function() { 
filelist <- list.files(pattern="^impdf1958_") 
  names(filelist) <- filelist
  df <- readRDS("impdf1958.rds") %>%
 complete(., action="long", include=FALSE) %>%
  select(c(ghealth42, lifesatfuture42, lifesatnow42, wemwbs50, bmi42, 
           class42, smoke42, bmi42, high38, leftedage, .id, .imp))
  df1 <- map_dfr(filelist, ~readRDS(.x), .id="file") %>%
          select(-c(ghealth42, lifesatfuture42, lifesatnow42, wemwbs50, bmi42, 
           class42, smoke42, bmi42, high38, leftedage, starts_with("attain"), 
           starts_with("short"), starts_with("rev"))) %>%
    separate(file, c(NA, ".imp"), sep="_") %>%
    separate(.imp, c(".imp", NA), sep="[.]") %>%
    mutate(.imp=as.integer(.imp)) %>%
  left_join(df, by=c(".id", ".imp")) %>%
    codeoutcomes(., year="1958")  %>%
    splitsave(., "impdf1958_")
}



prepfiles3 <- function() { 
filelist <- list.files(pattern="^impdf1970_") 
  names(filelist) <- filelist
  df <- readRDS("impdf1970.rds") %>%
 complete(., action="long", include=FALSE) %>%
  select(c(ghealth42, lifesatfuture42, lifesatnow42, wemwbs42,bmi42, 
           class42, smoke42, bmi42, high38, leftedage, .id, .imp))
  df1 <- map_dfr(filelist, ~readRDS(.x), .id="file") %>%
          select(-c(ghealth42, lifesatfuture42, lifesatnow42, wemwbs42,bmi42, 
           class42, smoke42, bmi42, high38, leftedage, starts_with("attain"), 
           starts_with("short"), starts_with("rev"))) %>%
    separate(file, c(NA, ".imp"), sep="_") %>%
    separate(.imp, c(".imp", NA), sep="[.]") %>%
    mutate(.imp=as.integer(.imp)) %>%
  left_join(df, by=c(".id", ".imp")) %>%
    codeoutcomes(., year="1970")  %>%
    splitsave(., "impdf1970_")
}
 

gbmmodel <- function(df, system, year) {
  if(year=="1958") { wit <- df %>%
    mutate(.system = {{system}}) %>%
    weightit(.system ~ leaschool7 + cog11 + I(cog11^2) + region2 + sex +
               hilefted + class11 +parint7  + ethnic42 +
               hopeleaveage11 + hopepostschool11,
             estimand = "ATE", method = "gbm", 
             data=.)
  df <- df %>%
    mutate(ipw=wit$weights) 
  }
  if(year=="1970") { wit <- df %>%
    mutate(.system = {{system}}) %>%
    weightit(.system ~ leaschool10 + cog10 + I(cog10^2) + region3 + sex +
               hilefted + class10 +parint10  + ethnic5 +
               hopeleaveage10 + hopepostschool10,
             estimand = "ATE", method = "gbm", 
             data=.)
  df <- df %>%
    mutate(ipw=wit$weights)   
  }
  return(df) 
}

onetable <- function(tab1958, tab1970) {
bind_rows(tab1958, tab1970) %>%
flextable(.) %>%
colformat_num(x = ., i= c(1,38), digits = 0) %>%
   merge_v(., j="variable") %>%
   set_header_labels(variable="",
                    value="",
                    All="All",
                    Compb4="Comp",
                    Selectb4="Select",
                    Compaf="Comp",
                    Selectaf="Select") %>%
  add_header_row(values=c("", "Before", "After"), 
                 colwidths = c(3,2,2)) %>%
  align_text_col(., align="left") %>%
  align_nottext_col(., align="center") %>%
  bold(., i= c(1,39)) %>%
  fontsize(., size=8, part="all") %>%
  hline_top(., part = "header") %>%
  autofit(.)
}

onefigure  <- function(figure1_1958, figure1_1970) {
  bind_rows("1958" =  figure1_1958, 
                      "1970" = figure1_1970, .id="Cohort") %>%
  pivot_longer(cols=ends_with("diff"),   names_to = "Weighting", 
             values_to = "Difference", names_prefix="Difference_") %>%
  mutate(Weighting=if_else(Weighting=="afdiff", "After", "Before")) %>%
  arrange(variable) %>%
  unite(Variable, variable, value, sep= "-", remove=FALSE) %>%
  mutate(Variable=ordered(Variable, levels=rev(unique(Variable)))) %>%
  ggplot(data=., aes(x=Difference, y=Variable))  +
  geom_point(aes(colour=Weighting)) +
  theme_dotplot +
  labs(y = NULL, x="Difference (% point)") +
  geom_vline(xintercept = 0, colour="grey") +
  annotate("rect", xmin = -1, xmax = 1, ymin = 0, ymax = 47, 
           alpha = .1) +
  facet_wrap(vars(Cohort))
}

plotcog <- function(df, year) {
  df <- df %>%
  separate(outcome, c("outcome", NA), sep="[.]") %>%
  separate(term, c(NA, "term"), sep=8) %>%
  separate(term, c("System", "Cog"), sep="_") %>%
  filter(outcome=="attain_ghealth42" |
           outcome=="short_bmi42" |
           outcome=="short_smoke42" |
           outcome=="attain_leftedage" |
           outcome=="attain_wemwbs50" |  
           outcome=="attain_wemwbs42" |
           outcome=="attain_high38" | 
           outcome=="attain_lifesatnow42" | 
           outcome=="attain_lifesatfuture42") %>%
  mutate(Cog=factor(Cog, levels = c("(40,70]", "(70,75]", "(75,80]",
                                     "(80,85]", "(85,90]", "(90,95]",
                                     "(95,100]", "(100,105]", "(105,110]",
                                     "(110,115]", "(115,120]",
                                     "(120,125]",  "(125,155]"), ordered=TRUE)) %>%
  separate(outcome, c(NA,"outcome"), sep="_") %>%
  mutate(outcome=case_when(outcome == "lifesatfuture42" ~ "Life satisfaction - future",
                           outcome == "bmi42" | outcome == "bmi10"  |
                             outcome == "bmi11" ~ "BMI",
                           outcome == "smoke42" ~ "Current Smoker",
                           outcome == "ghealth42" ~ "General Health",
                           outcome == "high38" ~ "Highest qualification",
                           outcome == "lifesatnow42" ~ "Life satisfaction",
                           outcome == "wemwbs42" | outcome== "wemwbs50"
                           ~ "Mental wellbeing",
                           outcome == "leftedage" ~ "Age left education",
                           outcome=="class42" ~ "Social class")) 
if(year==1958) {
    df <- df %>%
    mutate(across(c(estimate, conf.low, conf.high), ~case_when
                (outcome=="Current Smoker" ~  .x*100,
                  outcome=="General Health" ~ ((.x) / 3),
                  outcome=="Highest qualification"  ~ ((.x) / 3), 
                  TRUE ~ .x)))
}
if(year==1970) {
    df <- df %>%
      mutate(across(c(estimate, conf.low, conf.high), ~case_when
                    (outcome=="Current Smoker" ~  .x*100,
                      outcome=="General Health" ~ ((.x) / 4),
                      outcome=="Highest qualification"  ~ ((.x) / 3), 
                      TRUE ~ .x)))
  }  
  
ggplot(df, aes(x=Cog, y=estimate, colour= System, ymin=conf.low, ymax=conf.high)) +
  geom_pointrange() +
  facet_wrap(vars(outcome), ncol=2, scales="free_y") +
  theme_minimal() +
  theme(legend.position="top",
        legend.title=element_blank(),
        axis.text.x=element_text(angle=45, hjust=1, size=8)) +
  xlab("Cognitive Ability") +
  ylab(" ") +
  labs(caption = "Life satisfaction is 0 to 10 scale (higher=more), 
       General health scaled to 0 to 1 (higher=better),
       Highest qualification scaled to 0 to 1 (higher=higher),
       Mental wellbeing is 10 to 70 scale (lower=worse)")  
}


  
```

<!--chapter:end:index.Rmd-->

# Introduction {#Introduction .unnumbered}

Despite growing life expectancy witnessed in the last decades, in many western countries, socio-economic inequalities in health persist [@Mackenbach2012] . A voluminous body of work describing social and economic determinants of health inequalities exists, but much less is known about the impact of social policies, and specifically educational reforms, on health inequalities [@beckfield2009; @östergren2017]. Countries vary in the way in which they organize their secondary school system and allocate students within it. Some countries separate students between tracks, academic and vocational orientated schools, while others teach all students of all abilities in the same comprehensive schools, although they may stream by ability within schools. The equality impacts of the different systems are debated [@Chmielewski2014].

The purpose of this paper is to examine whether the introduction of comprehensive secondary education, using the example of Britain, has led to any change in health inequalities measured by a variety of both objective and subjective indicators. We might expect a change to a theoretically more equitable education system to reduce health inequalities in a number of ways: firstly, by more equitably distributing knowledge that reduces inequity in health literacy and ultimately health; secondly, and possibly more importantly, by reducing lifecourse inequality in other social determinants of health such as occupation, income, wealth, housing and so on that are, in part, affected by educational attainment; thirdly, through increased social cohesion that increased equality may bring.

Below we explore the theories and evidence on why a change from a selective to a comprehensive school system might impact social inequalities, and thus inequalities in health.

### The relation between education institutions and social inequalities {#The-theory-of-relation-between-education-institutions-and-social-inequalities .unnumbered}

Theories of social reproduction have long argued that the organization, selection procedures and content of the school system are very important factors in the explanation of the unequal distribution of education and labour market outcomes. In particular, the school factor which has most strongly been accused of reproducing social inequalities is track allocation; that is the allocation of pupils into different schools, or programmes of study within schools, based on student ability or performance. Tracks have different status and curriculum content: usually academic schools/programmes have higher status and lead to more advanced studies and vocational schools/programmes have lower status, a narrower curriculum and limited or no opportunity for further studies. A large number of sociological and educational studies have been devoted to analysing the role of tracking and its effect in widening, reducing or simply maintaining existing inequalities among students from different social classes [@gamoran1989; @gamoran1996; @kerckhoff1986; @oakes1985]. They generally found that low tracks restrain the educational and socio-economic attainments of disadvantaged pupils with long-term negative consequences on individuals' lives.

After the 1944 Education Act that provided for universal free secondary education, Britain had a tracked secondary school system - the tripartite system- with its distinction between grammar, technical and secondary modern school. Pupils were separated into different schools according to their ability which was determined by the results of the 11-plus exam at the end of primary school: those who achieved the best exam results gained access to grammar school, which taught a highly academic curriculum; the others attended secondary modern and, a small minority, technical schools which offered a vocationally-oriented curriculum. There were also a number of independent, fee-paying schools which selected their pupils on the basis of entry tests and financial criteria.

Critics of the tripartite system argued it reproduced societal inequalities since selection based on the 11-plus discriminated against children from disadvantage socio-economic backgrounds and resulted in their over-representation in the secondary modern schools. Indeed, the move to a comprehensive system from the mid-1960s onwards was partly advocated by the aspiration to provide more equal educational opportunities. Among the purposes of the comprehensive re-organisation of the education system were the elimination of pupils' allocation to schools through selection by ability, a reduction of between-school variation in children's intake (favouring a more diverse social mix in schools), an increase in access to educational certifications, and a reduction of social inequalities in attainment [@mcpherson1987; @kerckhoff1996].

### The empirical evidence on comprehensive education and inequalities {#The-empirical-evidence-on-comprehensive-education-and-inequalities .unnumbered}

The issue of whether comprehensive education systems are more equitable than selective education systems has been prominent in the education and social mobility literature. Some scholars have tried to answer this question by comparing countries with different degrees of differentiation of their education systems [@gorard2004; @dupriez2006; @vandewerfhorst2010; @burger2016], while others have concentrated on within-country comparisons to analyse changes in national education systems over time [@heath1990; @kerckhoff1996; @iannelli2007; @boliver2011]. In general, results from the international comparisons suggest that comprehensive systems (as those in the Scandinavian countries), where there is no selection by ability and all pupils attend the same type of schools, are more egalitarian than differentiated school systems (such as those in Germany, Austria and Switzerland), which are characterised by sorting pupils according to their ability in different school types or tracks.

Interestingly, research based on within-country comparisons has mostly concluded that the comprehensive reorganization of national education systems had little impact on reducing social inequalities in attainment and in promoting social mobility. Atkinson et al[-@atkinson2006] found that, overall, pupils in selective Local Education Authorities (LEAs) did not achieve better educational outcomes than similar pupils in non-selective LEAs. This is because while children educated in grammar schools outperformed similar children educated in comprehensive schools, non-grammar-educated children in the selective system, which mostly gathered children from less advantaged social backgrounds, underperformed them.

Examining social mobility chances in Britain, Boliver and Swift [-@boliver2011]found that the selective system was no better than the comprehensive system in improving the chances of children from disadvantaged social origins of being upwardly mobile. In Scotland, where the comprehensive reorganisation of the education system was more complete than in England, Iannelli and Paterson [-@iannelli2007] compared four cohorts born between 1937 and 1975 and found no evidence that the introduction of comprehensive education in Scotland was associated with improved social mobility. Conversely, Burgess, Dickson and MacMillan [-@burgess2019] analysed earnings inequality between people who attended the selective and the comprehensive system and found that individuals who grew up in areas operating a selective school system had a more unequal earnings distribution.

Much less explored is the issue of whether comprehensive education may lead to benefits in life domains other than education and labour market outcomes. Another social impact that comprehensive schooling has been hypothesised to have is to improve social cohesion. To test these studies have analysed the relationship between having attended comprehensive schools and individuals' civic values. As for the above-mentioned studies, cross-country comparative and single-country research reach different conclusions. While comparative research observed a positive relationship, with people who attended comprehensive systems showing more civic-minded views [@vandewerfhorst2007] , single-country analysis of longitudinal data found that those who attended selective schools tended to be more liberal, tolerant and engaged in politics than people who attended comprehensive schools [@paterson2012]. For health inequalities the evidence is equally sparse, a recent cross-national study found that adult inequality by educational achievement in self rated health was greater in European countries with more school level tracking [@Delaruelle2019].

### Reasons why comprehensive education might reduce health inequalities {#Theory-on-why-comprehensive-education-might-reduce-health-inequalities .unnumbered}

Health literacy is routinely found to be associated with more education and thus is hypothesised as one reason for socio-economic inequalities in health outcomes . It is a multidimensional concept covering seeking, comprehending and actioning health knowledge as well as the ability and power to navigate the health system effectively [@beauchamp2015; @greenhalgh2015; @vanderheide2013] . Causal studies on the relationship between education and high literacy are mixed. For example, a UK natural experiment study using changes in compulsory school leaving age did not find a causal relationship between increased leaving age and health knowledge while a similarly designed Australian study found that some, but not all, knowledge informed health behaviours were improved by increasing the school leaving age [@johnston2015; @li_does_2015].

A number of prominent theories of health inequalities predict that more equal distribution of the socio-economic determinants of health should lead to reduced health inequalities [@wilkinson2008; @towsend1990; @Phelan2010]. Fundamental theory offers an overarching theory for the persistence of health inequalities over time, place and generation. It argues that "individuals and groups deploy resources to avoid risks and adopt protective strategies. Key resources such as knowledge, money, power, prestige, and beneficial social connections can be used no matter what the risk and protective factors are in a given circumstance." [@Phelan2010, p29]. Formal education is one resource and a resource that, in part, other key resources depend on. Knowledge comes directly from education and indirectly from the learning capacity it might instil. Access to money, power and prestige are linked to occupational class and status commonly derived through obtaining educational qualifications. Thus a comprehensive school system, by improving the education and labour market outcomes of the most disadvantaged, may reduce health inequalities by narrowing the resource gap. Indeed, social mobility research in the UK has found that in the second half of the 20th century, absolute rates of mobility were high, meaning that a large number of working class children were upward mobile and entered professional and managerial occupations. This was mostly due to the expansion of professional occupations and of education participation which occurred in this period [@Goldthorpe_2004; @iannelli_social_2006]. Heller and colleagues found evidence that the changing occupational structure in the UK to more high status jobs had benefited population health in the 1990s compared to the 1970s [@heller2002]. On the other hand, and as already highlighted, research generally finds that relative social mobility did not greatly change after the switch to a largely comprehensive system. Evidence on the impact of relative social mobility on health inequalities is mixed with evidence of both a role in reducing and increasing health inequalities [@Boyle; @bartley_increasing_2007].

As highlighted, improved social cohesion is theorised as having a possible impact of moving to a comprehensive system. In health Wilkinson and Pickett's income inequality theory hypothesises "that more equal societies were healthier because they were more cohesive and enjoyed better social relations". They argue that the main biological mechanism by which social cohesion improves health is through the lowering of stress, as chronic stress can impair health. For rich countries, they argue that it is the distribution rather than the average level of socio-economic resources that is important for health [@pickett_income_2015]. So if the comprehensive system does improve social cohesion, as theorised, this could be another route through which it reduces health inequalities.

### The current study {#The-current-study .unnumbered}

One limitation of cross-country comparative studies is the difficulty in establishing causal relations between institutional features of national education systems and inequalities of outcomes. This is because national institutions and policies are embedded in and interact with broader socio-cultural contexts which greatly differ among countries. Hence we follow other researchers [@boliver2011; @paterson2012] and focus on institutional changes within one country, Britain. We exploit the fact that the old selective and the new comprehensive systems co-existed (and continue to co-exist in parts of England) and this allowed us to examine the health outcomes of young people who experienced the two systems at the same time, thus keeping constant other period and contextual effects.

Our paper aims to provide more evidence on whether the change to a more equity focus comprehensive education system reduced health inequalities by asking: did the introduction of a comprehensive education system in Britain reduce health inequalities?

<!--chapter:end:01-intro.Rmd-->

```{r 1958 variables, eval=FALSE}

##this is the NCDS's response dataset (interviewed at each wave etc.) 

df1958resp <- read_dta("UKDA-5560-stata/stata/stata11/ncds_response.dta") %>%
  as_factor() %>%
  mutate(ncdsid=as.character(NCDSID)) 
nrow(df1958resp)
nrow(distinct(df1958resp, ncdsid))


##this is the first four sweeps of the ncds . Various variables elected with more details in the variable preparation chunk.

df1958n0123 <- read_dta("UKDA-5565-stata11/stata11/ncds0123.dta") %>% 
  select(ncdsid, sex=n622, fathered=n195, mothered=n2397, n0region, n1region,
         n2region, n3region, cog11=n920, verbal11=n914, nonverbal11=n917, 
         laschtype16=n2102, nolaschtype16=n2103, n2116, n14, n875, n1175,
         n490, n492, n236, n190, n1687,
         n92, n457, n1840, n90, n2930, n2928, n20, n22, n116, n1136, n1137) %>%
  as_factor() %>%
  mutate(ncdsid=as.character(ncdsid))
nrow(df1958n0123)
nrow(distinct(df1958n0123, ncdsid))  

#this is sweep 6 of ncds (age 42) . mainly health outcomes and ethnicity (as childhood waves not well covered)

df1958n6 <- read_dta("UKDA-5578-stata9_se/stata9_se/ncds6.dta") %>% 
  select(ncdsid, hlthgen, hlthyr, smoking, ethnic, lifesat1, lifesat2) %>%
  as_factor() %>%
  mutate(ncdsid=as.character(ncdsid))
nrow(df1958n6)
nrow(distinct(df1958n6, ncdsid))  

#Paul Gregg and colleagues project (An examination of the impact of family socio-economic status on outcomes in late childhood and adolescence(ESRC Grant: RES-060-23-0011) coded class for both cohorts - http://doc.ukdataservice.ac.uk/doc/7023/mrdoc/pdf/ncds_bcs_occupation_coding.pdf . SC2 file is age 11 (fathers) and SC6 file is age 42.


df1958sc2 <-  read_dta("UKDA-7023-stata9/stata9/ncds2_occupation_coding_father.dta") %>%
  mutate(ncdsid=as.character(NCDSID)) 
nrow(df1958sc2)
nrow(distinct(df1958sc2, ncdsid))  


df1958sc6 <-  read_dta("UKDA-7023-stata9/stata9/ncds6_occupation_coding_cm.dta") %>%
  mutate(ncdsid=as.character(NCDSID)) 
nrow(df1958sc6)
nrow(distinct(df1958sc6, ncdsid))  

#this is BMI across waves from the Closer project on harmonising in the UK cohort studies body composition https://www.closer.ac.uk/research-fund-2/data-harmonisation/harmonising-measures-body-size-body-composition/

df1958bmi <-  read_dta("UKDA-8549-stata/stata/stata13/ncds_closer_wp1.dta") %>%
  select(ncdsid, visitage, bmi) %>%
  pivot_wider(names_from=visitage, values_from=bmi, names_prefix="bmi") 
summary(df1958bmi)
df1958bmi <- select(df1958bmi, -bmi0)
nrow(df1958bmi)
nrow(distinct(df1958bmi, ncdsid)) 

#This is mental wellbeing from CLoser ->  https://www.closer.ac.uk/research-fund-2/data-harmonisation/prospective-associations-childhood-environment-adult-mental-wellbeing/

df1958wemwbs <-  read_dta("UKDA-8552-stata/stata/stata13/ncds_closer_wp9.dta") %>%
  select(ncdsid, totwemwbs, parint) 
nrow(df1958wemwbs)
nrow(distinct(df1958wemwbs, ncdsid))  


#this is harmonised highest education and vocational qualifications from Bukodi and colleagues. Used in these two papers  https://www.sciencedirect.com/science/article/pii/S0276562417301415?via%3Dihub https://academic.oup.com/esr/article/29/5/1024/433770#6458025 and available via UK data archive 


df1958qualification <- 
  read_dta("UKDA-8127-stata11/stata11/ncdsqualificationshistory.dta") %>%
  select(ncdsid, agelefted, edflag58, hiallyr1:hiallyr16, hialltyp1:hialltyp16) %>%
  as_factor()   %>%
  mutate(across(.cols =hialltyp1:hialltyp16, ~fct_recode(.x, 
                                                         "No qualifications" = "1", "Sub-secondary" = "2", "Lower secondary– low performance "="3", "Lower secondary– high performance" = "4",  "Higher secondary" = "5", "Lower tertiary" = "6", "Higher tertiary" = "7", "Postgraduate"="8"))) %>%
  mutate(ncdsid=as.character(ncdsid))
nrow(df1958qualification)
nrow(distinct(df1958qualification, ncdsid)) 

df1958qualificationlong <- df1958qualification %>%
  pivot_longer(
    cols = hiallyr1:hialltyp16,
    names_to = c(".value","count"),
    names_pattern = "(^\\D+)(\\d+$)"
  ) %>%
  filter(edflag58=="Education information collected") %>%
  mutate(hiallyr=levels(hiallyr)[hiallyr]) %>%
  mutate(hiallyr=as.numeric(hiallyr)) %>%
  mutate(age=case_when(hialltyp!="No qualifications" ~ hiallyr-1958,
                       hialltyp=="No qualifications" & count==1 ~ 0)) %>%
  filter(!is.na(age))



df1958qualification16 <- frankhighestqualtoage(df1958qualificationlong, 
                                               hialltyp, hiall16, 16, ncdsid) 

df1958qualification20 <- frankhighestqualtoage(df1958qualificationlong, 
                                               hialltyp, hiall20, 20, ncdsid)  

df1958qualification38 <- frankhighestqualtoage(df1958qualificationlong, 
                                               hialltyp, hiall38, 38, ncdsid) 





###academic

df1958education <- 
  read_dta("UKDA-8127-stata11/stata11/ncdsqualificationshistory.dta") %>%
  select(ncdsid, edflag58, edyear1:edyear10, hiedtyp1:hiedtyp10) %>%
  as_factor()  %>%
  mutate(ncdsid=as.character(ncdsid))
nrow(df1958education)
nrow(distinct(df1958education, ncdsid))   

df1958educationlong <- df1958education %>%
  pivot_longer(
    cols = edyear1:hiedtyp10,
    names_to = c(".value","count"),
    names_pattern = "(^.+)(10|[1-9])"
  ) %>%
  filter(edyear!="missing") %>%
  mutate(edyear=levels(edyear)[edyear]) %>%
  mutate(edyear=as.numeric(edyear)) %>%
  mutate(age=edyear-1958)


df1958education16 <- frankhighestqualtoage(df1958educationlong, 
                                           hiedtyp, hieducation16, 16, ncdsid) 

df1958education20 <- frankhighestqualtoage(df1958educationlong, 
                                           hiedtyp, hieducation20, 20, ncdsid) 

df1958education38 <- frankhighestqualtoage(df1958educationlong, 
                                           hiedtyp, hieducation38, 38, ncdsid) 




#vocation

df1958vocation <- 
  read_dta("UKDA-8127-stata11/stata11/ncdsqualificationshistory.dta") %>%
  select(ncdsid, edflag58, vqoqyear1:vqoqyear14, hivqoqtyp1:hivqoqtyp14) %>%
  as_factor()  %>%
  mutate(ncdsid=as.character(ncdsid))
nrow(df1958vocation)
nrow(distinct(df1958vocation, ncdsid))   

df1958vocationlong <- df1958vocation %>%
  pivot_longer(
    cols = vqoqyear1:hivqoqtyp14,
    names_to = c(".value","count"),
    names_pattern = "(^\\D+)(\\d+$)"
  ) %>%
  filter(vqoqyear!="missing") %>%
  mutate(vqoqyear=levels(vqoqyear)[vqoqyear]) %>%
  mutate(vqoqyear=as.numeric(vqoqyear)) %>%
  mutate(age=vqoqyear-1958)

df1958vocation16 <- frankhighestqualtoage(df1958vocationlong, 
                                          hivqoqtyp, hivocation16, 16, ncdsid) 

df1958vocation20 <- frankhighestqualtoage(df1958vocationlong, 
                                          hivqoqtyp, hivocation20, 20, ncdsid) 

df1958vocation38 <- frankhighestqualtoage(df1958vocationlong, 
                                          hivqoqtyp, hivocation38, 38, ncdsid) 


##join it all up

df1958alled <- df1958qualification %>%
  list(df1958qualification16, df1958qualification20, df1958qualification38, df1958education16, df1958education20, df1958education38, df1958vocation16, df1958vocation20,df1958vocation38) %>%
  reduce(left_join, by="ncdsid")

rm("df1958education16", "df1958education20", "df1958education38", "df1958education", "df1958educationlong", "df1958qualification16", "df1958qualification20", "df1958qualification38", "df1958qualification", "df1958qualificationlong", "df1958vocation16", "df1958vocation20", "df1958vocation38", "df1958vocation", "df1958vocationlong")


#Here we bring together the 1958 files into one df1958 file

df1958 <- df1958resp %>% 
  list(df1958n0123, df1958sc2, df1958sc6, df1958n6,  df1958bmi, df1958wemwbs,     
       df1958alled) %>%
  reduce(left_join, by = "ncdsid")

```

```{r 1958 sample, eval=FALSE}
#sample remove dead at baseline, along with emmigrations and also immigrants with study birth dates but not born in the UK

count(df1958, OUTCME00)
df1958 <- df1958 %>%
  filter(OUTCME00=="Productive" | OUTCME00=="Non-contact")
count(df1958, OUTCME00)

count (df1958, n0region)

flow58_1 <- nrow(df1958)


count(df1958, OUTCME02)
flow58_2 <- nrow(filter(df1958, OUTCME02=="Not Issued - Dead"))
flow58_3 <- nrow(filter(df1958, OUTCME02=="Not Issued - Emigrant"))

df1958 <- df1958 %>%
  filter(OUTCME02=="Productive" | OUTCME02=="Other unproductive" | 
           OUTCME02=="Refusal" | OUTCME02=="Non-contact")
count(df1958, OUTCME02)

count (df1958, n2region)
flow58_4 <- nrow(df1958)


```

```{r 1970 variables, eval=FALSE}
##the 1970 files are a bit more disparate. 

## this is response dataset


df1970resp <- read_dta("UKDA-5641-stata11/stata11/bcs_response.dta") %>%
  as_factor() %>%
  mutate(bcsid=as.character(BCSID))

nrow(df1970resp)
nrow(distinct(df1970resp, bcsid))


levels(df1970resp$OUTCME03)

count(df1970resp, OUTCME01)
count(df1970resp, OUTCME03)


##the next three are birth sweep (I label by age of sweep hence n0)

df1970n0a <- read_dta("UKDA-2666-stata9/stata9/bcs7072a.dta") %>%
  select(bcsid, a0009, a0010, a0014, a0018, sex=a0255) %>%
  as_factor() %>%
  mutate(bcsid=as.character(bcsid))

nrow(df1970n0a)
nrow(distinct(df1970n0a, bcsid))



df1970n0b <- read_dta("UKDA-2666-stata9/stata9/bcs7072b.dta") %>%
  as_factor() %>%
  mutate(bcsid=as.character(bcsid))

nrow(df1970n0b)
nrow(distinct(df1970n0b, bcsid))


df1970n0c <- read_dta("UKDA-2666-stata9/stata9/bcs1derived.dta") %>%
  select(bcsid=BCSID, BD1REGN, BD1PSOC) %>%
  as_factor() %>%
  mutate(bcsid=as.character(bcsid))

nrow(df1970n0c)
nrow(distinct(df1970n0c, bcsid))

#these are second sweep at age 5

df1970n5b <- read_dta("UKDA-2699-stata11/stata11/f699b.dta") %>%
  select(bcsid, e195, e196, e197, e245) %>%
  mutate(bcsid=as.character(bcsid)) %>%
  mutate(e197=as_factor(.$e197)) %>%
  mutate(e245=as_factor(.$e245)) 
nrow(df1970n5b)
nrow(distinct(df1970n5b, bcsid))

df1970n5c <- read_dta("UKDA-2699-stata11/stata11/f699c.dta") %>%
  select(bcsid, f117, f087, f099, f100, f090, f091, f092, f093, f094, f095, f096, f097, f098, f119, f113) %>%
  mutate(bcsid=as.character(bcsid)) 

nrow(df1970n5c)
nrow(distinct(df1970n5c, bcsid))


df1970n5d <- read_dta("UKDA-2699-stata11/stata11/bcs2derived.dta") %>%
  select(BCSID, BD2REGN) %>%
  as_factor() %>%  
  mutate(bcsid=as.character(BCSID))
nrow(df1970n5d) 
nrow(distinct(df1970n5d, bcsid))

#these are third sweep at age ten. 

df1970n10a <- read_dta("UKDA-3723-stata11_se/stata11_se/sn3723.dta") %>%
  select(bcsid, i3504:i3644, c3_4, back10p, j251:j255, m134, m135) %>%
  mutate(back10p =as_factor(.$back10p)) %>%
  mutate(c3_4 =as_factor(.$c3_4)) %>%
  mutate(j251=as_factor(.$j251)) %>%
  mutate(j252=as_factor(.$j252)) %>%
  mutate(j253=as_factor(.$j253)) %>%
  mutate(j254=as_factor(.$j254)) %>%
  mutate(j255=as_factor(.$j255)) %>%
  mutate(m134=as_factor(.$m134)) %>%
  mutate(m135=as_factor(.$m135)) %>%
  mutate(bcsid=as.character(bcsid)) 


##something wrong here as duplicates on id, issue is missing data duplicates for these, so filtered out. 
df1970n10c <- read_dta("UKDA-3723-stata11_se/stata11_se/bcs3derived.dta") %>%
  select(bcsid=BCSID, BD3REGN) %>%
  as_factor() %>%
  mutate(bcsid=as.character(bcsid)) 
nrow(df1970n10c)
nrow(distinct(df1970n10c, bcsid))
nrow(distinct(df1970n10c, bcsid, BD3REGN))  

test1 <- df1970n10c %>%
  group_by(bcsid) %>%
  mutate(test=n()) %>%
  arrange(bcsid, BD3REGN)
rm(test1)


df1970n10c <- df1970n10c %>%
  group_by(bcsid) %>%
  mutate(test=n()) %>%
  mutate(test=test==2 & !is.na(BD3REGN)) %>%
  filter(test!=TRUE) %>%
  filter(bcsid!="")
nrow(df1970n10c)
nrow(distinct(df1970n10c, bcsid))


### these are sweep 4 (age 16) (getting the school variable that is derived and includes additional info from age 42 interviews as there was a school strike atage 16 survey)

df1970n16c <- read_dta("UKDA-3535-stata/stata/stata11_se/bcs4derived.dta") %>%
  as_factor() %>%
  select(bcsid=BCSID, BD4STYPE, BD4RREAD) %>%
  mutate(bcsid=as.character(bcsid)) 
nrow(df1970n16c)
nrow(distinct(df1970n16c, bcsid))

###these are the Paul Gregg files for NSSEC at age 10 and NSSEC at age 42 from 1970 cohort (chnage in protocol -> 30/08/2020 as same time point and lots of missing in 38 gregg file)

df1970sc3 <-  read_dta("UKDA-7023-stata9/stata9/bcs3_occupation_coding_father.dta") %>%
  mutate(bcsid=as.character(BCSID))
nrow(df1970sc3 )
nrow(distinct(df1970sc3 , bcsid))

#df1970sc8 <-  read_dta("UKDA-7023-stata9/stata9/bcs8_occupation_coding_cm.dta") %>%
#mutate(bcsid=as.character(BCSID))
#nrow(df1970sc8)
#nrow(distinct(df1970sc8 , bcsid))

##this is age 42 for lot of outcomes

df1970n42 <-  read_dta("UKDA-7473-stata11/stata11/bcs70_2012_flatfile.dta") %>%
  as_factor() %>%
  select(bcsid=BCSID, B9SMOKIG, B9HLTHGN, B9LIFST1, B9LIFST2, 
         B9DEGREE, B9DEGREE, B9UNIDGN, B9CNS8) %>%
  mutate(bcsid=as.character(bcsid))


nrow(df1970n42)
nrow(distinct(df1970n42 , bcsid))

#as with 1958 this is bmi from CLOSER

df1970bmi <-  read_dta("UKDA-8551-stata/stata/stata13/bcs70_closer_wp1.dta") %>%
  select(bcsid, visitage, bmi) %>%
  pivot_wider(names_from=visitage, values_from=bmi, names_prefix="bmi") 
summary(df1970bmi)
df1970bmi <- select(df1970bmi, -bmi0, -bmi5)

#mental wellbeing from CLOSER

df1970wemwbs <-  read_dta("UKDA-8553-stata/stata/stata13/bcs70_closer_wp9.dta") %>%
  select(bcsid, totwemwbs, parint) 


#and qualifications as with 1958

df1970qualification <- 
  read_dta("UKDA-8127-stata11/stata11/bcs70qualificationshistory.dta") %>%
  select(bcsid, agelefted, edflag70, hiallyr1:hiallyr18, hialltyp1:hialltyp18) %>%
  as_factor()   %>%
  mutate(bcsid=as.character(bcsid))
nrow(df1970qualification)
nrow(distinct(df1970qualification, bcsid)) 

df1970qualificationlong <- df1970qualification %>%
  pivot_longer(
    cols = hiallyr1:hialltyp18,
    names_to = c(".value","count"),
    names_pattern = "(^\\D+)(\\d+$)"
  ) %>%
  filter(edflag70=="Education information collected") %>%
  mutate(hiallyr=levels(hiallyr)[hiallyr]) %>%
  mutate(hiallyr=as.numeric(hiallyr)) %>%
  mutate(age=case_when(hialltyp!="No qualifications" ~ hiallyr-1970,
                       hialltyp=="No qualifications" & count==1 ~ 0)) %>%
  filter(!is.na(age))

df1970qualification16 <- frankhighestqualtoage(df1970qualificationlong, 
                                               hialltyp, hiall16, 16, bcsid) 

df1970qualification20 <- frankhighestqualtoage(df1970qualificationlong, 
                                               hialltyp, hiall20, 20, bcsid)  

df1970qualification38 <- frankhighestqualtoage(df1970qualificationlong, 
                                               hialltyp, hiall38, 38, bcsid)




###academic

df1970education <- 
  read_dta("UKDA-8127-stata11/stata11/bcs70qualificationshistory.dta") %>%
  select(bcsid, edflag70, edyear1:edyear12, hiedtyp1:hiedtyp12) %>%
  as_factor()  %>%
  mutate(bcsid=as.character(bcsid))
nrow(df1970education)
nrow(distinct(df1970education, bcsid))   

df1970educationlong <- df1970education %>%
  pivot_longer(
    cols = edyear1:hiedtyp12,
    names_to = c(".value","count"),
    names_pattern = "(^\\D+)(\\d+$)"
  ) %>%
  filter(edyear!=-1) %>%
  mutate(age=edyear-1970)

df1970education16 <- frankhighestqualtoage(df1970educationlong, 
                                           hiedtyp, hieducation16, 16, bcsid) 

df1970education20 <- frankhighestqualtoage(df1970educationlong, 
                                           hiedtyp, hieducation20, 20, bcsid) 

df1970education38 <- frankhighestqualtoage(df1970educationlong, 
                                           hiedtyp, hieducation38, 38, bcsid) 




#vocation

df1970vocation <- 
  read_dta("UKDA-8127-stata11/stata11/bcs70qualificationshistory.dta") %>%
  select(bcsid, edflag70, vqoqyear1:vqoqyear14, hivqoqtyp1:hivqoqtyp14) %>%
  as_factor()  %>%
  mutate(bcsid=as.character(bcsid))
nrow(df1970vocation)
nrow(distinct(df1970vocation, bcsid))   

df1970vocationlong <- df1970vocation %>%
  pivot_longer(
    cols = vqoqyear1:hivqoqtyp14,
    names_to = c(".value","count"),
    names_pattern = "(^\\D+)(\\d+$)"
  ) %>%
  filter(vqoqyear!="missing") %>%
  mutate(vqoqyear=levels(vqoqyear)[vqoqyear]) %>%
  mutate(vqoqyear=as.numeric(vqoqyear)) %>%
  mutate(age=vqoqyear-1970)


df1970vocation16 <- frankhighestqualtoage(df1970vocationlong, 
                                          hivqoqtyp, hivocation16, 16, bcsid) 

df1970vocation20 <- frankhighestqualtoage(df1970vocationlong, 
                                          hivqoqtyp, hivocation20, 20, bcsid) 

df1970vocation38 <- frankhighestqualtoage(df1970vocationlong, 
                                          hivqoqtyp, hivocation38, 38, bcsid) 




##join all education

df1970alled <- df1970qualification %>%
  list(df1970qualification16, df1970qualification20, df1970qualification38, df1970education16, df1970education20, df1970education38, df1970vocation16, df1970vocation20,df1970vocation38) %>%
  reduce(left_join, by="bcsid")


rm("df1970education16", "df1970education20", "df1970education38", "df1970education", "df1970educationlong", "df1970qualification16", "df1970qualification20", "df1970qualification38", "df1970qualification", "df1970qualificationlong", "df1970vocation16", "df1970vocation20", "df1970vocation38", "df1970vocation", "df1970vocationlong")

#join all files together

df1970 <- df1970resp %>% 
  list(df1970n0a, df1970n0c, df1970n16c, df1970n10a, df1970n10c,df1970n5b, df1970n5d, df1970n5c, df1970sc3, df1970n42,  df1970bmi, df1970wemwbs,     
       df1970alled) %>%
  reduce(left_join, by = "bcsid")
```

```{r 1970 sample, eval=FALSE}

##born in GB in week in 1970

count(df1970, OUTCME01)
df1970 <- df1970 %>%
  filter(OUTCME01=="Productive" | OUTCME01=="Other unproductive")

count(df1970, BD1REGN)

df1970 <- df1970 %>%
  filter(BD1REGN!="Northern Ireland" | is.na(BD1REGN))
count(df1970, BD1REGN)

flow70_1 <- nrow(df1970)


#sample # born in gb and alive and resident at time of sweep 3 (age10) 


count(df1970, OUTCME03)

flow70_2 <- nrow(filter(df1970, OUTCME03=="Dead"))
flow70_3 <- nrow(filter(df1970, OUTCME03=="Not Issued"))
df1970 <- df1970 %>%
  filter(OUTCME03=="Productive" | OUTCME03=="Other unproductive")

count(df1970, BD3REGN)
flow70_4 <- nrow(df1970)


```

```{r 1958 variable prep, eval=FALSE}

# Cognitive ability ####

###Cognitive ability measures at age 7 following guidance in this document https://cls.ucl.ac.uk/wp-content/uploads/2017/07/NCDS-user-guide-NCDS1-3-Measures-of-ability-P-Shepherd-December-2012.pdf

#Southgate Group Reading Test
#Measures:Word recognition and comprehension. Particularly suited to identifying backward readers.  
#Administration:On 16 (of 30) occasions, the child was given a picture of an object and had to ring the word describing that object. On the other 14 occasions, the teacher read out a word and the child had to circle the correct one. 
#Scoring:One mark was awarded for each correct answer, giving a score between 0 and 30


count(df1958, n92)

df1958 <- df1958 %>%
  mutate(cog7a=n92) %>%
  mutate(cog7a=levels(cog7a)[cog7a]) %>%
  mutate(cog7a=as.numeric(cog7a))         
frankcrosstab(n92, cog7a, df1958) 

#Copying Designs 
#Measures:Perceptuo-motor ability.
#Administration:Six designs were presented: a circle, square, triangle, diamond, cross and star.  The children were asked to copy each design twice.
#Scoring:One mark was awarded for each correct attempt, giving an overall score between 0 and 12 although Not all children completed two drawings of each design; therefore a score was given if at least one good copy was made of a given design.  The total score was the sum of the scores obtained on each design, thus giving a range of 0-8.  Zero score was obtained when a child attempted to copy at least one design but all attempts were judged to be poor copies.

count(df1958, n457) 
df1958 <- df1958 %>%
  mutate(cog7b=n457) %>%
  mutate(cog7b=fct_recode(cog7b, "1"="0 - 1", "11"="11 - 12")) %>%
  mutate(cog7b=levels(cog7b)[cog7b]) %>%
  mutate(cog7b=as.numeric(cog7b))         
frankcrosstab(n457, cog7b, df1958) 

#Drawing-a-Man Test
#Measures:General mental and perceptual ability, as well as other maturational aspects.
#Administration:The child was asked to draw a picture of a man.
#Scoring: Awarded a mark out of 100 according to the features that were included.

count(df1958, n1840)
df1958 <- df1958 %>%
  mutate(cog7c=n1840) %>%
  mutate(cog7c=levels(cog7c)[cog7c]) %>%
  mutate(cog7c=as.numeric(cog7c))         
frankcrosstab(n1840, cog7c, df1958) 
count(df1958, cog7c) 

#Problem Arithmetic Test
#Measures:Arithmetic
#Administration:Ten problems graded in level of difficulty.  In order to avoid penalizing the poor readers, the teachers were asked to read the problems to the children if necessary.
#Scoring: One mark was awarded for each correct answer, giving a score between 0 and 10.


count(df1958, n90)   
df1958 <- df1958 %>%
  mutate(cog7d=n90) %>%
  mutate(cog7d=levels(cog7d)[cog7d]) %>%
  mutate(cog7d=as.numeric(cog7d))         
frankcrosstab(n90, cog7d, df1958) 
count(df1958,cog7d) 


#age 11 same source as aged 7 
#General ability Test
#Measures:Mental ability
#Administration:Consisting of 40 verbal and 40 non-verbal items. Children were tested individually by teachers, who recorded the answers for the tests.  For the verbal items, children were presented with an example set of four words that were linked either logically, semantically, or phonologically. For the non-verbal tasks, shapes or symbols were used. The children were then given another set of three words or shapes or symbols with a blank. Participants were required to select the missing item from a list of five alternatives.
#Scoring: Each correct answer was rewarded with a mark, giving intermediate verbal and non-verbal scores (between 0 and 40), and a total score (between 0 and 80).
#Scores from these two sets of tests correlate strongly with scores on an IQ-type test used for secondary school selection (r=0.93, Douglas, 1964) suggesting a high degree of validity.


count(df1958, cog11)
count(df1958, verbal11)
count(df1958, nonverbal11)


df1958 <- df1958 %>% 
  mutate_at(vars(cog11, verbal11, nonverbal11), ~ levels(.)[.]) %>%
  mutate_at(vars(cog11, verbal11, nonverbal11), ~ as.numeric(.))

count(df1958, cog11)
count(df1958, verbal11)
count(df1958, nonverbal11)

###some people use factor to extract a main factor ("g") from the two scales. so done here in case may use.

pc1958 <- prcomp(~ nonverbal11 + verbal11, data = df1958, na.action = na.exclude, scale=TRUE)
summary(pc1958)
df1958$pacog11 <- pc1958$x[,c(1)]

plot(df1958$pacog11, df1958$cog11)

#standardise to 100 (sd=15)

df1958 <-df1958 %>%
  mutate(cog11=scale(cog11),
         cog11=(cog11*15)+100,
         cog11=as.numeric(cog11)) 


summarise(df1958, mean(cog11, na.rm=TRUE), sd(cog11, na.rm=TRUE))


##age16 same source as age 7 and 11, this is possible mediator
# Measures: Reading comprehension
# Administration:The child was required to choose from a selection of 5 words that which appropriately completed sentences. There were 35 questions in total
# Scoring: One mark was awarded for each correctly completed sentence, giving a total score between 0 and 35

count(df1958, n2928)
df1958 <- df1958 %>%
  mutate(cog16b=n2928) %>%
  mutate(cog16b=levels(cog16b)[cog16b]) %>%
  mutate(cog16b=as.numeric(cog16b))         
frankcrosstab(n2928, cog16b, df1958)  



#Mathematics test
#Measures: Mathematics 
#Administration: Contained both numerical and geometric questions with 27 multiple-choice questions and 4 true-or-false questions.
#Scoring: One mark was awarded for each correct answer, giving a total score between 0 and 31.

count(df1958, n2930)
df1958 <- df1958 %>%
  mutate(cog16a=n2930) %>%
  mutate(cog16a=levels(cog16a)[cog16a]) %>%
  mutate(cog16a=as.numeric(cog16a))         
frankcrosstab(n2930, cog16a, df1958)    

# School system ####
##at age7 school said whether they were local education authority school

count(df1958, n20)
count(df1958, n22)
df1958 <- df1958 %>%
  mutate(leaschool7=n22=="At LEA school")
count(df1958, leaschool7)

#In the school survey at age 16 asked about type of school and also date changed to comprehensive, from this we can construct school system in 1974 and 1969 but primary exposure is 16

# at age 16 . As asked in 1974 need to go for entry using date (n14) changed to comp
count(df1958, laschtype16)
count(df1958, nolaschtype16)
frankcrosstab(laschtype16, nolaschtype16, df1958)



count(df1958, n14)
df1958 <- df1958 %>%
  mutate(compwhen=levels(n14)[n14]) %>%
  mutate(compwhen=as.numeric(compwhen))
count(df1958, compwhen)

count(df1958, n2116)

# note -1 is not answered so I NA https://discovery.closer.ac.uk/item/uk.cls.ncds/b22207e6-f094-4378-b921-b1811729a4fd/2

df1958 <- df1958 %>%
  mutate(laschtype16=na_if(laschtype16, "Non LEA school"),
         nolaschtype16=na_if(nolaschtype16, "LEA school")) %>%
  mutate(system11=case_when(laschtype16 == "Comprehensive" & !between(compwhen,1970, 1974) ~ "Comprehensive",
                            laschtype16 == "Comprehensive" & between(compwhen,1970, 1974)  ~ "Selective",
                            laschtype16 == "Grammar" ~ "Selective", 
                            laschtype16 == "Secondary modern"  ~ "Selective",
                            laschtype16 == "Technical" ~ "Selective",
                            nolaschtype16 == "Independent sch."  ~ "Selective",
                            nolaschtype16 == "Direct-grant sch"  ~ "Selective")) %>%
  mutate(system11=case_when(is.na(system11) & !is.na(laschtype16) ~ "Other",
                            TRUE ~ system11)) %>%
  mutate(system11=as.factor(system11)) 




##based on school type 16
df1958 <- df1958 %>%
  mutate(system16=case_when(laschtype16 == "Comprehensive" ~ "Comprehensive",
                            laschtype16 == "Grammar" ~ "Selective", 
                            laschtype16 == "Secondary modern"  ~ "Selective",
                            laschtype16 == "Technical" ~ "Selective",
                            nolaschtype16 == "Independent sch."  ~ "Selective",
                            nolaschtype16 == "Direct-grant sch"  ~ "Selective")) %>%
  mutate(system16=case_when(is.na(system16) & !is.na(laschtype16) ~ "Other",
                            TRUE ~ system16)) %>%
  mutate(system16=as.factor(system16)) 


frankcrosstab(system16, laschtype16, df1958)


frankcrosstab(n875, system11, df1958)
frankcrosstab(n875, system16, df1958)


count(df1958, system16)


count(df1958, n14)
table(df1958$laschtype16, df1958$compwhen)
table(df1958$system16, df1958$compwhen)

##type in selective

df1958 <- df1958 %>%
  mutate(schooltype16= case_when(laschtype16 == "Grammar" ~ "Grammar",
                                 laschtype16 == "Secondary modern"  ~ "Secondary modern",
                                 laschtype16 == "Technical" ~ "Technical",
                                 nolaschtype16 == "Independent sch."  ~ "Independent",
                                 nolaschtype16 == "Direct-grant sch"  ~ "Direct-grant",
                                 laschtype16=="Comprehensive" ~ "Comprehensive")) %>%
  mutate(schooltype16=factor(schooltype16))



# Region ####

#This is region of residence at different waves
count(df1958, n0region)
count(df1958, n1region)
count(df1958, n2region)
count(df1958, n3region)

df1958 <- df1958 %>%
  mutate(region0=na_if(n0region, "No imformation"), 
         region1=na_if(n1region, "No imformation"), 
         region2=na_if(n2region, "No imformation"), 
         region3=na_if(n3region, "No imformation"),
         region0=na_if(region0, "Not in PMS"), 
         region1=na_if(region1, "Not in PMS"), 
         region2=na_if(region2, "Not in PMS"), 
         region3=na_if(region3, "Not in PMS"))

df1958$region0 <- fct_drop(df1958$region0)
df1958$region1 <- fct_drop(df1958$region1)
df1958$region2 <- fct_drop(df1958$region2)
df1958$region3 <- fct_drop(df1958$region3)

count(df1958, n0region)
count(df1958, n1region)
count(df1958, n2region)
count(df1958, n3region)

# Sex ####
levels(df1958$sex)
df1958 <- df1958 %>%
  mutate(sex=na_if(sex, "Not known"),
         sex=na_if(sex, "Not Stated"))
df1958$sex <- fct_drop(df1958$sex)
count(df1958, sex)

# Parents education ####

#Parents education is coded the highest of father or mother and based on age they left school, the coding follows https://www.tandfonline.com/doi/full/10.1080/01425692.2013.816031

#fathers education,  

levels(df1958$fathered)
df1958 <- df1958 %>% 
  mutate_at(vars(fathered), ~ levels(.)[.]) %>%
  mutate_at(vars(fathered), ~ as.numeric(.))
summary(df1958$fathered)
df1958 <- df1958 %>% 
  mutate(fatherlefted = case_when(fathered<=15 ~ "15 or below",
                                  between(fathered, 16, 18) ~ "16 to 18",
                                  fathered >=19 ~ "19 plus"),
         fatherlefted=factor(fatherlefted, levels=c("15 or below", "16 to 18", "19 plus"), ordered=TRUE)) 
min(df1958$fatherlefted)


count(df1958, fatherlefted) 

#mothers education 

levels(df1958$mothered)
count(df1958, mothered)
df1958 <- df1958 %>% 
  mutate(motherlefted = case_when(mothered=="under 13 yrs" ~ "15 or below",
                                  mothered=="13 to 14 years" ~ "15 or below",
                                  mothered=="14 to 15 years" ~ "15 or below",
                                  mothered=="15 to 16 years" ~ "15 or below",
                                  mothered=="16 to 17 years" ~ "16 to 18",
                                  mothered=="17 to 18 years" ~ "16 to 18",
                                  mothered=="18 to 19 years" ~ "16 to 18",
                                  mothered=="19 to 21 years" ~ "19 plus",
                                  mothered=="21 to 23 years" ~ "19 plus")) %>%
  mutate(motherlefted = factor(motherlefted, levels=c("15 or below", "16 to 18", "19 plus"), ordered=TRUE))

count(df1958, motherlefted)  


### highest ageleft

frankcrosstab(motherlefted, fatherlefted, df1958)
df1958 <- df1958 %>%
  mutate(hilefted = pmax(.$fatherlefted,.$motherlefted, na.rm=TRUE))

frankcrosstab(motherlefted, fatherlefted, df1958)
count(df1958, hilefted)

## parent educational interest
count(df1958, parint) 
df1958 <- df1958 %>%
  mutate(parint7=as_factor(.$parint)) %>%
  mutate(parint7=na_if(parint7, "Missing value - item non-response")) %>%
  mutate(parint7=na_if(parint7, "Don't know")) %>%
  mutate(parint7=na_if(parint7, "Missing value - non-response to sweep")) %>%
  mutate(parint7=factor(.$parint7, ordered=TRUE))
count(df1958, parint7)

count(df1958, n1136) 
df1958 <- df1958 %>%
  mutate(hopeleaveage11=na_if(n1136, "Not applicable")) %>%
  mutate(hopeleaveage11=fct_drop(.$hopeleaveage11)) %>%
  mutate(hopeleaveage11=fct_recode(.$hopeleaveage11, 
                                   "Leave at  minimum age" = "Leave min age",
                                   "Don't know yet" = "Dont know yet"))
count(df1958, hopeleaveage11)  

count(df1958, n1137) 
df1958 <- df1958 %>%
  mutate(hopepostschool11=na_if(n1137, "Not applicable")) %>%
  mutate(hopepostschool11=fct_drop(.$hopepostschool11)) %>%
  mutate(hopepostschool11=fct_recode(.$hopepostschool11, 
                                     "Don't know yet" = "Dont know yet"))
count(df1958, hopepostschool11)  


# Social class ####

#As our main social class measures we use the National Statistics Socio-economic classification (NS-SEC) as it is has strong theoretical roots (adopting Goldthorpe's method). Paul Gregg and colleagues coded NS-SEC for both the 1958 and 1970 cohorts. We need a ranking scale and so code to 3 class level which has this property unlike the 5 plus versions

##Age 11 - fathers only


count(df1958, N2SNSSEC)
df1958 <- df1958 %>% 
  mutate(class11 = case_when(between(N2SNSSEC, 1, 4.9) ~ "Higher managerial",
                             between(N2SNSSEC, 5, 6.9) ~ "Lower managerial",
                             between(N2SNSSEC, 7, 9.9) ~ "Intermediate",
                             between(N2SNSSEC, 10, 13.9) ~ "Routine")) %>%
  mutate(class11=ordered(class11, levels=c("Higher managerial","Lower managerial", "Intermediate", "Routine")))
count(df1958, class11) 
frankcrosstab(N2SNSSEC, class11, df1958)


#Age 42 -respondents

count(df1958, N6SNSSEC)
df1958 <- df1958 %>% 
  mutate(class42 = case_when(between(N6SNSSEC, 1, 4.9) ~ "Higher managerial",
                             between(N6SNSSEC, 5, 6.9) ~ "Lower managerial",
                             between(N6SNSSEC, 7, 9.9) ~ "Intermediate",
                             between(N6SNSSEC, 10, 13.9) ~ "Routine")) %>%
  mutate(class42=ordered(class42, levels=c("Higher managerial","Lower managerial", "Intermediate", "Routine")))
count(df1958, class42) 
frankcrosstab(N6SNSSEC, class42, df1958)


#probably not use this but coded goldthorpe scale following Connelly and Gayle - 
#https://github.com/RoxanneConnelly/Social-Class-Inequalities-in-General-Cognitive-Ability-in-Two-British-Birth-Cohorts/blob/master/JupterNotebook_20171122.ipynb

## Father's social class when respondents were 11 - EGP 7-class schema

count(df1958, n1175)
df1958 <- df1958 %>%
  mutate(egp11_7=case_when(n1175=="Emp,manag,large" ~ "Class I",		
                           n1175=="Emp,manag,small" ~ "Class II",	
                           n1175=="Prof-self-emp" ~ "Class I",		
                           n1175=="Prof-employees" ~ "Class I",				
                           n1175=="Intermed non-man" ~ "Class II",
                           n1175=="Junior non-man"	 ~  "Class III",
                           n1175=="Personal service" ~ "Class III",
                           n1175 =="Foremen-manual" ~ "Class V",
                           n1175=="Skilled manual" ~ "Class VI",
                           n1175=="Semi skld manual" ~ "Class VII",  	
                           n1175=="Unskilled manual" ~	"Class VII",		
                           n1175=="Work-own account" ~ "Class IVb+c",
                           n1175=="Farmer-emp,manag"~ "Class IVb+c",
                           n1175=="Farm-own account" ~ "Class IVb+c",
                           n1175=="Agric worker"	~ "Class VII")) %>%
  mutate(egp11_7=factor(egp11_7, ordered = TRUE))

count(df1958, egp11_7)
frankcrosstab(n1175, egp11_7, df1958)
frankcrosstab(class11, egp11_7, df1958)    

#Registrar generals social class is well coded in both cohorts so use this in imputation
## Father's social class at age 0 - rgsc

count(df1958, n236)
df1958 <- df1958 %>%
  mutate(rgsc0=n236) %>%
  mutate(rgsc0=na_if(rgsc0, "NA,NMH"),
         rgsc0=na_if(rgsc0, "Unemployed,sick")) %>%
  mutate(rgsc0=fct_drop(rgsc0)) %>%
  mutate(rgsc0=factor(rgsc0, order=TRUE))


count(df1958, rgsc0) 



## Father's social class at age 7 - rgsc

count(df1958, n190)
df1958 <- df1958 %>%
  mutate(rgsc7=na_if(n190, "NA, unclear"),
         rgsc7=na_if(rgsc7, "No male head")) %>%
  mutate(rgsc7=factor(rgsc7, order=TRUE))  %>% 
  mutate(rgsc7=fct_drop(rgsc7)) %>%
  mutate(rgsc7=fct_recode(rgsc7, IV="IV non-manual", IV="IV manual"))

count(df1958, rgsc7)

## Father's social class at age 11 - rgsc
count(df1958, n1687)
df1958 <- df1958 %>%
  mutate(rgsc11=n1687) %>%
  mutate(rgsc11=na_if(rgsc11, "NA,unclear"),
         rgsc11=na_if(rgsc11, "No male head")) %>%
  mutate(rgsc11=fct_drop(rgsc11)) %>%
  mutate(rgsc11=factor(rgsc11, order=TRUE))
count(df1958, rgsc11)

#ethnicity. As a 1958 birth cohort, the ncds is not ethnically diverse and the question wasn't covered in early waves. The coding here is very crude.

count(df1958, ethnic)
df1958 <- df1958 %>%
  mutate(ethnic42=case_when(ethnic=="British" ~ "White",
                            ethnic=="Irish"	~ 	"White",
                            ethnic== "White other"	~ "White",
                            ethnic=="White & Black Caribbean"	~ "Black",		
                            ethnic=="White & Black African"	~ "Black",
                            ethnic=="Caribbean" ~ "Black",
                            ethnic=="African" ~ "Black",
                            ethnic=="Other Black" ~ "Black",
                            ethnic=="White & Asian" ~ "Asian",
                            ethnic=="Indian" ~ "Asian",
                            ethnic=="Pakistani" ~ "Asian",
                            ethnic=="Other Asian" ~ "Asian",
                            ethnic=="Other mixed race" ~ "Other",
                            ethnic=="Other ethnic group" ~ "Other")) %>%
  mutate(ethnic42=factor(ethnic42))
count(df1958, ethnic42)		


# Outcomes ####

#loss to follow up can happen in 3 ways, 1 - not response, we are using multiple imputation for this. 2, emigration, following hernan we estimate for non emigrants 1/ pr(not emigration given confounding ) and for emigrants the weight = 0. This weight is then used to multiple confounding weight in outcome analysis. 3, death b4 age 42, there is no one satisfactory way to deal with death b4 observing outcomes, one is use the IPW as for emigration and another is to treat death as worse outcome on outcomes. 

count(df1958, OUTCME06)

df1958 <- df1958 %>%
  mutate(dead42=OUTCME06=="Not Issued - Dead") %>%
  mutate(emig42=OUTCME06=="Not Issued - Emigrant")

count(df1958, emig42) 
count(df1958, dead42) 




# Health ####

# this is general health

count(df1958, hlthgen)
df1958 <- df1958 %>%
  mutate(ghealth42=hlthgen) %>%
  mutate(ghealth42=na_if(ghealth42, "Dont know"),
         ghealth42=na_if(ghealth42, "Not answered")) %>%
  mutate(ghealth42=fct_drop(ghealth42)) %>%
  mutate(ghealth42=factor(ghealth42, order=TRUE))
count(df1958, ghealth42)

#this is smoking coded as current smoking or not
count(df1958, smoking)
df1958 <- df1958 %>%
  mutate(smoke42=case_when(smoking=="smoke cigarettes every day" ~ TRUE ,
                           smoking=="smoke cigarettes occasionally" ~ TRUE,
                           smoking=="used to smoke but dont at all now" ~ FALSE,
                           smoking=="never smoked cigarettes," ~ FALSE))
count(df1958, smoke42)




#this is the wemwbs
count(df1958, totwemwbs)
df1958 <- df1958 %>%
  mutate(wemwbs50=na_if(totwemwbs, -999)) %>%
  mutate(wemwbs50=na_if(wemwbs50, -111)) %>%
  mutate(wemwbs50=as.numeric(wemwbs50))
count(df1958, wemwbs50)

table(df1958$n2116, df1958$compwhen)
table(df1958$n2116, df1958$laschtype16)


##life satisfaction - past

# past question  - How life has turned out so far: Here is a scale from 0 to 10, 0 = Completely dissatisfied to 10 = Completely satisfied

# Future question - How do you expect to be in ten years time? Here is a scale from 0 to 10, 0 = Completely dissatisfied to 10 = Completely satisfied

count(df1958, lifesat1)
df1958 <- df1958 %>%
  mutate(lifesatnow42=na_if(lifesat1, "Dont know")) %>%
  mutate(lifesatnow42=na_if(lifesatnow42, "Not answered")) %>%
  mutate(lifesatnow42=levels(lifesatnow42)[lifesatnow42]) %>%
  mutate(lifesatnow42=as.numeric(lifesatnow42))
count(df1958, lifesatnow42)


##life satisfaction - future
count(df1958, lifesat2)
df1958 <- df1958 %>%
  mutate(lifesatfuture42=na_if(lifesat2, "Dont know")) %>%
  mutate(lifesatfuture42=na_if(lifesatfuture42, "Not answered")) %>%
  mutate(lifesatfuture42=levels(lifesatfuture42)[lifesatfuture42]) %>%
  mutate(lifesatfuture42=as.numeric(lifesatfuture42))
count(df1958, lifesatfuture42)

# bmi 
df1958 %>%
  summarise(across(starts_with("bmi"), ~mean(.x, na.rm=TRUE)))


# Education mediators ####

##this is ageleft education from Bukodi 
count(df1958,agelefted)
df1958 <- df1958 %>%
  mutate(leftedage=agelefted) %>%
  mutate(leftedage=levels(leftedage)[leftedage]) %>%
  mutate(leftedage=as.numeric(leftedage))
count(df1958,leftedage)



##these calculate from Bukodi the highest qualification at age 16, 20 and 38. The scale is based on 7 levels of academic and vocational. 
#1	No qualifications			
#2	Below O-level, NVQ 1	[Sub-secondary]			
#3	1-4 O-level passes, NVQ2	[Secondary-low performance]			
#4	5+O-level passes or 1	A-level	pass,	NVQ3, [Secondary -high performance]			
#5	2+A-level passes, [Higher secondary]			
#6	Tertiary sub-degree qualification, NVQ 4, [Lower tertiary]			
#7	Degree, NVQ 5 or 6, [Higher tertiary]			
#8  Higher degree	[postgraduate]

df1958 <- frankrecodeeducation(df1958, hiall16, edflag58, highall16) 
df1958 <- frankrecodeeducation(df1958, hiall20, edflag58, highall20) 
df1958 <- frankrecodeeducation(df1958, hiall38, edflag58, highall38) 

df1958 <- frankrecodeeducation2(df1958, hieducation16, edflag58, higheducation16) 
df1958 <- frankrecodeeducation2(df1958, hieducation20, edflag58, higheducation20) 
df1958 <- frankrecodeeducation2(df1958, hieducation38, edflag58, higheducation38) 

df1958 <- frankrecodeeducation2(df1958, hivocation16, edflag58, highvocation16) 
df1958 <- frankrecodeeducation2(df1958, hivocation20, edflag58, highvocation20) 
df1958 <- frankrecodeeducation2(df1958, hivocation38, edflag58, highvocation38) 

df1958 <- df1958 %>%
  mutate(high38 = fct_recode(highall38, "Below high lower secondary"="No qualifications",
                             "Below high lower secondary"="Sub-secondary", 
                             "Below high lower secondary"="Lower secondary– low performance ",
                             "High lower secondary" = "Lower secondary– high performance",
                             "Higher secondary or lower tertiary" ="Higher secondary",
                             "Higher secondary or lower tertiary" = "Lower tertiary",
                             "Higher tertiary" = "Higher tertiary",
                             "Higher tertiary" = "Postgraduate")) %>%
  mutate(high38=factor(high38, ordered = TRUE))


```

```{r 1970 variable prep, eval=FALSE}

# Cognition ####


#Info comes from https://cls.ucl.ac.uk/wp-content/uploads/2017/07/BCS70-Childhood-cognition-in-the-1970-British-Cohort-Study-Nov-2014-final.pdf and I drew on https://github.com/RoxanneConnelly/Social-Class-Inequalities-in-General-Cognitive-Ability-in-Two-British-Birth-Cohorts/blob/master/JupterNotebook_20171122.ipynb for coding

#Aged 5

#EPVT score
#"The English Picture Vocabulary Test (Brimer and Dunn 1962), is an Anglicised form of the well-known Peabody Picture Vocabulary Test (Dunn 1959). It consists of 56 sets of four different pictures with a particular word associated with each set of four pictures. The child is asked to indicate the one picture that corresponds to the given word, and the test proceeds with words of increasing difficulty, until the child makes five mistakes in a run of eight consecutive items. The first two words are drumand time, the last two are reeland coast. The child received 1 point for each correct answer5. 12,235 children completed the test. Scores ranged between 0-56"


count(df1970, f117) 
df1970 <- df1970 %>%
  mutate(cog5a= f117) %>%
  mutate(cog5a=na_if(cog5a, -3)) %>%
  mutate(cog5a=na_if(cog5a, -2)) %>%
  mutate(cog5a=case_when(between(cog5a, 5, 59) ~ 1*cog5a,
                         cog5a==60 ~ 56-f087,
                         cog5a==0 ~ 2)) 

mean(df1970$cog5a, na.rm=TRUE) 

### Schonell Reading Test

#"The original Schonell Reading Test7comprised of 100 words and was originally designed to assess the reading age of children between age   14+years of age. Reading age is calculated from the number of words read correctly and then compared to the child’s chronological age to see if they are reading at, below or above the level for their age.As the BCS70 children were at theyounger end of the age range when they sat the test, the length of the test was reduced to the first 50 words and reading age was not calculatedfrom performance. In addition, before the test was administered, the child’s mother was asked if she thought the child had begun to read at all.From the response options detailed in figure 10, if the mother said the child could read some words or some sentencesthe child was given a card with 50 words on it, which were read from left to right. When a child struggled with a word, they were asked to sound it out. If the child still couldn’t say what the word was, they were asked to try the next one. The test was stopped when the child made five consecutive mistakes and a score of one was awarded for each word that was read correctly."   

count(df1970, f099) 
count(df1970, f100)  

df1970 <-df1970 %>%
  mutate(cog5b=case_when(f099>=1 & f100==-3 ~ 0,
                         f100!=-3 ~ 1*f100)) %>%
  mutate(cog5b=na_if(cog5b, -2))
mean(df1970$cog5b, na.rm="TRUE")


# **Profile Test. -> scoring not clear to me so not using


## Copying Designs Test

#"The child was asked to make two copies of eight shapes. No time limit was given. For each drawing a score of 0 or 1 was allocated. As not all children completedtwo copies, a score of 1 was allocated if at least one good copy was made of a given design. The total score is the sum of the scores for the individual drawings. The test is used to assess the child’s ability to reproduce shapes,and the neatness of the drawing is therefore irrelevant. "


count(df1970, f119)
df1970 <- df1970 %>%
  mutate(cog5c=na_if(f119, -3)) %>%
  mutate(cog5c=as.numeric(cog5c))
count(df1970, cog5c)

#Human Figure Drawing Test

#"The Human Figure drawing testused was a modified version of the ‘Draw-a-Man’test originally devised by Goodenough (1926),and later developed by Harris (1963). The Harris-Goodenoughtest has been subjected to extensive evaluation as a measure of IQ, though Harris himself suggested that the test is more indicative of ‘conceptual maturity’ than IQ. This shift in emphasis gets away from the notion of unitary intelligence, and permits consideration of children’s concepts of the human figure as an index or sample of their concepts generally. The child was asked to ‘make a picture of a man or a lady’. Terms such as ‘daddy’, ‘mummy’, ‘boy’, ‘girl’, etc.,could be used if the child responded better to those. They were asked to make the best picture they could and to draw a whole person, not just a face or head. When the child had finished, if anything was not clear, the child was asked what the various parts of the drawings were and these were labelled." 


count(df1970, f113)
df1970 <- df1970 %>%
  mutate(cog5d=na_if(f113, -3)) %>%
  mutate(cog5d=na_if(cog5d, -2)) %>%
  mutate(cog5d=as.numeric(cog5d))
mean(df1970$cog5d, na.rm=TRUE)



#cognition at 10

#"Four sub-scales from the British Ability Scales (BAS) (Elliott, et al. 1979; Hill 2005) were also included at age 10, the administration of which was adapted so that it could be carried out by teachers (Elliott, Murray andPearson1978).  Verbal ability was assessed using two sub-scales:  Word Definitions and Word Similarities. Non-verbal ability was assessed using two sub-scales: Recall of Digitsand Matrices. "


## BAS Word Definitions Sub-Test

count(df1970n10a, i3504)

df1970 <- df1970 %>%
  mutate_at(vars(i3504:i3644), ~na_if(.,-6)) %>%
  mutate_at(vars(i3504:i3644), ~na_if(.,-3)) %>%
  mutate_at(vars(i3504:i3644), ~na_if(.,9)) %>%
  mutate_at(vars(i3504:i3540), ~ abs(.-2)) %>%
  mutate(baswd10na = rowSums(is.na(select(.,i3504:i3540))))  %>%
  mutate(baswd10tot=case_when(baswd10na!=37 ~ rowSums(select(.,i3504:i3540), na.rm=TRUE)))


count(df1970, i3504)
count(df1970, baswd10na)
count(df1970, baswd10tot)

## BAS Recall of Digits Sub-test
count(df1970, i3541)

df1970 <- df1970 %>%
  mutate_at(vars(i3541:i3574), ~ abs(.-2)) %>%
  mutate(basrd10na = rowSums(is.na(select(.,i3541:i3574))))  %>%
  mutate(basrd10tot=case_when(basrd10na!=34 ~rowSums(select(.,i3541:i3574), na.rm=TRUE)))


count(df1970, i3541)
count(df1970, basrd10na)
count(df1970, basrd10tot)

##BAS Matrices Sub-test
count(df1970, i3617)

df1970 <- df1970 %>%
  mutate_at(vars(i3617:i3644), ~ abs(.-2)) %>%
  mutate(basmx10na = rowSums(is.na(select(.,i3617:i3644))))  %>%
  mutate(basmx10tot=case_when(basmx10na!=28 ~ rowSums(select(.,i3617:i3644), na.rm=TRUE)))


count(df1970, i3617)
count(df1970, basmx10na)
count(df1970, basmx10tot)


# BAS Verbal Similarities Sub-test

count(df1970, i3575)
df1970 <- df1970 %>%
  mutate_at(vars(i3575:i3616), ~ abs(.-2)) %>%
  mutate(basvs10na = rowSums(is.na(select(.,i3575:i3616)))) %>%
  mutate(score1=i3575*i3576,
         score2=i3577*i3578,
         score3=i3579*i3580,
         score4=i3581*i3582,
         score5=i3583*i3584,
         score6=i3585*i3586,
         score7=i3587*i3588,
         score8=i3589*i3590,
         score9=i3591*i3592,
         score10=i3593*i3594,
         score11=i3595*i3596,
         score12=i3597*i3598,
         score13=i3599*i3600,
         score14=i3601*i3602,
         score15=i3603*i3604,
         score16=i3605*i3606,
         score17=i3607*i3608,
         score18=i3609*i3610,
         score19=i3611*i3612,
         score20=i3613*i3614,
         score21=i3615*i3616) %>%
  mutate(basvs10tot=case_when(basvs10na!=42 ~ rowSums(select(.,score1:score21), na.rm=TRUE)))





count(df1970, i3575)
count(df1970, basvs10tot)

df1970 <- df1970 %>%
  mutate(basvs10totsd = scale(basvs10tot),
         basrd10totsd = scale(basrd10tot),
         basmx10totsd = scale(basmx10tot),
         baswd10totsd = scale(baswd10tot)) 

summary(df1970$basvs10totsd) 

summary(df1970$basrd10totsd) 
summary(df1970$basmx10totsd)   
summary(df1970$baswd10totsd) 

# non verbal scale & verbal


df1970 <- df1970 %>%
  mutate(basnon10totsd=case_when(basrd10na !=  max(basrd10na, na.rm=TRUE)  & basmx10na!=max(basmx10na, na.rm=TRUE)  ~ rowSums(select(.,basrd10totsd,basmx10totsd) , na.rm=TRUE))) %>%
  mutate(basnon10totsd=scale(basnon10totsd)) %>%
  mutate(basverbal10totsd=case_when(basvs10na !=  max(basvs10na, na.rm=TRUE)  & baswd10na!=max(baswd10na, na.rm=TRUE)  ~ rowSums(select(.,basvs10totsd,baswd10totsd) , na.rm=TRUE))) %>%
  mutate(basverbal10totsd=scale(basverbal10totsd)) %>%
  mutate(bastotal10totsd=case_when(basvs10na !=  max(basvs10na, na.rm=TRUE)  & baswd10na!=max(baswd10na, na.rm=TRUE) & basmx10na!=max(basmx10na, na.rm=TRUE)  & basrd10na!=max(basrd10na, na.rm=TRUE)  ~ rowSums(select(.,basvs10totsd,baswd10totsd,basmx10totsd,basrd10totsd) , na.rm=TRUE))) %>%
  mutate(bastotal10totsd=scale(bastotal10totsd)) 


summary(df1970$basnon10totsd)
summary(df1970$basverbal10totsd)
summary(df1970$bastotal10totsd)

df1970 <- df1970 %>%
  mutate(cog10=(bastotal10totsd*15)+100,
         cog10=as.numeric(cog10))
summary(df1970$cog10)

#Age 16 as from the 1958 cohort these are possible mediators and I have chosen a  vocabulary scale (this is used to derive reading age in the original dataset) as with 1958 cohort  . There was a arithmetic test nit seems not to be deposited in data archive according to the wave file
#Vocabulary Test

# "Vocabulary was assessed using a 75-item test where each item was a word followed by a multiple-choice list from which the respondent must pick the one with the same meaning as the first word. The test got progressively harder. "

count(df1970, BD4RREAD)




# School system ####

#Age 10 for primary 

count(df1970, j252)
df1970 <- df1970 %>%
  mutate(leaschool10=case_when( j254=="Description Applies" ~ FALSE,
                                j255=="Description Applies" ~ FALSE,
                                j254=="Does Not Apply" ~ TRUE,
                                j255=="Does Not Apply" ~ TRUE)) 
count(df1970, leaschool10)  

#Age 16 for secondary  

count(df1970, BD4STYPE)

df1970 <- df1970 %>%
  mutate(system16=case_when(BD4STYPE == "Comprehensive" ~ "Comprehensive",
                            BD4STYPE == "Grammar" ~ "Selective", 
                            BD4STYPE == "Secondary Modern/Technical"  ~ "Selective",
                            BD4STYPE == "Independent Private"  ~ "Selective",
                            BD4STYPE == "Scottish LEA"  ~ "Comprehensive",
                            !is.na(BD4STYPE) & BD4STYPE!="Unknown" ~ "Other") ) %>%
  mutate(system16=factor(system16)) 


frankcrosstab(BD4STYPE, system16, df1970)

df1970 <- df1970 %>%
  mutate(schooltype16 = case_when(BD4STYPE == "Grammar" ~ "Grammar", 
                                  BD4STYPE == "Secondary Modern/Technical"  ~ 
                                    "Secondary Modern/Technical",
                                  BD4STYPE == "Independent Private"  ~ "Independent Private",
                                  BD4STYPE == "Comprehensive" ~ "Comprehensive",
                                  BD4STYPE == "Scottish LEA"  ~ "Scottish LEA"))



# Region #### 

count(df1970, BD1REGN)
df1970 <- df1970 %>%
  mutate(region1=na_if(BD1REGN, "Unknown")) %>%
  mutate(region1=fct_drop(region1))
count(df1970, region1)
frankcrosstab(region1, BD1REGN, df1970)



count(df1970, BD2REGN)
df1970 <- df1970 %>%
  mutate(region2=na_if(BD2REGN, "Unknown")) %>%
  mutate(region2=na_if(region2, "Overseas")) %>%
  mutate(region2=fct_drop(region2))

count(df1970, region2)
frankcrosstab(region2, BD2REGN, df1970)


count(df1970, BD3REGN)
df1970 <- df1970 %>%
  mutate(region3=na_if(BD3REGN, "Unknown")) %>%
  mutate(region3=fct_drop(region3))

count(df1970, region3)
frankcrosstab(region3, BD3REGN, df1970)

# Sex ####


count(df1970, SEX)
df1970 <- df1970 %>%  
  mutate(sex=SEX) %>%
  mutate(sex=na_if(sex, "Not Known")) %>%
  mutate(sex=fct_drop(sex))
count(df1970, sex)
frankcrosstab(sex, SEX, df1970) 

# Parents education ####

#father education - 
count(df1970, e196) 
df1970 <- df1970 %>%
  mutate(fatherlefted = case_when(e196 ==0 ~ "15 or below",
                                  (e196>= 1 & e196 <= 3) ~ "16 to 18",
                                  e196 >=4 ~ "19plus"))
count(df1970, fatherlefted)
frankcrosstab(fatherlefted, e196, df1970)

#mothers education                             
count(df1970, e195) 
df1970 <- df1970 %>%
  mutate(motherlefted = case_when(e195 ==0 ~ "15 or below",
                                  (e195>= 1 & e195 <= 3) ~ "16 to 18",
                                  e195 >=4 ~ "19plus"))
count(df1970, motherlefted)
frankcrosstab(motherlefted, e195, df1970)


### highest ageleft

frankcrosstab(motherlefted, fatherlefted, df1970)
df1970 <- df1970 %>%
  mutate(hilefted = pmax(.$fatherlefted,.$motherlefted, na.rm=TRUE)) %>%
  mutate(hilefted = factor(hilefted, ordered=TRUE))

frankcrosstab(motherlefted, fatherlefted, df1970)
count(df1970, hilefted)

# Social class ####

count(df1970, B3FSNSSEC)
df1970 <- df1970 %>% 
  mutate(class10 = case_when(between(B3FSNSSEC, 1, 4.9) ~ "Higher managerial",
                             between(B3FSNSSEC, 5, 6.9) ~ "Lower managerial",
                             between(B3FSNSSEC, 7, 9.9) ~ "Intermediate",
                             between(B3FSNSSEC, 10, 13.9) ~ "Routine")) %>%
  mutate(class10=ordered(class10, levels=c("Higher managerial","Lower managerial", "Intermediate", "Routine"))) 
count(df1970, class10) 
frankcrosstab(B3FSNSSEC, class10, df1970)


count(df1970, B9CNS8)
df1970 <- df1970 %>% 
  mutate(class42 = case_when(B9CNS8 =="Higher managerial and professional"
                             ~ "Higher managerial",
                             B9CNS8 == 1.1 ~ "Higher managerial",
                             B9CNS8==1.2  ~ "Higher managerial",
                             B9CNS8 == "Lower managerial and professional" 
                             ~"Lower managerial",
                             B9CNS8 == "Intermediate occupations" ~
                               "Intermediate",
                             B9CNS8 == "Small employers and own account workers"
                             ~ "Intermediate",
                             B9CNS8 ==  "Lower supervisory and technical" 
                             ~ "Intermediate", 
                             B9CNS8 ==  "Semi-routine occupations" ~ "Routine",
                             B9CNS8 ==  "Routine occupations"  ~ "Routine")) %>%                 mutate(class42=ordered(class42, levels=c("Higher managerial","Lower managerial", "Intermediate", "Routine"))) 
count(df1970, class42) 
frankcrosstab(B9CNS8, class42, df1970)

# father's at birth

count(df1970, a0014)
df1970 <- df1970 %>%
  mutate(rgsc0=a0014) %>% 
  mutate(rgsc0=na_if(rgsc0, "NK / NS")) %>%
  mutate(rgsc0=na_if(rgsc0, "Other")) %>% 
  mutate(rgsc0=na_if(rgsc0, "Unsupported")) %>%
  mutate(rgsc0=factor(rgsc0, ordered = TRUE))  %>%
  mutate(rgsc0=fct_recode(rgsc0, I="SC 1", II = "SC 2", IIINM = "SC 3 NM", IIIM= "SC 3 M", IV ="SC 4", V="SC 5"))

count(df1970,rgsc0)


# father's at five

count(df1970, e197)

df1970 <- df1970 %>%
  mutate(rgsc5=e197) %>% 
  mutate(rgsc5=na_if(rgsc5, "Not Stated")) %>%
  mutate(rgsc5=na_if(rgsc5, "Not Known")) %>% 
  mutate(rgsc5=na_if(rgsc5, "Not Applicable")) %>%  
  mutate(rgsc5=na_if(rgsc5, "Student-Volun Wk")) %>%
  mutate(rgsc5=factor(rgsc5, ordered = TRUE))  

count(df1970,rgsc5)



# father's at ten

count(df1970, c3_4)
df1970 <- df1970 %>%
  mutate(rgsc10=c3_4) %>% 
  mutate(rgsc10=na_if(rgsc10, "Insufficient data")) %>%
  mutate(rgsc10=na_if(rgsc10, "No data")) %>% 
  mutate(rgsc10=factor(rgsc10, ordered = TRUE))  
count(df1970,rgsc10)


##egp10_7 - connelly
count(df1970, back10p)

df1970 <- df1970 %>%
  mutate(egp10_7=case_when(back10p=="11" ~ "Class I",		
                           back10p=="12" ~ "Class I",	
                           back10p=="30" ~ "Class I",		
                           back10p=="40" ~ "Class I",				
                           back10p=="21" ~ "Class II",
                           back10p=="22" ~ "Class II",
                           back10p=="51" ~ "Class II",
                           back10p=="52" ~ "Class II",
                           back10p=="60" ~ "Class III",
                           back10p=="70" ~ "Class III",
                           back10p=="120" ~ "Class IVb+c",
                           back10p=="130" ~ "Class IVb+c",
                           back10p=="140" ~ "Class IVb+c",
                           back10p=="80" ~ "Class V",
                           back10p=="90" ~ "Class VI",
                           back10p=="100" ~ "Class VII",
                           back10p=="110" ~ "Class VII",                        
                           back10p=="150" ~ "Class VII")) %>%
  mutate(egp10_7=factor(egp10_7, ordered = TRUE))

count(df1970, egp10_7)
frankcrosstab(egp10_7, back10p, df1970)

# Ethnicity ####
count(df1970, e245) 
df1970 <- df1970 %>%
  mutate(ethnic5=case_when(e245=="European UK" ~  "European UK / Other",
                           e245=="European Other" ~ "European UK / Other",
                           e245=="West Indian" ~ "West Indian / African",
                           e245=="Indian-Pakistani" ~ "Indian / Pakistani / other Asian",
                           e245=="Other Asian" ~ "Indian / Pakistani / other Asian",
                           e245=="African" ~ "West Indian / African",
                           e245=="Other" ~ "Other")) %>%
  mutate(ethnic5=factor(ethnic5))  
count(df1970, ethnic5)

# Health ####

### general health

count(df1970,B9HLTHGN)
df1970 <- df1970 %>%
  mutate(ghealth42=B9HLTHGN) %>% 
  mutate(ghealth42=na_if(ghealth42, "Refused")) %>%
  mutate(ghealth42=na_if(ghealth42, "Don't know")) %>% 
  mutate(ghealth42=na_if(ghealth42, "Not applicable")) %>%
  mutate(ghealth42=factor(ghealth42, ordered = TRUE))  
count(df1970,ghealth42)


### smoking

count(df1970, B9SMOKIG)
df1970 <- df1970 %>%
  mutate(smoke42=case_when(B9SMOKIG== "Have never smoked cigarettes"	~ FALSE, 
                           B9SMOKIG=="Used to smoke cigarettes but don't now" ~ FALSE,
                           B9SMOKIG=="Smoke cigarettes occasionally"	 ~ TRUE,
                           B9SMOKIG=="Smoke cigarettes every day"	 ~ TRUE))
count(df1970, smoke42)




count(df1970, smoke42)
##WEMWBS
count(df1970, totwemwbs)
df1970 <- df1970 %>%
  mutate(wemwbs42=na_if(totwemwbs, -999)) %>%
  mutate(wemwbs42=na_if(wemwbs42, -111)) %>%
  mutate(wemwbs42=as.numeric(wemwbs42))
count(df1970, wemwbs42)

#bmi
df1970 %>%
  summarise(across(starts_with("bmi"), ~mean(.x, na.rm=TRUE)))


# parent educational interest ####
count(df1970, parint) 
df1970 <- df1970 %>%
  mutate(parint10=as_factor(.$parint)) %>%
  mutate(parint10=na_if(parint10, "Missing value - item non-response")) %>%
  mutate(parint10=na_if(parint10, "Don't know")) %>%
  mutate(parint10=na_if(parint10, "Missing value - non-response to sweep")) %>%
  mutate(parint10=factor(.$parint10, ordered=TRUE))
count(df1970, parint10)

count(df1970, m134) 
df1970 <- df1970 %>%
  mutate(hopeleaveage10=na_if(m134, "BLANK")) %>%
  mutate(hopeleaveage10=na_if(hopeleaveage10, "NOT STATED")) %>%
  mutate(hopeleaveage10=na_if(hopeleaveage10, "NOT KNOWN")) %>%
  mutate(hopeleaveage10=na_if(hopeleaveage10, "NOT APPLICABLE")) %>%
  mutate(hopeleaveage10=fct_recode(.$hopeleaveage10, "16 years old" = "16 YEARS", 
                                   "17 years old" = "17 YEARS",
                                   "18 years old" = "18 YEARS")) %>%
  mutate(hopeleaveage10=fct_drop(.$hopeleaveage10))
count(df1970, hopeleaveage10) 

count(df1970, m135) 
df1970 <- df1970 %>%
  mutate(hopepostschool10=na_if(m135, "BLANK")) %>%
  mutate(hopepostschool10=na_if(hopepostschool10, "NOT STATED")) %>%
  mutate(hopepostschool10=na_if(hopepostschool10, "NOT APPLICABLE")) %>%
  mutate(hopepostschool10=fct_recode(.$hopepostschool10, "Yes" = "YES", 
                                     "No" = "NO",
                                     "Cannot say" = "CANNOT SAY")) %>%
  mutate(hopepostschool10=fct_drop(.$hopepostschool10)) 
count(df1970, hopepostschool10)

##life satisfaction 

count(df1970, B9LIFST1)
df1970 <- df1970 %>%
  mutate(lifesatnow42=na_if(B9LIFST1, "Don't want to answer")) %>%
  mutate(lifesatnow42=na_if(lifesatnow42, "Don't know")) %>%
  mutate(lifesatnow42=na_if(lifesatnow42, "Not applicable")) %>%
  mutate(lifesatnow42=fct_recode(lifesatnow42,"0" = "Completely dissatisfied", 
                                 "10" = "Completely satisfied")) %>%
  mutate(lifesatnow42=levels(lifesatnow42)[lifesatnow42]) %>%
  mutate(lifesatnow42=as.numeric(lifesatnow42))
count(df1970, lifesatnow42)

count(df1970, B9LIFST2)
df1970 <- df1970 %>%
  mutate(lifesatfuture42=na_if(B9LIFST2, "Don't want to answer")) %>%
  mutate(lifesatfuture42=na_if(lifesatfuture42, "Don't know")) %>%
  mutate(lifesatfuture42=na_if(lifesatfuture42, "Not applicable")) %>%
  mutate(lifesatfuture42=fct_recode(lifesatfuture42,"0" = "Completely dissatisfied", 
                                    "10" = "Completely satisfied")) %>%
  mutate(lifesatfuture42=levels(lifesatfuture42)[lifesatfuture42]) %>%
  mutate(lifesatfuture42=as.numeric(lifesatfuture42))
count(df1970, lifesatfuture42)                                                 



# Education mediators ####


###school qual etc 
count(df1970,agelefted)
df1970 <- df1970 %>%
  mutate(leftedage=na_if(agelefted, "-1")) %>%
  mutate(leftedage=levels(leftedage)[leftedage]) %>%
  mutate(leftedage=as.numeric(leftedage)) 
count(df1970,leftedage)

#education


df1970 <- frankrecodeeducation(df1970, hiall16, edflag70, highall16) 
df1970 <- frankrecodeeducation(df1970, hiall20, edflag70, highall20) 
df1970 <- frankrecodeeducation(df1970, hiall38, edflag70, highall38) 

df1970 <- frankrecodeeducation2(df1970, hieducation16, edflag70, higheducation16) 
df1970 <- frankrecodeeducation2(df1970, hieducation20, edflag70, higheducation20) 
df1970 <- frankrecodeeducation2(df1970, hieducation38, edflag70, higheducation38) 

df1970 <- frankrecodeeducation2(df1970, hivocation16, edflag70, highvocation16) 
df1970 <- frankrecodeeducation2(df1970, hivocation20, edflag70, highvocation20) 
df1970 <- frankrecodeeducation2(df1970, hivocation38, edflag70, highvocation38) 



df1970 <- df1970 %>%
  mutate(high38 = fct_recode(highall38, "Below high lower secondary"="No qualifications",
                             "Below high lower secondary"="Sub secondary", 
                             "Below high lower secondary"="Lower secondary-low performance",
                             "High lower secondary" = "Lower secondary-high performance",
                             "Higher secondary or lower tertiary" ="Higher secondary",
                             "Higher secondary or lower tertiary" = "Lower tertiary",
                             "Higher tertiary" = "Higher tertiary",
                             "Higher tertiary" = "Postgraduate")) %>%
  mutate(high38=factor(high38, ordered = TRUE))

```


```{r summary 1958, eval=FALSE}


df1958b4imp <- df1958 %>%
  select(ncdsid, system16, schooltype16, leaschool7 , cog11, cog7a, cog7b, cog7c, cog7d, 
         region0, region1,
         region2, sex, hilefted, class11, rgsc0, rgsc7, rgsc11, egp11_7, class42,
         ethnic42, ghealth42, parint7, bmi7, bmi11, bmi16, bmi23, bmi33, bmi42, bmi44,           wemwbs50, smoke42, lifesatnow42, lifesatfuture42, leftedage, high38,
         higheducation38, highvocation38, 
         hopeleaveage11, hopepostschool11) %>%
  mutate(expmiss16 = complete.cases(select(., system16))) 

s11df1958b4imp <- df1958 %>%
  select(ncdsid, system11, schooltype16, leaschool7 , cog11, cog7a, cog7b, cog7c, cog7d, 
         region0, region1,
         region2, sex, hilefted, class11, rgsc0, rgsc7, rgsc11, egp11_7, class42,
         ethnic42, ghealth42, parint7, bmi7, bmi11, bmi16, bmi23, bmi33, bmi42, bmi44,           wemwbs50, smoke42, lifesatnow42, lifesatfuture42, leftedage, high38,
         higheducation38, highvocation38, 
         hopeleaveage11, hopepostschool11) %>%
  mutate(expmiss16 = complete.cases(select(., system11))) 


saveRDS(df1958b4imp, "df1958b4imp.rds")

saveRDS(s11df1958b4imp, "s11df1958b4imp.rds")

```


```{r summary 1970, eval=FALSE}
##### 1970
df1970b4imp <- df1970 %>%
  select(bcsid, system16, schooltype16, leaschool10, cog10, cog5a, cog5b, cog5c, cog5d, 
         region1, region2, region3, sex, hilefted, class10, rgsc0, rgsc5, rgsc10,
         egp10_7, class42, ethnic5, ghealth42, parint10, bmi10, bmi16, bmi26, bmi30, 
         bmi34, bmi42, wemwbs42, smoke42, lifesatnow42, lifesatfuture42, leftedage,
         high38, higheducation38, highvocation38, 
         hopeleaveage10, hopepostschool10 ) %>%
  mutate(expmiss16= complete.cases(select(., system16))) 

saveRDS(df1970b4imp, "df1970b4imp.rds")  



rm(list = setdiff(setdiff(ls(), lsf.str()), "theme_dotplot"))
gc()

```



<!--chapter:end:datasetup.Rmd-->

# Methods {#Methods .unnumbered}

A protocol for the study was registered before analysis of the outcome data was undertaken (<https://osf.io/vt46r> ).

### Design {#Design .unnumbered}

To obtain an average population effect of school system on health and health inequalities we contrasted the outcomes between the Comprehensive and Selective systems using observational data. Given the lack of randomisation in school system allocation we controlled for individuals pre secondary school characteristics associated with both school type and later health including sex, ethnicity, region of residence, cognitive ability and childhood socio-economic circumstances. We did this by modelling school system probability as a function of the confounders. From these probabilities we calculated inverse probability weights to try to balance the confounders across the two school systems [@Hernan]. In our main analysis we used Superlearner to select the best balancing weights from three methods of fitting the models of school system (logistic regression, generalized additive model and generalized linear model via penalized maximum likelihood) [@Pirracchio2015]. In sensitivity analysis we also separately modelled school system as a function of confounders using a generalized boosted model and entropy balancing.

### Data {#Data .unnumbered}

We used data from two UK longitudinal birth cohorts that have surveyed one week of births from 1958 and 1970 regularly throughout their lives. The 1958 cohort is known as the National Child Development Study and the 1970 as the British Birth Cohort Study, for ease we refer to them as the 1958 and 1970 cohorts respectively.

We used data from both cohorts because while the first cohort went to school during the transition from a selective to a comprehensive system, the second cohort experienced a more 'mature' comprehensive system. Indeed, in Scotland and Wales, by 1980 almost all pupils in state-funded schools were attending schools that were comprehensive while in England some areas retained a selective system of secondary school [@croxford2004] . This allowed us to test the robustness of our results and to reach more confident conclusions.

Both cohorts are described in detail elsewhere [@power2006] [@elliott2006]. The cohorts are regularly surveyed as were their parents and schools in childhood. Both cohorts added a small number of immigrants to the UK, who were born in the same week outside the UK, by tracing through their schools [@power2006] [@elliott2006] but we exclude this group as their school age data is often missing. Additionally we exclude the small number of respondents born in Northern Ireland as they were not followed into adulthood. So our sample in both cohorts was those born, alive and living in Great Britain at the survey wave just before secondary school (aged 10 in 1970 and aged 11 in 1958) .

#### Exposure {#Expsoure .unnumbered}

Our exposure is the selective system (grammar, private and secondary modern schools) versus the comprehensive system. In the 1958 and 1970s study school type was reported at age 16 (end of compulsory secondary schooling) rather than age 11 (start of secondary schooling). Especially in the 1958 cohort, schools may have converted to being a comprehensive after the cohort member started secondary school. As the 1958 cohort reports the year the school changed to a comprehensive we conducted sensitivity analysis using school type at age 11 in this cohort. In the 1970 cohort there was a teachers' strike during the age 16 wave of data collection effecting the level of response, so the cohort was asked about secondary school type at age 42 as well to supplement the age 16 data.

#### Outcome measures {#Outcome-measures .unnumbered}

##### Health and wellbeing {#Health-and-wellbeing .unnumbered}

Our six health and wellbeing outcomes are body mass index (BMI), smoking behaviour, self rated health, wellbeing measured using the Warwick-Edinburgh Mental Wellbeing Scale (WEMWBS) and life satisfaction (past and future).They were all collected when cohort members were aged 42 with the exception of WEMWBS which was collected at age 50 for the 1958 cohort.

We choose two health behaviours as it has been hypothesised that fundamental theory will apply more strongly for preventable causes of disease. Both the health impact of excess body fat and smoking have been known for some time. Self rated general health is an established measure of general health that predicts mortality, although there remains debate about what exactly it captures and how this varies by context [@Jylha2009] . The WEMWBS scale captures the following aspects of mental wellbeing in a single construct: "hedonic and eudaimonic aspects, positive affect, satisfying interpersonal relationships and positive functioning" [@Tennant2007]. Life satisfaction is a widely used evaluative measure of well-being, and is used by government as one measure of national well-being in England and Wales [@Tinkler2011]. BMI at baseline will be used as a negative control in sensitivity analysis [@lipsitch2010]. We used outcome data from cross-cohort harmonised datasets designed for comparative analysis of our cohorts when this was available [@wood2019] [@hardy2019].

##### Social class {#Social-class .unnumbered}

Parental social class was measured when cohort members were aged 10 or 11. We refer to this as origin social class. Cohort members' adult social class (destination social class) was measured at age 42. As our measure of social class we used the UK's National Statistics Socio-economic classification of occupations (NS-SEC) [@ons2016] . We used the NS-SEC codes derived for comparative analysis by a previous cross-cohort project [@morris2012]. As this did not have age 42 NS-SEC coding for the 1970 project we used NS-SEC coding provided by the 1970 study team instead. Our measure of inequality requires an ordered measure of social class . We used the three category ordered version of NS-SEC [@ons2016], and further split the most advantaged category into two. Thus, we use the following four category ordered classes : higher managerial and professional occupations, lower managerial and professional occupations , intermediate occupations, routine and manual occupations [@duta2020] .

##### Education {#Education .unnumbered}

Using education files created for comparative analysis across our cohorts we included the age of leaving full time education and highest qualification by age 38 as outcomes and potential mediators of any relationship between school system and health inequality. Those with highest qualifications of 1--4 O-level passes, NVQ 2 or below (including no qualifications) were coded as "below high lower secondary". "High lower secondary" included those with the highest qualifications of 5+ O-level passes or 1 A-level pass or NVQ 3. "Higher secondary or lower tertiary" covered those with tertiary level sub-degree qualifications, NVQ 4 or 2+ A-level passes. Finally those with a degree or NVQ 5 and above were coded "higher tertiary" [@Bourne2018].

#### Confounders {#Confounders .unnumbered}

We choose factors at baseline that could influence the school system attended and later health. These were region of residence, cognitive ability, sex, ethnicity, origin social class , parental education and interest in their child's education (reported by teachers), and whether the pupil attended a state funded primary school. Table 1 lists the categories of these confounders. Region of residence recorded at baseline used standard region classifications in operation at the time and varied slightly between the cohorts. Ethnicity was captured at age 42 in the 1958 cohort as it was not well covered in childhood surveys, and at age 5 in the 1970 cohort. Low prevalence of some ethnicities in both cohorts meant quite broad categories were used. In the selective system the type of school one attended (academic or vocational focused) was based on an entrance exam taken at the end of primary schooling. While not the test themselves the 1958 and 1970 cohorts took similar cognitive ability tests at age 11 and 10 respectively that correlate highly with the school admission tests [@shepherd2012; @parsons2014]. The 1958 cohort test was the General Ability teacher administered test that consisted of 40 verbal and 40 non-verbal questions [@shepherd2012]. Pupils' verbal and non-verbal abilities were tested in the 1970 cohort through the use of four sections of the British Ability Scores test. Again the test was teacher administered [@parsons2014]. For both cohorts we standardised the scales to have a mean of 100 and standard deviation of 15. Parental education was based on the highest of either parents' age at leaving school. From a cross-cohort dataset derived for comparative analysis we included primary schools' rating of parents' interest in their child's education at age 7 for the 1958 cohort and age 10 for the 1970 cohort [@wood2019]. Finally, parents were asked when their child was aged 11 in the 1958 cohort and age 10 in the 1970 cohort what age they thought their child would leave school and if they hoped they would stay in education post school.

#### Analysis {#Analysis .unnumbered}

Our main outcome measure is social class inequalities in the health outcomes. As our measure of inequality we used the concentration index [@Erreygers2011]. This measures deviation from the line of equality where the ranked share of socio-economic groups in the population have equal share of the health outcome. It is related to the slope and relative index of inequality also commonly used in studies of health inequalities [@kjellsson2015]. Three measures will be studied: absolute inequality, and "attainment" and "shortfall" relative inequality. There are two measures of relative inequality as the results can vary depending on whether the outcome is coded as positive (attainment) or negative (shortfall) health [@Sogaard2019].

Regression was used to calculate the concentration index as is commonly done. The independent variable is the socio-economic measure we are using to assess inequality. The socio-economic measure is ranked from the most disadvantaged to the most advantaged with each group coded at the mid-point of their ranked cumulative proportion [@ODonnell2016]. For example if our socio-economic measure is social class with five ranked class groups of equal size, the groups would be coded from disadvantaged to advantaged as 0.1, 0.3, 0.5, 0.7, 0.9.

The dependent variable is the health outcome (or other outcome of interest). First, each of our outcomes was recoded as both positive (attainment), from worse to best, and negative (shortfall), best to worse. This is because the relative index can vary depending on whether positive or negative health is studied. Each outcome was then scaled to 0 to 1 to make the concentration index independent (scale invariant) of the different measurement scales of the outcomes [@Erreygers2011]. For the relative concentration indices the outcome is then multiplied by twice the variance of the independent variable (i.e. the recoded socio-economic variable described in the last paragraph). It is then divided by the mean of the outcome. [@ODonnell2016]. For the absolute measure, the relative dependent variable is multiplied by 4 times the mean of the outcome [@ODonnell2016].

To calculate the concentration indices the dependent and independent variables described above are entered as continuous variables in a linear regression. To assess whether the index varies by school system we interacted the independent variable with a dummy variable for school system [@ODonnell2016].

All calculations included the inverse probability weights to control for confounding.

#### Missing data {#Missing-data .unnumbered}

As with any cohort study missing data due to attrition (non-response to survey) and item non-response are common in both cohorts. We used a two stage MI / IPW approach to address it [@Seaman2012]. Details in Supplement 1.

#### Software {#Software-and-code .unnumbered}

For the analysis we used R [@r] with Rstudio [@rstudio2020]. We made use of a number of user written packages for R, these are listed in Supplement 9. 

```{r imputation, eval=FALSE}
# 1958 ####

df1958b4imp <- readRDS("df1958b4imp.rds")

number <- df1958b4imp %>%
   mutate(test=nrow(.)) %>%
 filter(complete.cases(system16, cog11, region2, sex, hilefted, class11, 
                       leaschool7, parint7, ethnic42,
                       hopeleaveage11, hopepostschool11)) %>%
mutate(number=1-round(nrow(.) / test, 2)) %>%
summarise(number=mean(number)*100)  


 


impdf1958 <- df1958b4imp %>%
 select(system16, cog11, region2, sex, hilefted, class11, leaschool7, parint7, ethnic42, 
        cog7a, cog7b, cog7c, cog7d, region0, region1, bmi42, wemwbs50, smoke42,lifesatnow42, 
        lifesatfuture42, leftedage, high38, class42, rgsc0, rgsc7, 
        hopeleaveage11, hopepostschool11, ghealth42) 
remove(df1958b4imp)

impdf1958<-mice(impdf1958, maxit=10, m=number$number, seed=483596, 
     defaultMethod = c("pmm", "logreg", "pmm", "pmm"))

saveRDS(impdf1958, "impdf1958.rds")

converge1958imp <- plot(impdf1958)

converge1958imp

# 1958 - system 11 ####

s11df1958b4imp <- readRDS("s11df1958b4imp.rds")

s11number <- s11df1958b4imp %>%
   mutate(test=nrow(.)) %>%
 filter(complete.cases(system11, cog11, region2, sex, hilefted, class11, 
                       leaschool7, parint7, ethnic42,
                       hopeleaveage11, hopepostschool11)) %>%
mutate(number=1-round(nrow(.) / test, 2)) %>%
summarise(number=mean(number)*100)  
 


s11impdf1958 <- s11df1958b4imp %>%
 select(system11, cog11, region2, sex, hilefted, class11, leaschool7, parint7, ethnic42, 
        cog7a, cog7b, cog7c, cog7d, region0, region1, bmi42, wemwbs50, smoke42,lifesatnow42, 
        lifesatfuture42, leftedage, high38, class42, rgsc0, rgsc7, 
        hopeleaveage11, hopepostschool11, ghealth42) 
remove(s11df1958b4imp)

s11impdf1958<-mice(s11impdf1958, maxit=10, m=s11number$number, seed=483596, 
     defaultMethod = c("pmm", "logreg", "pmm", "pmm"))

saveRDS(s11impdf1958, "s11impdf1958.rds")






# 1970 ####

df1970b4imp <- readRDS("df1970b4imp.rds")

number <- df1970b4imp %>%
  mutate(test=nrow(.)) %>%
  filter(complete.cases(system16, cog10, region3, sex, hilefted, class10, 
                        leaschool10, parint10, ethnic5,
                        hopeleaveage10, hopepostschool10)) %>%
  mutate(number=1-round(nrow(.) / test, 2)) %>%
  summarise(number=mean(number)*100)




impdf1970 <- df1970b4imp %>%
  select(system16, cog10, region3, sex, hilefted, class10, 
         leaschool10, parint10, ethnic5,
         hopeleaveage10, hopepostschool10,
         cog5a, cog5b, cog5c, cog5d, region1, region2,
         rgsc0, rgsc5, bmi42, wemwbs42, smoke42,lifesatnow42, 
         lifesatfuture42, leftedage, high38, class42,
          ghealth42) 
remove(df1970b4imp)

impdf1970<-mice(impdf1970, maxit=10, m=number$number, seed=7340873, 
                defaultMethod = c("pmm", "logreg", "pmm", "pmm"))

saveRDS(impdf1970, "impdf1970.rds")
```

```{r imputation figures, eval=FALSE}


impdf1970 <- readRDS("impdf1970.rds")
  converge1970imp <- plot(impdf1970, y=c("cog10"))

converge1970imp


impdf1958 <- readRDS("impdf1958.rds")
  converge1958imp <- plot(impdf1958, y=c("cog11"))

converge1958imp

# 1958 missing b4 and after    ####

longimpdf1958all <- complete(impdf1958, "long", include = TRUE ) %>%
  mutate(leaschool7=case_when(leaschool7==0 ~ "No",
                              leaschool7==1 ~ "Yes"))

misstable1958 <- longimpdf1958all %>%
  filter(system16!="Other") %>%
  filter(.imp==0) %>%
  select("leaschool7", "region2", "sex", "hilefted", "class11", "parint7", "ethnic42", "hopeleaveage11", "hopepostschool11", "system16", "cog11") %>%
  sumtable(.) 
misstable1958_1 <- longimpdf1958all %>%
  filter(system16!="Other") %>%
  filter(.imp!=0) %>%
  select("leaschool7", "region2", "sex", "hilefted", "class11", "parint7", "ethnic42", "hopeleaveage11", "hopepostschool11", "system16", "cog11", ".imp") %>%
  split(.$.imp) %>%
  map_dfr(~sumtable(.x), .id = "group") %>%
  group_by(variable, value) %>%
  filter(variable!=".imp") %>%
  summarise(across(c(n, pc), ~mean(.x)))

misstable1958 <- misstable1958 %>% 
  full_join(misstable1958_1, by=c("variable", "value"), suffix = c("_b4imp", "_aftimp")) %>%
      mutate(variable=(case_when(variable=="leaschool7" ~ "State primary school",
                             variable=="cog11" ~ "Cognitive ability", 
                             variable=="region2" ~ "Region of residence",
                             variable=="sex" ~ "Sex",
                             variable=="hilefted" ~ "Age parent left education",
                             variable=="class11" ~ "Father's NSSEC",
                          variable=="parint7" ~ "Parents interest in school rated by school",
                        variable=="hopeleaveage11" ~ "When parents hope will levave school",
                variable=="hopepostschool11" ~ "Parents hope stays in education post school",
                variable=="ethnic42" ~ "Ethnicity",
                variable=="system16" ~ "School system")))  %>%
  mutate(across(starts_with("n"), ~round(.x))) %>%
  mutate(across(starts_with("pc"), ~round(.x, 1))) %>%
flextable(.) %>%
   merge_v(., j="variable") %>%
   colformat_char(., j= "value", na_str="Missing") %>%
   set_header_labels(variable="",
                    value="",
                    n_b4imp="N",
                    pc_b4imp="%",
                    n_aftimp="N",
                    pc_aftimp="%") %>%
  add_header_row(values=c("", "Before MI", "After MI"), 
                 colwidths = c(2,2,2)) %>%
  align_text_col(., align="left") %>%
  align_nottext_col(., align="center") %>%
  autofit(.)

# 1970 missing b4 and after    ####

longimpdf1970all <- complete(impdf1970, "long", include = TRUE ) %>%
  mutate(leaschool7=case_when(leaschool10==0 ~ "No",
                              leaschool10==1 ~ "Yes"))

misstable1970 <- longimpdf1970all %>%
  filter(system16!="Other") %>%
  filter(.imp==0) %>%
  select("leaschool10", "region3", "sex", "hilefted",  "class10", "parint10", "ethnic5", "hopeleaveage10", "hopepostschool10", "system16", "cog10") %>%
  sumtable(.) 
misstable1970_1 <- longimpdf1970all %>%
  filter(system16!="Other") %>%
  filter(.imp!=0) %>%
  select("leaschool10", "region3", "sex", "hilefted",  "class10", "parint10", "ethnic5", "hopeleaveage10", "hopepostschool10", "system16", "cog10", ".imp") %>%
  split(.$.imp) %>%
  map_dfr(~sumtable(.x), .id = "group") %>%
  group_by(variable, value) %>%
  filter(variable!=".imp") %>%
  summarise(across(c(n, pc), ~mean(.x)))

misstable1970 <- misstable1970 %>% 
  full_join(misstable1970_1, by=c("variable", "value"), suffix = c("_b4imp", "_aftimp")) %>%
  mutate(variable=(case_when(variable=="leaschool10" ~ "State primary school",
                             variable=="cog10" ~ "Cognitive ability", 
                             variable=="region3" ~ "Region of residence",
                             variable=="sex" ~ "Sex",
                             variable=="hilefted" ~ "Age parent left education",
                             variable=="class10" ~ "Father's NSSEC",
                             variable=="parint10" ~ "Parents interest in school rated by school",
                             variable=="hopeleaveage10" ~ "When parents hope will levave school",
                             variable=="hopepostschool10" ~ "Parents hope stays in education post school",
                             variable=="ethnic5" ~ "Ethnicity",
                             variable=="system16" ~ "School system")))  %>%
  mutate(across(starts_with("n"), ~round(.x))) %>%
  mutate(across(starts_with("pc"), ~round(.x, 1))) %>%
  flextable(.) %>%
  merge_v(., j="variable") %>%
  colformat_char(., j= "value", na_str="Missing") %>%
  set_header_labels(variable="",
                    value="",
                    n_b4imp="N",
                    pc_b4imp="%",
                    n_aftimp="N",
                    pc_aftimp="%") %>%
  add_header_row(values=c("", "Before MI", "After MI"), 
                 colwidths = c(2,2,2)) %>%
  align_text_col(., align="left") %>%
  align_nottext_col(., align="center") %>%
  autofit(.)

saveRDS(misstable1958, "misstable1958.RDS")
saveRDS(misstable1970, "misstable1970.RDS")


rm(list = setdiff(setdiff(ls(), lsf.str()), "theme_dotplot"))
gc()


```

<!--chapter:end:02-method.Rmd-->


```{r super, eval=FALSE}
prepfiles(model="supermodel", system58=system16, system70=system16, impexp=TRUE)


superoutcomes <- getoutcomes(misswt2=TRUE, system58=system16, system70=system16)

saveRDS(superoutcomes, "superoutcomes.RDS")

superoutcomesED <- getoutcomesED(misswt2=TRUE)

saveRDS(superoutcomesED, "superoutcomesED.RDS")

superoutcomesBMI <- getoutcomesBMI(misswt2=TRUE)

saveRDS(superoutcomesBMI, "superoutcomesBMI.RDS")

superoutcomesCOG <- getoutcomesCOG(misswt2=TRUE)

saveRDS(superoutcomesCOG, "superoutcomesCOG.RDS")

supertabfig1 <- tabfig1(system58=system16, system70=system16)

saveRDS(supertabfig1, "supertabfig1.RDS")

superfigure1a <- fig1a("system16") 
saveRDS(superfigure1a, "superfigure1a.RDS")

#imputed outcomes

prepfiles2()

prepfiles3()

superoutcomesIMPOUT <- getoutcomes(misswt2=FALSE, system58=system16, system70=system16)

saveRDS(superoutcomesIMPOUT, "superoutcomesIMPOUT.RDS")

#no imputed exposures

prepfiles(model="supermodel", system58=system16, system70=system16, impexp=FALSE)

superoutcomesNOIMPEX <- getoutcomes(misswt2=TRUE, system58=system16, system70=system16)

saveRDS(superoutcomesNOIMPEX, "superoutcomesNOIMPEX.RDS")

#system 11


prepfiles11(model="supermodel", system58=system11, system70=system16, impexp=TRUE)

superoutcomesSYS11 <- getoutcomes(misswt2=TRUE, system58 = system11, system70= system16)   

saveRDS(superoutcomesSYS11, "superoutcomesSYS11.RDS")
```




```{r ebal, eval=FALSE}

prepfiles(model="ebalmodel", system58=system16, system70=system16, impexp=TRUE)

ebaloutcomes <- getoutcomes(misswt2=TRUE, system58=system16, system70=system16)

saveRDS(ebaloutcomes, "ebaloutcomes.RDS")

ebaloutcomesED <- getoutcomesED(misswt2=TRUE)

saveRDS(ebaloutcomesED, "ebaloutcomesED.RDS")

ebaloutcomesBMI <- getoutcomesBMI(misswt2=TRUE)

saveRDS(ebaloutcomesBMI, "ebaloutcomesBMI.RDS")

ebaloutcomesCOG <- getoutcomesCOG(misswt2=TRUE)

saveRDS(ebaloutcomesCOG, "ebaloutcomesCOG.RDS")

ebaltabfig1 <- tabfig1(system58=system16, system70=system16)

saveRDS(ebaltabfig1, "ebaltabfig1.RDS")

ebalfigure1a <- fig1a("system16") 
saveRDS(ebalfigure1a, "ebalfigure1a.RDS")

#imputed outcomes

prepfiles2()

prepfiles3()

ebaloutcomesIMPOUT <- getoutcomes(misswt2=FALSE, system58=system16, system70=system16)

saveRDS(ebaloutcomesIMPOUT, "ebaloutcomesIMPOUT.RDS")

#no imputed exposures

prepfiles(model="ebalmodel", system58=system16, system70=system16, impexp=FALSE)

ebaloutcomesNOIMPEX <- getoutcomes(misswt2=TRUE, system58=system16, system70=system16)

saveRDS(ebaloutcomesNOIMPEX, "ebaloutcomesNOIMPEX.RDS")

#system 11

prepfiles11(model="ebalmodel", system58=system11, system70=system16, impexp=TRUE)

ebaloutcomesSYS11 <- getoutcomes(misswt2=TRUE, system58 = system11, system70= system16)   

saveRDS(ebaloutcomesSYS11, "ebaloutcomesSYS11.RDS")

```

```{r gbm, eval=FALSE}

prepfiles(model="gbmmodel", system58=system16, system70=system16, impexp=TRUE)

gbmoutcomes <- getoutcomes(misswt2=TRUE, system58=system16, system70=system16)

saveRDS(gbmoutcomes, "gbmoutcomes.RDS")

gbmoutcomesED <- getoutcomesED(misswt2=TRUE)

saveRDS(gbmoutcomesED, "gbmoutcomesED.RDS")

gbmoutcomesBMI <- getoutcomesBMI(misswt2=TRUE)

saveRDS(gbmoutcomesBMI, "gbmoutcomesBMI.RDS")

gbmoutcomesCOG <- getoutcomesCOG(misswt2=TRUE)

saveRDS(gbmoutcomesCOG, "gbmoutcomesCOG.RDS")

gbmtabfig1 <- tabfig1(system58=system16, system70=system16)

saveRDS(gbmtabfig1, "gbmtabfig1.RDS")

gbmfigure1a <- fig1a("system16") 
saveRDS(gbmfigure1a, "gbmfigure1a.RDS")

#imputed outcomes

prepfiles2()

prepfiles3()

gbmoutcomesIMPOUT <- getoutcomes(misswt2=FALSE, system58=system16, system70=system16)

saveRDS(gbmoutcomesIMPOUT, "gbmoutcomesIMPOUT.RDS")

#no imputed exposures

prepfiles(model="gbmmodel", system58=system16, system70=system16, impexp=FALSE)

gbmoutcomesNOIMPEX <- getoutcomes(misswt2=TRUE, system58=system16, system70=system16)

saveRDS(gbmoutcomesNOIMPEX, "gbmoutcomesNOIMPEX.RDS")

#system 11

prepfiles11(model="gbmmodel", system58=system11, system70=system16, impexp=TRUE)

gbmoutcomesSYS11 <- getoutcomes(misswt2=TRUE, system58 = system11, system70= system16)   

saveRDS(gbmoutcomesSYS11, "gbmoutcomesSYS11.RDS")

rm(list = setdiff(setdiff(ls(), lsf.str()), "theme_dotplot"))
gc()

```


```{r table and figs, eval=FALSE}


supertabfig1 <- readRDS("supertabfig1.RDS")

superfig1 <- onefigure(supertabfig1$figure1_1958, supertabfig1$figure1_1970)

supertable1 <- onetable(supertabfig1$table1_1958, supertabfig1$table1_1970)

superoutcomes <- readRDS("superoutcomes.RDS")

superfig2 <- plotoutavg(filter(superoutcomes$go_class11_1958, !is.na(system2)),
              filter(superoutcomes$go_class10_1970, !is.na(system2)))

superfig3a <- plotoutconcen(filter(superoutcomes$go_class11_1958, !is.na(System)),
              filter(superoutcomes$go_class10_1970, !is.na(System)))

superfig3b <- plotoutconcen(filter(superoutcomes$go_class42_1958, !is.na(System)),
              filter(superoutcomes$go_class42_1970, !is.na(System)))

superoutcomesED <- readRDS("superoutcomesED.RDS")

superfig4a <- plotoutconcenED(filter(superoutcomesED$go_leftedage_58, !is.na(System)),
              filter(superoutcomesED$go_leftedage_70, !is.na(System)))
superfig4b <- plotoutconcenED(filter(superoutcomesED$go_high38_58, !is.na(System)),
              filter(superoutcomesED$go_high38_70, !is.na(System)))
              


superoutcomesBMI <- readRDS("superoutcomesBMI.RDS")

superfig5a <- plotoutconcen(filter(superoutcomesBMI$go_class11_1958, !is.na(System)),
              filter(superoutcomesBMI$go_class10_1970, !is.na(System)))


superfig5b <- plotoutconcen(filter(superoutcomesBMI$go_class42_1958, !is.na(System)),
              filter(superoutcomesBMI$go_class42_1970, !is.na(System)))


superoutcomesCOG <- readRDS("superoutcomesCOG.RDS")

superfig6a <- plotcog(superoutcomesCOG$cog11_1958, 1958)
superfig6b <- plotcog(superoutcomesCOG$cog10_1970, 1970)


saveRDS(superfig1, "superfig1.RDS")
saveRDS(supertable1, "supertable1.RDS")
saveRDS(superfig2, "superfig2.RDS")
saveRDS(superfig3a, "superfig3a.RDS")
saveRDS(superfig3b, "superfig3b.RDS")
saveRDS(superfig4a, "superfig4a.RDS")
saveRDS(superfig4b, "superfig4b.RDS")
saveRDS(superfig5a, "superfig5a.RDS")
saveRDS(superfig5b, "superfig5b.RDS")
saveRDS(superfig6a, "superfig6a.RDS")
saveRDS(superfig6b, "superfig6b.RDS")

# ebal ####
ebaltabfig1 <- readRDS("ebaltabfig1.RDS")

ebalfig1 <- onefigure(ebaltabfig1$figure1_1958, ebaltabfig1$figure1_1970)

ebaltable1 <- onetable(ebaltabfig1$table1_1958, ebaltabfig1$table1_1970)

ebaloutcomes <- readRDS("ebaloutcomes.RDS")

ebalfig2 <- plotoutavg(filter(ebaloutcomes$go_class11_1958, !is.na(system2)),
                        filter(ebaloutcomes$go_class10_1970, !is.na(system2)))

ebalfig3a <- plotoutconcen(filter(ebaloutcomes$go_class11_1958, !is.na(System)),
                            filter(ebaloutcomes$go_class10_1970, !is.na(System)))

ebalfig3b <- plotoutconcen(filter(ebaloutcomes$go_class42_1958, !is.na(System)),
                            filter(ebaloutcomes$go_class42_1970, !is.na(System)))

ebaloutcomesED <- readRDS("ebaloutcomesED.RDS")

ebalfig4a <- plotoutconcenED(filter(ebaloutcomesED$go_leftedage_58, !is.na(System)),
                              filter(ebaloutcomesED$go_leftedage_70, !is.na(System)))
ebalfig4b <- plotoutconcenED(filter(ebaloutcomesED$go_high38_58, !is.na(System)),
                              filter(ebaloutcomesED$go_high38_70, !is.na(System)))



ebaloutcomesBMI <- readRDS("ebaloutcomesBMI.RDS")

ebalfig5a <- plotoutconcen(filter(ebaloutcomesBMI$go_class11_1958, !is.na(System)),
                            filter(ebaloutcomesBMI$go_class10_1970, !is.na(System)))


ebalfig5b <- plotoutconcen(filter(ebaloutcomesBMI$go_class42_1958, !is.na(System)),
                            filter(ebaloutcomesBMI$go_class42_1970, !is.na(System)))


ebaloutcomesCOG <- readRDS("ebaloutcomesCOG.RDS")

ebalfig6a <- plotcog(ebaloutcomesCOG$cog11_1958, 1958)
ebalfig6b <- plotcog(ebaloutcomesCOG$cog10_1970, 1970)


saveRDS(ebalfig1, "ebalfig1.RDS")
saveRDS(ebaltable1, "ebaltable1.RDS")
saveRDS(ebalfig2, "ebalfig2.RDS")
saveRDS(ebalfig3a, "ebalfig3a.RDS")
saveRDS(ebalfig3b, "ebalfig3b.RDS")
saveRDS(ebalfig4a, "ebalfig4a.RDS")
saveRDS(ebalfig4b, "ebalfig4b.RDS")
saveRDS(ebalfig5a, "ebalfig5a.RDS")
saveRDS(ebalfig5b, "ebalfig5b.RDS")
saveRDS(ebalfig6a, "ebalfig6a.RDS")
saveRDS(ebalfig6b, "ebalfig6b.RDS")


# gbm ####

gbmtabfig1 <- readRDS("gbmtabfig1.RDS")

gbmfig1 <- onefigure(gbmtabfig1$figure1_1958, gbmtabfig1$figure1_1970)

gbmtable1 <- onetable(gbmtabfig1$table1_1958, gbmtabfig1$table1_1970)

gbmoutcomes <- readRDS("gbmoutcomes.RDS")

gbmfig2 <- plotoutavg(filter(gbmoutcomes$go_class11_1958, !is.na(system2)),
                        filter(gbmoutcomes$go_class10_1970, !is.na(system2)))

gbmfig3a <- plotoutconcen(filter(gbmoutcomes$go_class11_1958, !is.na(System)),
                            filter(gbmoutcomes$go_class10_1970, !is.na(System)))

gbmfig3b <- plotoutconcen(filter(gbmoutcomes$go_class42_1958, !is.na(System)),
                            filter(gbmoutcomes$go_class42_1970, !is.na(System)))

gbmoutcomesED <- readRDS("gbmoutcomesED.RDS")

gbmfig4a <- plotoutconcenED(filter(gbmoutcomesED$go_leftedage_58, !is.na(System)),
                              filter(gbmoutcomesED$go_leftedage_70, !is.na(System)))
gbmfig4b <- plotoutconcenED(filter(gbmoutcomesED$go_high38_58, !is.na(System)),
                              filter(gbmoutcomesED$go_high38_70, !is.na(System)))



gbmoutcomesBMI <- readRDS("gbmoutcomesBMI.RDS")

gbmfig5a <- plotoutconcen(filter(gbmoutcomesBMI$go_class11_1958, !is.na(System)),
                            filter(gbmoutcomesBMI$go_class10_1970, !is.na(System)))


gbmfig5b <- plotoutconcen(filter(gbmoutcomesBMI$go_class42_1958, !is.na(System)),
                            filter(gbmoutcomesBMI$go_class42_1970, !is.na(System)))


gbmoutcomesCOG <- readRDS("gbmoutcomesCOG.RDS")

gbmfig6a <- plotcog(gbmoutcomesCOG$cog11_1958, 1958)
gbmfig6b <- plotcog(gbmoutcomesCOG$cog10_1970, 1970)


saveRDS(gbmfig1, "gbmfig1.RDS")
saveRDS(gbmtable1, "gbmtable1.RDS")
saveRDS(gbmfig2, "gbmfig2.RDS")
saveRDS(gbmfig3a, "gbmfig3a.RDS")
saveRDS(gbmfig3b, "gbmfig3b.RDS")
saveRDS(gbmfig4a, "gbmfig4a.RDS")
saveRDS(gbmfig4b, "gbmfig4b.RDS")
saveRDS(gbmfig5a, "gbmfig5a.RDS")
saveRDS(gbmfig5b, "gbmfig5b.RDS")
saveRDS(gbmfig6a, "gbmfig6a.RDS")
saveRDS(gbmfig6b, "gbmfig6b.RDS")

# imputed outcomes ####

superoutcomesIMPOUT <- readRDS("superoutcomesIMPOUT.RDS")

superIMPOUTfig2 <- plotoutavg(filter(superoutcomesIMPOUT$go_class11_1958, !is.na(system2)),
                       filter(superoutcomesIMPOUT$go_class10_1970, !is.na(system2)))

superIMPOUTfig3a <- plotoutconcen(filter(superoutcomesIMPOUT$go_class11_1958, !is.na(System)),
                          filter(superoutcomesIMPOUT$go_class10_1970, !is.na(System)))

saveRDS(superIMPOUTfig2, "superIMPOUTfig2.RDS")
saveRDS(superIMPOUTfig3a, "superIMPOUTfig3a.RDS")

# sys11 ####

superoutcomesSYS11 <- readRDS("superoutcomesSYS11.RDS")

superSYS11fig2 <- plotoutavg(filter(superoutcomesSYS11$go_class11_1958, !is.na(system2)),
                              filter(superoutcomesSYS11$go_class10_1970, !is.na(system2)))

superSYS11fig3a <- plotoutconcen(filter(superoutcomesSYS11$go_class11_1958, !is.na(System)),
                                 filter(superoutcomesSYS11$go_class10_1970, !is.na(System)))

saveRDS(superSYS11fig2, "superSYS11fig2.RDS")
saveRDS(superSYS11fig3a, "superSYS11fig3a.RDS")

### NOIMPEX 

superoutcomesNOIMPEX  <- readRDS("superoutcomesNOIMPEX.RDS")

superNOIMPEXfig2 <- plotoutavg(filter(superoutcomesNOIMPEX$go_class11_1958, !is.na(system2)),
                              filter(superoutcomesNOIMPEX$go_class10_1970, !is.na(system2)))

superNOIMPEXfig3a <- plotoutconcen(filter(superoutcomesNOIMPEX$go_class11_1958, !is.na(System)),
                                 filter(superoutcomesNOIMPEX$go_class10_1970, !is.na(System)))

saveRDS(superNOIMPEXfig2, "superNOIMPEXfig2.RDS")
saveRDS(superNOIMPEXfig3a, "superNOIMPEXfig3a.RDS")

rm(list = setdiff(setdiff(ls(), lsf.str()), "theme_dotplot"))
gc()


```





<!--chapter:end:results.Rmd-->

# Results {#Results .unnumbered}

### Baseline {#Baseline .unnumbered}

Table \@ref(tab:Table1) shows confounder balance before and after adjustment using the inverse probability weights. Just over half of the 1958 cohort were in comprehensive schools at age 16 compared to 83% in the 1970 cohort. Before adjustment on average those attending selective system schools were from more advantaged backgrounds and scored higher on the cognitive ability tests. As illustrated in Figure \@ref(fig:Figure1), good balance was achieved across the confounders in both cohorts after adjustment. In supplement 2 we illustrate good balance after adjustment in the distribution of cognitive ability (the continuous confounder). In addition Table \@ref(tab:Table1) shows that the adjusted counterfactual populations - imagining everyone went to school under a comprehensive system or a selective system - in both cohorts closely match the overall population in terms of size and variable distribution.

```{r Table1, eval=TRUE, echo=FALSE, include=TRUE, tab.cap="Confounder balance before and after weighting"}

table1 <- readRDS("supertable1.RDS")
knit_print(table1)



```

```{r Figure1, include=TRUE, echo=FALSE, fig.cap="Confounder balance before and after weighting"}

readRDS("superfig1.RDS") %>%
  ggsave("Figure1.png", plot=., width=18, height=15, units="cm")
include_graphics("Figure1.png")
```

### Outcomes {#Outcomes .unnumbered}

There are clear differences across the cohorts in the mean of some outcomes - rises in age leaving full time education, increases in qualification levels, increases in BMI and future life satisfaction, and reductions in smoking - as might be expected. For example there were fewer smokers at age 42 in 1970 from both the comprehensive system (27.3% (95% CI 26% - 28.6%) and the selective system (25.7% (23.7% - 27.6%)) compared to 1958 (31.2% (30% - 32.5%) and 30.9% (29.4% - 32.3%) respectively) as shown in Figure \@ref(fig:Figure2) that illustrates the means of outcomes under each system after confounder adjustment. Although general health seems to have reduced in the 1970 cohort, this is perhaps the least comparable variable due to differences in response scale in the original questions.

```{r Figure2, include=TRUE, echo=FALSE, fig.cap="Mean outcomes by school system and cohort"}
readRDS("superfig2.RDS") %>%
  ggsave("Figure2.png", plot=., width=18, height=25, units="cm")
include_graphics("Figure2.png")
```

Comparing within cohorts Figure \@ref(fig:Figure2) shows that in general there was not a clear difference between school systems for our health and wellbeing outcomes. For example, while the rate of smoking was slightly lower in both cohorts under the selective system compared to the comprehensive system (-0.4% (-2.4% - 1.6%) in 1958 and -1.7% (-4.1% - 0.7%) in 1970, the confidence intervals for the differences were wide. There were clear differences in the two education outcomes under each system. For example, average age at leaving full-time education was higher in the selective system in both cohorts. In 1958 the average age of leaving full-time education under the comprehensive system was 16.8 (16.8 - 16.9) while under the selective system it was 17.1 (17 - 17.1), a difference of 0.23 (0.16 - 0.30) years, just under 3 months. In 1970 the average age of leaving full-time education under the comprehensive system was 17.4 (17.3 - 17.4) while under the selective system it was 17.8 (17.7 - 17.9), a difference of 0.4 (0.27 - 0.52) years, just under 5 months.

```{r Figure3, include=TRUE, echo=FALSE, fig.cap="Origin class inequalities in outcomes by school system and cohort"}
readRDS("superfig3a.RDS") %>%
  ggsave("Figure3.png", plot=., width=18, height=25, units="cm")
include_graphics("Figure3.png")
```

A similar picture is observed for inequality in outcomes as that for mean outcomes. Figure \@ref(fig:Figure3) shows inequality in the comprehensive system in each outcome by our three measures - i.e. absolute inequality, and shortfall and attainment relative inequality. Additionally it shows the difference in inequality under the selective system compared to the comprehensive system. It reports inequality by class of origin (results are similar for class of destination see supplement 3). Overall inequality is not clearly different in the selective system compared to comprehensive system for our health and wellbeing outcomes. For example, the result for mental wellbeing shows inequalities by social origin in the comprehensive school, meaning that people from more disadvantaged social origins tend to have poorer mental wellbeing than people from more advantaged social classes. The results are invariant to whether we consider positive mental wellbeing (relative attainment) or negative mental wellbeing (relative shortfall). Absolute results are presented as attainment only as by definition they are invariant (apart from the sign switching to negative for shortfall). However, this pattern is not greatly different under the selective system. Similar results for general health, BMI, current smoking and present life satisfaction. Inequalities in future llife satisfaction are less apparent. For both the education outcomes of age of leaving full-time education and highest education there are clear inequalities - earlier age of leaving and lower qualifications in the more disadvantaged - and the inequalities are generally greater in the selective system. The only exception is the relative attainment measure for both highest qualification and age leaving full-time education in the 1970 cohort where the selective system's difference to the comprehensive system is less clear as the confidence intervals cross zero.

```{r Figure4, include=TRUE, echo=FALSE, fig.cap="Education inequalities (age left education) in outcomes and social class of destination by school system and cohort"}
readRDS("superfig4a.RDS") %>%
  ggsave("Figure4.png", plot=., width=18, height=25, units="cm")
include_graphics("Figure4.png")
```

### Education inequalities in health outcomes {#Education-inequalities-in-health-outcomes .unnumbered}

So far we have used social class as our measure of stratification. We also explored inequalities with education as the measure of stratification. While we hypothesised that the comprehensive system might influence health inequalities indirectly through occupational social class and associated economic advantage, we also hypothesised that it might have more direct effects on health inequalities , for example through the distribution of health literacy. Thus, if it had a direct effect through education we might capture this better when using education as a measure of stratification. It is also valuable to assess our outcomes using education as the measure of stratification because inequalities in health are often studied using education rather than social class. Specifically we report inequalities in health outcomes by the age left full-time education in Figure \@ref(fig:Figure4) which replaces social class as the stratification variable with age left full-time education. Overall there is little evidence that inequality by education in the health and wellbeing outcomes is different in the selective system compared to the comprehensive, as was the case for social class stratification. The one exception being inequality in BMI that seemed to be greater in the 1958 cohort. Figure \@ref(fig:Figure4) additionally shows education inequality with social class of destination as an outcome. Here there is consistent evidence that social class advantage (attainment inequality) and social class disadvantage (shortfall inequality) are more concentrated by age left education in the selective as opposed to the comprehensive system. Results are similar using highest qualification achieved (see supplement 3).

#### Exploratory analysis {#Exploratory-analysis .unnumbered}

We undertook exploratory analysis to assess why the mean and inequality might be greater in the selective system for education but not health outcomes. The main feature of the selective system is that entry to either a vocational or academic focused secondary school is based on a cognitive ability test taken at the end of primary school. While not the actual test we do have similar cognitive ability tests in our data so it is informative to compare outcomes by childhood cognitive ability and school system. The results for the 1958 cohort can be seen in Figure \@ref(fig:Figure5) We binned cognitive ability into five point bins (except at the margins where cases were most sparse) and calculated the IPW adjusted mean of the outcome for each bin by school system. Apart from perhaps the life satisfaction outcomes the general trend in Figure \@ref(fig:Figure5) is that increasing cognitive ability is associated (no causal claim being made) with better outcomes as previous research suggests. However, only for the education outcomes do we see a difference emerge by system and cognitive ability. Although we do not know the entry score needed to enter an academic focused secondary school previous research on the 1958 cohort showed that the selective system saw increases in the probability of attending an academic focused school (Grammar schools) from around the mid-point of distribution of the cognitive ability test, with the probability rising as test score increases [@pastore2019]. It is around this point that we see in our diagram those in the selective system diverging from the comprehensive system in terms of age leaving education and highest qualification achieved. This suggests that schooling for those with higher cognitive ability scores is driving these education outcome differences between the systems. The results for the 1970 cohort are similar (see supplement 3).

```{r Figure5, include=TRUE, echo=FALSE, fig.cap="Mean of outcomes by cognitive ability and  school system 1958 cohort"}
readRDS("superfig6a.RDS") %>%
  ggsave("Figure5.png", plot=., width=18, height=25, units="cm")
include_graphics("Figure5.png")
```

### Sensitivity analysis {#Sensitivity-analysis .unnumbered}

Supplement 3 presents the results for the BMI at baseline as a negative control. It shows little evidence of any inequality by social class providing additional assurance that residual confounding may not be a large bias as BMI at baseline was not included in the confounder model.

Supplement 4 shows the class results in Figures 2 and 3 but using imputed outcomes. Both show little change to the main analysis.

In Supplement 5 we rerun the analysis with the inverse probability weights for adjusting confounding generated from a entropy balancing model that will achieve exact mean balance although it, as in this case, may do so with some observations having negative probabilities thus violating the positivity assumption that every observation should have a positive probability of receiving either of the "treatments". In any case the results are not that changed, this is also the case in Supplement 6 where we use a generalised boosted model for inverse probability weight generation.

Supplement 7 shows that the pattern of results is not that changed when we exclude observations where the exposure was imputed.

Supplement 8 shows the results by school type at age 11 for the 1958 cohort rather than their school type at age 16. Results are similar, perhaps the largest change being that inequality in age left education is not so clearly higher in the selective system.

<!--chapter:end:03-results.Rmd-->

# Discussion {#Discussion .unnumbered}

### Main results {#Main-results .unnumbered}

In a observational study of two British birth cohorts followed to middle age we found little evidence that health and wellbeing outcomes were different in the comprehensive compared to the selective school system both in terms of average outcomes and inequality in outcomes. This was despite there being differences in our education outcomes (on average slightly higher in the selective system) and inequality (lower in the comprehensive system) between the systems. We had originally hypothesized these differences in education outcomes could lead to health differences between systems in at least three ways. Firstly, through the direst effect of improvements in education on health literacy. As shown in Figure \@ref(fig:Figure2) average education outcomes were slightly better in the selective system. Hence the idea that comprehensive system brought about changes in health literacy through improved average education is not well supported. Previous studies of education outcomes have tended to find that in the selective system average education outcomes are better for those attending academically focussed schools compared to similar students in comprehensive schools but that comprehensive schools perform better for pupils who would have gone to vocationally focused schools in the selective system, so at the population level there is a small or no overall effect [@atkinson2006]. Our exploratory analysis assessing the interaction between cognitive ability test score and system suggested, tentatively, that system differences in education emerged because of higher outcomes in those with higher ability scores in the selective system, who were most likely to attend an academic focused school (Figure \@ref(fig:Figure5)). Inequalities in education outcomes were reduced under the comprehensive system we found (see Figure \@ref(fig:Figure3)) but these seemed not to translate into reduced health inequalities. Similarly, recent UK work comparing outcomes in the selective system only for those who could have gone to an academic school based on having a cognitive ability score near the cut off but some of whom did not obtain a place found evidence of effects on education by school type but no effects on health [@clark2013; @pastore2019; @clark2013; @Butler2020]. When we replaced social class with education as our stratification measure while there was evidence of BMI inequalities being lower in one cohort, across the other health outcomes little difference between the school systems was observed suggesting that the results for social class stratification broadly held when using a direct measure of education.

Our second possible mechanism through which the comprehensive system might have reduced health inequalities was by reducing inequalities in other social determinants of health. While we found in Figure \@ref(fig:Figure4) destination social class inequalities by education were higher in the selective system this appeared not to translate into an effect on health inequalities. The inequalities in destination social class by education were large even in the comprehensive system, so even though reduced compared to the selective system the reduction may have been too small to impact health inequalities.

Our third mechanism, following the income inequality hypothesis, was the possibility that more equity in education and other social determinants of health would bring about greater social cohesion and thus improve population health and reduce health inequalities. While we observed reductions in inequality in education outcomes under the comprehensive system this did not seem to translate into reductions in health inequalities. More directly, previous UK research found that the change to the comprehensive system did not improve indicators of social cohesion [@paterson2012].

Overall the equity impacts of a comprehensive system over a selective school system may be relatively minor. This is likely to be due to between-school and within-school differences which continue to exist in a comprehensive system, even though in a less visible way than in a selective system. There continue to be significant differentiation at the school level in the comprehensive system through geographical and socio-economic variation in catchment areas for example, as well as within-school differentiation of teaching tracking by ability groupings and curriculum.

### Strengths and limitations {#Strengths-and-Limitations .unnumbered}

Our study had a number of strengths including a clear aim of evaluating causal relationships [@hernán2018], pre-outcome registration of the analysis, use of representative data from two rich cohort studies, multiple imputation and weighting, a full range of measures of inequalities in health, a variety of outcomes and extensive sensitivity analysis.

In an observational study when the exposure of interest is not randomised we need to be cognisant of the possibility of residual confounding and selection bias. In terms of residual confounding this is difficult to rule out, we did choose factors prior to secondary school such as region of residence, socio-economic background, parental education and aspirations for their child as well as the cognitive ability test scores that may impact whether they sought a particular school system (for example, seeking an academic school in the selective system). We were able to achieve good balance on these in our main propensity score and the two additional propensity score methods (one of which achieved "perfect" balance by design). We used the negative control of one of the outcomes (BMI) measured at the end of primary school. Despite not being included in the propensity score model it showed good balance as well. We did consider the alternative natural experiment design of a regression discontinuity as this has been used quite extensively to study differences between school types in the selective system using entrance test score (or proxy) as the forcing variable. We could then see if in the comprehensive system inequalities in health changed in the same way or not at the score level where students in the selective system straddled the vocational / academic school border. The disadvantage was this would give a local (for those at the border) average treatment effect rather covering the whole system (an average treatment effect). In order to understand our results we did essentially conduct the first stage of a regression discontinuity (Figure 5) [@cattaneo2019] , these results suggest that using this alternative design may have come to similar conclusions.

Selection biases relates to how people are selected into the sample [@Hernan]. These include: volunteer bias - our samples were all births in one week with a high response rate; missing data bias- we used multiple imputation to mitigate this; and loss to follow-up - we used IPW to mitigate this as well as sensitivity analysis on multiple imputed outcomes.

Measurement error could also bias our results. In the 1958 cohort some schools were transitioning to the comprehensive system and so we conducted sensitivity analysis of the results to changing when we assessed school type (at age 11 or 16). We also compared results in 1958 to 1970 when the comprehensive system was more established.

#### Conclusion {#Conclusion .unnumbered}

in summary we found no consistent impact of the introduction of a comprehensive school system in Britain on adult health and health inequalities despite, in theory at least, the comprehensive system being more equitable.

<!--chapter:end:04-discussion.Rmd-->

# References {#References .unnumbered}

::: {#refs}
:::

<!--chapter:end:05-references.Rmd-->

# Supplement 1 {#Supplement .unnumbered}

Firstly, we used multiple imputation (MI) to impute missing data on exposure and confounders. Secondly, we used inverse probability weights to account for the following post intervention: missing outcome data, death and emigration. We derived the IPW from models of the propensity of having missing data on the outcome or not as a function of the exposure and confounders. These weights are then multiplied by those for confounding. Our multiple imputation used chained equations (van Buuren and Groothuis-Oudshoorn, 2011) with the imputation model featuring the outcomes, exposure, confounders, and additional auxiliary variables (see Table S1_1) that are predictive of both missingness and the main variable (in our case the exposure) being imputed (Leyrat et al. 2017; Silverwood et al. 2020). We checked the convergence of the model using 10 iterations. We used the rule of thumb that the number of imputations should be at least the percentage of missingness (68 and 72 imputations for 1958 and 1970 cohort respectively) (White et al. 2011). As outlined in Tables S1_2 and S1_3 in missingness was less for each individual variable and overall the imputations did not greatly change variable distribution. We conducted separate imputations for each cohort. In line with recommendations all analysis was conducted on each imputation, with the results for the outcome models combined using Rubin's rules (Leyrat et al. 2017).

Leyrat, C., Seaman, S.R., White, I.R., Douglas, I., Smeeth, L., Kim, J., Resche-Rigon, M., Carpenter, J.R., Williamson, E.J., 2017. Propensity score analysis with partially observed covariates: How should multiple imputation be used? Statistical Methods in Medical Research 28, 3–19. https://doi.org/10.1177/0962280217713032

Silverwood, R., Narayanan, M., Dodgeon, B., Ploubidis, G., 2020. Handling missing data in the National Child Development Study: User guide. UCL Centre for Longitudinal Studies, London, UK.

White, I.R., Royston, P., Wood, A.M., 2011. Multiple imputation using chained equations: Issues and guidance for practice. Statistics in Medicine 30, 377–399.

van Buuren, S.,  Groothuis-Oudshoorn, K. (2011). mice: Multivariate Imputation by Chained Equations in R. Journal of Statistical Software, 45(3), 1-67. URL https://www.jstatsoft.org/v45/i03/.

*Table S1\_1 Auxiliary variables used in the multiple imputation*

+--------------------------------------------------------+-------------------------------------------------------+
| 1958                                                   | 1970                                                  |
+:=======================================================+:======================================================+
| Four cognitive ability scales at age 7 [@shepherd2012] | Four cognitive ability scales at age 5 [@parsons2014] |
|                                                        |                                                       |
| -   Southgate Group Reading Test                       | -   English Picture Vocabulary Test                   |
|                                                        |                                                       |
| -   Copying designs                                    | -   Schonell Reading Test                             |
|                                                        |                                                       |
| -   Drawing a man test                                 | -   Copying designs                                   |
|                                                        |                                                       |
| -   Problem arithmetic test                            | -   Human Figure Drawing Test                         |
|                                                        |                                                       |
| Region of residence at birth and age 7                 | Region of residence at birth and age 5                |
|                                                        |                                                       |
| Social class of parent at birth and age 7              | Social class of parent at birth and age 5             |
+--------------------------------------------------------+-------------------------------------------------------+

```{r s1_2, eval=TRUE, include=TRUE, echo=FALSE, tab.cap="Distribution of confounders and exposure before and after imputation 1958 cohort"}

s1_2 <- readRDS("misstable1958.RDS") 
knit_print(s1_2)
```

```{r s1_3, include=TRUE, echo=FALSE, tab.cap="Distribution of confounders and exposure before and after imputation 1970 cohort"}

s1_3 <- readRDS("misstable1970.RDS") 
knit_print(s1_3)
```

<!--chapter:end:supplement1.Rmd-->

# Supplement 2 {#Supplement-2 .unnumbered}

### Distribution of cognitive ability test {#Distribution-of-cognitive-ability-test .unnumbered}

```{r S2_1, include=TRUE, echo=FALSE, fig.cap="Cognitive ability balance before and after weighting"}

readRDS("superfigure1a.RDS") %>%
  ggsave("Figure_s2_1.png", plot=., width=18, height=15, units="cm")
include_graphics("Figure_s2_1.png")

```

<!--chapter:end:supplement2.Rmd-->

# Supplement 3 {#Supplement-3 .unnumbered}

```{r S3_1, include=TRUE, echo=FALSE, fig.cap="Destination class inequalities in outcomes by school system and cohort"}
readRDS("superfig3b.RDS") %>%
  ggsave("FigureS3_1.png", plot=., width=18, height=25, units="cm")
include_graphics("FigureS3_1.png")

```

```{r S3_2, include=TRUE, echo=FALSE, fig.cap="Negative control using BMI measured at age 10 or 11 (inequality by class of origin)"}
temp <- readRDS("superfig5a.RDS")
temp <- temp +
  coord_cartesian(xlim=c(-0.2, 0.4))  ### this sets comp at same scale as Figure3
ggsave("FigureS3_2.png", plot=temp, width=18, height=25, units="cm")
include_graphics("FigureS3_2.png")

```

```{r S3_3, include=TRUE, echo=FALSE, fig.cap="Negative control using BMI measured at age 10 or 11 (inequality by class of destination)"}
temp <- readRDS("superfig5b.RDS")
temp <- temp +
  coord_cartesian(xlim=c(-0.2, 0.4))  ### this sets comp at same scale as Figure3
ggsave("FigureS3_3.png", plot=temp, width=18, height=25, units="cm")
include_graphics("FigureS3_3.png")

```

```{r s3_4, include=TRUE, echo=FALSE, fig.cap="Education inequalities (highest qualification) in outcomes and social class by school system and cohort"}
readRDS("superfig4b.RDS") %>%
  ggsave("Figures3_4.png", plot=., width=18, height=25, units="cm")
include_graphics("Figures3_4.png")
```

<!--chapter:end:supplement3.Rmd-->

# Supplement 4 Analysis repeated using imputed outcomes {#Supplement-4-Analysis-repeated-using-imputed-outcomes .unnumbered}

```{r s4_1, include=TRUE, echo=FALSE, fig.cap="Mean outcomes by school system and cohort"}
readRDS("superIMPOUTfig2.RDS") %>%
  ggsave("Figure4_1.png", plot=., width=18, height=25, units="cm")
include_graphics("Figure4_1.png")
```

```{r s4_2, include=TRUE, echo=FALSE, fig.cap="Origin class inequalities in outcomes by school system and cohort"}
readRDS("superIMPOUTfig3a.RDS") %>%
  ggsave("Figures4_2.png", plot=., width=18, height=25, units="cm")
include_graphics("Figures4_2.png")
```

<!--chapter:end:supplement4.Rmd-->

# Supplement 5 Analysis repeated using entropy balancing {#Supplement-5-Analysis-repeated-using-entropy-balancing .unnumbered}

```{r Tables5_1, eval=TRUE, echo=FALSE, include=TRUE, tab.cap="Confounder balance before and after weighting"}

tables5_1 <- readRDS("ebaltable1.RDS")
knit_print(tables5_1)

```

```{r Figures5_1, include=TRUE, echo=FALSE, fig.cap="Confounder balance before and after weighting"}

readRDS("ebalfig1.RDS") %>%
  ggsave("Figures5_1.png", plot=., width=18, height=15, units="cm")
include_graphics("Figures5_1.png")
```

```{r Figures5_2, include=TRUE, echo=FALSE, fig.cap="Mean outcomes by school system and cohort"}
readRDS("ebalfig2.RDS") %>%
  ggsave("Figure5_2.png", plot=., width=18, height=25, units="cm")
include_graphics("Figure5_2.png")
```

```{r Figures5_3, include=TRUE, echo=FALSE, fig.cap="Origin class inequalities in outcomes by school system and cohort"}
readRDS("ebalfig3a.RDS") %>%
  ggsave("Figure5_3.png", plot=., width=18, height=25, units="cm")
include_graphics("Figure5_3.png")
```

```{r Figures5_4, include=TRUE, echo=FALSE, fig.cap="Education inequalities (age left education) in outcomes and social class by school system and cohort"}
readRDS("ebalfig4a.RDS") %>%
  ggsave("Figure5_4.png", plot=., width=18, height=25, units="cm")
include_graphics("Figure5_4.png")
```

```{r Figure5_5, include=TRUE, echo=FALSE, fig.cap="Mean of outcomes by cognitive ability and  school system 1958 cohort"}
readRDS("ebalfig6a.RDS") %>%
  ggsave("Figure5_5.png", plot=., width=18, height=25, units="cm")
include_graphics("Figure5_5.png")
```

<!--chapter:end:supplement5.Rmd-->

# Supplement 6 Analysis repeated using gbm {#Supplement-6-Analysis-repeated-using-gbm .unnumbered}

```{r Tables6_1, eval=TRUE, echo=FALSE, include=TRUE, tab.cap="Confounder balance before and after weighting"}

tables6_1 <- readRDS("gbmtable1.RDS")
knit_print(tables6_1)

```

```{r Figures6_1, include=TRUE, echo=FALSE, fig.cap="Confounder balance before and after weighting"}

readRDS("gbmfig1.RDS") %>%
  ggsave("Figures6_1.png", plot=., width=18, height=15, units="cm")
include_graphics("Figures6_1.png")
```

```{r Figures6_2, include=TRUE, echo=FALSE, fig.cap="Mean outcomes by school system and cohort"}
readRDS("gbmfig2.RDS") %>%
  ggsave("Figure6_2.png", plot=., width=18, height=25, units="cm")
include_graphics("Figure6_2.png")
```

```{r Figures6_3, include=TRUE, echo=FALSE, fig.cap="Origin class inequalities in outcomes by school system and cohort"}
readRDS("gbmfig3a.RDS") %>%
  ggsave("Figure6_3.png", plot=., width=18, height=25, units="cm")
include_graphics("Figure6_3.png")
```

```{r Figures6_4, include=TRUE, echo=FALSE, fig.cap="Education inequalities (age left education) in outcomes and social class by school system and cohort"}
readRDS("gbmfig4a.RDS") %>%
  ggsave("Figure6_4.png", plot=., width=18, height=25, units="cm")
include_graphics("Figure6_4.png")
```

```{r Figure6_5, include=TRUE, echo=FALSE, fig.cap="Mean of outcomes by cognitive ability and  school system 1958 cohort"}
readRDS("gbmfig6a.RDS") %>%
  ggsave("Figure6_5.png", plot=., width=18, height=25, units="cm")
include_graphics("Figure6_5.png")
```

<!--chapter:end:supplement6.Rmd-->

# Supplement 7 Analysis repeated with no imputed exposures {#Supplement-7-Analysis-repeated-with-no-imputed-exposures .unnumbered}

```{r s7_1, include=TRUE, echo=FALSE, fig.cap="Mean outcomes by school system and cohort"}
readRDS("superNOIMPEXfig2.RDS") %>%
  ggsave("Figure7_1.png", plot=., width=18, height=25, units="cm")
include_graphics("Figure7_1.png")
```

```{r s7_2, include=TRUE, echo=FALSE, fig.cap="Origin class inequalities in outcomes by school system and cohort"}
readRDS("superNOIMPEXfig3a.RDS") %>%
  ggsave("Figures7_2.png", plot=., width=18, height=25, units="cm")
include_graphics("Figures7_2.png")
```

<!--chapter:end:supplement7.Rmd-->

# Supplement 8 Analysis repeated with 1958 school type being at 11 rather than 16 {#Analysis-repeated-with-1958-school-type-being-at-11-rather-than-16 .unnumbered}

```{r s8_1, include=TRUE, echo=FALSE, fig.cap="Mean outcomes by school system and cohort"}
readRDS("superSYS11fig2.RDS") %>%
  ggsave("Figure8_1.png", plot=., width=18, height=25, units="cm")
include_graphics("Figure8_1.png")
```

```{r s8_2, include=TRUE, echo=FALSE, fig.cap="Origin class inequalities in outcomes by school system and cohort"}
readRDS("superSYS11fig3a.RDS") %>%
  ggsave("Figures8_2.png", plot=., width=18, height=25, units="cm")
include_graphics("Figures8_2.png")
```

<!--chapter:end:supplement8.Rmd-->

# Supplement 9 R packages {#Supplement-9-R-packages .unnumbered}



```{r, include=TRUE, echo=FALSE}
print(citation("tidyverse"), style="textVersion")
print(citation("bookdown"), style="textVersion")
print(citation("knitr"), style="textVersion")
print(citation("rmarkdown"), style="textVersion")
print(citation("broom"), style="textVersion")
print(citation("mice"), style="textVersion")
print(citation("flextable"), style="textVersion")
print(citation("WeightIt"), style="textVersion")
```


<!--chapter:end:supplement9.Rmd-->

